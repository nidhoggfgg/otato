var Za=Object.defineProperty;var Qa=(r,t,e)=>t in r?Za(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var n=(r,t,e)=>(Qa(r,typeof t!="symbol"?t+"":t,e),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=e(s);fetch(s.href,a)}})();const de=class de{constructor(t=0){n(this,"_ptr");n(this,"_size");n(this,"_capacity");t<1?(this._ptr=[],this._capacity=0,this._size=0):(this._ptr=new Array(t),this._capacity=t,this._size=0)}at(t){return this._ptr[t]}set(t,e){this._ptr[t]=e}get(t=0){const e=new Array;for(let i=t;i<this._size;i++)e.push(this._ptr[i]);return e}pushBack(t){this._size>=this._capacity&&this.prepareCapacity(this._capacity==0?de.s_defaultSize:this._capacity*2),this._ptr[this._size++]=t}clear(){this._ptr.length=0,this._size=0}getSize(){return this._size}assign(t,e){this._size<t&&this.prepareCapacity(t);for(let s=0;s<t;s++)this._ptr[s]=e;this._size=t}resize(t,e=null){this.updateSize(t,e,!0)}updateSize(t,e=null,i=!0){if(this._size<t)if(this.prepareCapacity(t),i)for(let a=this._size;a<t;a++)typeof e=="function"?this._ptr[a]=JSON.parse(JSON.stringify(new e)):this._ptr[a]=e;else for(let a=this._size;a<t;a++)this._ptr[a]=e;else{const a=this._size-t;this._ptr.splice(this._size-a,a)}this._size=t}insert(t,e,i){let s=t._index;const a=e._index,o=i._index,l=o-a;this.prepareCapacity(this._size+l);const c=this._size-s;if(c>0)for(let g=0;g<c;g++)this._ptr.splice(s+g,0,null);for(let g=a;g<o;g++,s++)this._ptr[s]=e._vector._ptr[g];this._size=this._size+l}remove(t){return t<0||this._size<=t?!1:(this._ptr.splice(t,1),--this._size,!0)}erase(t){const e=t._index;return e<0||this._size<=e?t:(this._ptr.splice(e,1),--this._size,new ze(this,e))}prepareCapacity(t){t>this._capacity&&(this._capacity==0?(this._ptr=new Array(t),this._capacity=t):(this._ptr.length=t,this._capacity=t))}begin(){return this._size==0?this.end():new ze(this,0)}end(){return new ze(this,this._size)}getOffset(t){const e=new de;return e._ptr=this.get(t),e._size=this.get(t).length,e._capacity=this.get(t).length,e}};n(de,"s_defaultSize",10);let L=de,ze=class Si{constructor(t,e){n(this,"_index");n(this,"_vector");this._vector=t??null,this._index=e??0}set(t){return this._index=t._index,this._vector=t._vector,this}preIncrement(){return++this._index,this}preDecrement(){return--this._index,this}increment(){return new Si(this._vector,this._index++)}decrement(){return new Si(this._vector,this._index--)}ptr(){return this._vector._ptr[this._index]}substitution(t){return this._index=t._index,this._vector=t._vector,this}notEqual(t){return this._index!=t._index||this._vector!=t._vector}};var tr;(function(r){r.csmVector=L,r.iterator=ze})(tr||(tr={}));class St{constructor(t){n(this,"s");this.s=t}append(t,e){return this.s+=e!==void 0?t.substr(0,e):t,this}expansion(t,e){for(let i=0;i<t;i++)this.append(e);return this}getBytes(){return encodeURIComponent(this.s).replace(/%../g,"x").length}getLength(){return this.s.length}isLess(t){return this.s<t.s}isGreat(t){return this.s>t.s}isEqual(t){return this.s==t}isEmpty(){return this.s.length==0}}var er;(function(r){r.csmString=St})(er||(er={}));class me{constructor(t){n(this,"_id");if(typeof t=="string"){this._id=new St(t);return}this._id=t}getString(){return this._id}isEqual(t){return typeof t=="string"?this._id.isEqual(t):t instanceof St?this._id.isEqual(t.s):t instanceof me?this._id.isEqual(t._id.s):!1}isNotEqual(t){return typeof t=="string"?!this._id.isEqual(t):t instanceof St?!this._id.isEqual(t.s):t instanceof me?!this._id.isEqual(t._id.s):!1}}var ir;(function(r){r.CubismId=me})(ir||(ir={}));class Cs{constructor(){n(this,"_ids");this._ids=new L}release(){for(let t=0;t<this._ids.getSize();++t)this._ids.set(t,void 0);this._ids=null}registerIds(t){for(let e=0;e<t.length;e++)this.registerId(t[e])}registerId(t){let e=null;if(typeof t=="string"){if((e=this.findId(t))!=null)return e;e=new me(t),this._ids.pushBack(e)}else return this.registerId(t.s);return e}getId(t){return this.registerId(t)}isExist(t){return typeof t=="string"?this.findId(t)!=null:this.isExist(t.s)}findId(t){for(let e=0;e<this._ids.getSize();++e)if(this._ids.at(e).getString().isEqual(t))return this._ids.at(e);return null}}var rr;(function(r){r.CubismIdManager=Cs})(rr||(rr={}));class et{constructor(){n(this,"_tr");this._tr=new Float32Array(16),this.loadIdentity()}static multiply(t,e,i){const s=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),a=4;for(let o=0;o<a;++o)for(let l=0;l<a;++l)for(let c=0;c<a;++c)s[l+o*4]+=t[c+o*4]*e[l+c*4];for(let o=0;o<16;++o)i[o]=s[o]}loadIdentity(){const t=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);this.setMatrix(t)}setMatrix(t){for(let e=0;e<16;++e)this._tr[e]=t[e]}getArray(){return this._tr}getScaleX(){return this._tr[0]}getScaleY(){return this._tr[5]}getTranslateX(){return this._tr[12]}getTranslateY(){return this._tr[13]}transformX(t){return this._tr[0]*t+this._tr[12]}transformY(t){return this._tr[5]*t+this._tr[13]}invertTransformX(t){return(t-this._tr[12])/this._tr[0]}invertTransformY(t){return(t-this._tr[13])/this._tr[5]}translateRelative(t,e){const i=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,e,0,1]);et.multiply(i,this._tr,this._tr)}translate(t,e){this._tr[12]=t,this._tr[13]=e}translateX(t){this._tr[12]=t}translateY(t){this._tr[13]=t}scaleRelative(t,e){const i=new Float32Array([t,0,0,0,0,e,0,0,0,0,1,0,0,0,0,1]);et.multiply(i,this._tr,this._tr)}scale(t,e){this._tr[0]=t,this._tr[5]=e}multiplyByMatrix(t){et.multiply(t.getArray(),this._tr,this._tr)}clone(){const t=new et;for(let e=0;e<this._tr.length;e++)t._tr[e]=this._tr[e];return t}}var sr;(function(r){r.CubismMatrix44=et})(sr||(sr={}));class Pe{constructor(){n(this,"_mvpMatrix4x4");n(this,"_modelColor");n(this,"_isCulling");n(this,"_isPremultipliedAlpha");n(this,"_anisotropy");n(this,"_model");n(this,"_useHighPrecisionMask");this._isCulling=!1,this._isPremultipliedAlpha=!1,this._anisotropy=0,this._model=null,this._modelColor=new ct,this._useHighPrecisionMask=!1,this._mvpMatrix4x4=new et,this._mvpMatrix4x4.loadIdentity()}static create(){return null}static delete(t){}initialize(t){this._model=t}drawModel(){this.getModel()!=null&&(this.saveProfile(),this.doDrawModel(),this.restoreProfile())}setMvpMatrix(t){this._mvpMatrix4x4.setMatrix(t.getArray())}getMvpMatrix(){return this._mvpMatrix4x4}setModelColor(t,e,i,s){t<0?t=0:t>1&&(t=1),e<0?e=0:e>1&&(e=1),i<0?i=0:i>1&&(i=1),s<0?s=0:s>1&&(s=1),this._modelColor.R=t,this._modelColor.G=e,this._modelColor.B=i,this._modelColor.A=s}getModelColor(){return JSON.parse(JSON.stringify(this._modelColor))}setIsPremultipliedAlpha(t){this._isPremultipliedAlpha=t}isPremultipliedAlpha(){return this._isPremultipliedAlpha}setIsCulling(t){this._isCulling=t}isCulling(){return this._isCulling}setAnisotropy(t){this._anisotropy=t}getAnisotropy(){return this._anisotropy}getModel(){return this._model}useHighPrecisionMask(t){this._useHighPrecisionMask=t}isUsingHighPrecisionMask(){return this._useHighPrecisionMask}}n(Pe,"staticRelease");var Bt;(function(r){r[r.CubismBlendMode_Normal=0]="CubismBlendMode_Normal",r[r.CubismBlendMode_Additive=1]="CubismBlendMode_Additive",r[r.CubismBlendMode_Multiplicative=2]="CubismBlendMode_Multiplicative"})(Bt||(Bt={}));class ct{constructor(t=1,e=1,i=1,s=1){n(this,"R");n(this,"G");n(this,"B");n(this,"A");this.R=t,this.G=e,this.B=i,this.A=s}}var ar;(function(r){r.CubismBlendMode=Bt,r.CubismRenderer=Pe,r.CubismTextureColor=ct})(ar||(ar={}));const tn=(r,t,e)=>{vs.print(r,"[CSM]"+t,e)},Ve=(r,t,e)=>{tn(r,t+`
`,e)},vt=r=>{console.assert(r)};let pe,Mt,Lt,ut;pe=(r,...t)=>{Ve(Nt.LogLevel_Debug,"[D]"+r,t)},Mt=(r,...t)=>{Ve(Nt.LogLevel_Info,"[I]"+r,t)},Lt=(r,...t)=>{Ve(Nt.LogLevel_Warning,"[W]"+r,t)},ut=(r,...t)=>{Ve(Nt.LogLevel_Error,"[E]"+r,t)};class vs{static print(t,e,i){if(t<j.getLoggingLevel())return;const s=j.coreLogFunction;if(!s)return;const a=e.replace(/\{(\d+)\}/g,(o,l)=>i[l]);s(a)}static dumpBytes(t,e,i){for(let s=0;s<i;s++)s%16==0&&s>0?this.print(t,`
`):s%8==0&&s>0&&this.print(t,"  "),this.print(t,"{0} ",[e[s]&255]);this.print(t,`
`)}constructor(){}}var nr;(function(r){r.CubismDebug=vs})(nr||(nr={}));class Ms{constructor(t,e){n(this,"first");n(this,"second");this.first=t??null,this.second=e??null}}const _e=class _e{constructor(t){n(this,"_keyValues");n(this,"_dummyValue");n(this,"_size");t!=null?t<1?(this._keyValues=[],this._dummyValue=null,this._size=0):(this._keyValues=new Array(t),this._size=t):(this._keyValues=[],this._dummyValue=null,this._size=0)}release(){this.clear()}appendKey(t){this.prepareCapacity(this._size+1,!1),this._keyValues[this._size]=new Ms(t),this._size+=1}getValue(t){let e=-1;for(let i=0;i<this._size;i++)if(this._keyValues[i].first==t){e=i;break}return e>=0?this._keyValues[e].second:(this.appendKey(t),this._keyValues[this._size-1].second)}setValue(t,e){let i=-1;for(let s=0;s<this._size;s++)if(this._keyValues[s].first==t){i=s;break}i>=0?this._keyValues[i].second=e:(this.appendKey(t),this._keyValues[this._size-1].second=e)}isExist(t){for(let e=0;e<this._size;e++)if(this._keyValues[e].first==t)return!0;return!1}clear(){this._keyValues=void 0,this._keyValues=null,this._keyValues=[],this._size=0}getSize(){return this._size}prepareCapacity(t,e){t>this._keyValues.length&&(this._keyValues.length==0?(!e&&t<_e.DefaultSize&&(t=_e.DefaultSize),this._keyValues.length=t):(!e&&t<this._keyValues.length*2&&(t=this._keyValues.length*2),this._keyValues.length=t))}begin(){return new jt(this,0)}end(){return new jt(this,this._size)}erase(t){const e=t._index;return e<0||this._size<=e?t:(this._keyValues.splice(e,1),--this._size,new jt(this,e))}dumpAsInt(){for(let t=0;t<this._size;t++)pe("{0} ,",this._keyValues[t]),pe(`
`)}};n(_e,"DefaultSize",10);let ft=_e;class jt{constructor(t,e){n(this,"_index");n(this,"_map");this._map=t??new ft,this._index=e??0}set(t){return this._index=t._index,this._map=t._map,this}preIncrement(){return++this._index,this}preDecrement(){return--this._index,this}increment(){return new jt(this._map,this._index++)}decrement(){const t=new jt(this._map,this._index);return this._map=t._map,this._index=t._index,this}ptr(){return this._map._keyValues[this._index]}notEqual(t){return this._index!=t._index||this._map!=t._map}}var or;(function(r){r.csmMap=ft,r.csmPair=Ms,r.iterator=jt})(or||(or={}));class Xe{static parseJsonObject(t,e){return Object.keys(t).forEach(i=>{if(typeof t[i]=="boolean"){const s=!!t[i];e.put(i,new _t(s))}else if(typeof t[i]=="string"){const s=String(t[i]);e.put(i,new ae(s))}else if(typeof t[i]=="number"){const s=Number(t[i]);e.put(i,new Ge(s))}else t[i]instanceof Array?e.put(i,Xe.parseJsonArray(t[i])):t[i]instanceof Object?e.put(i,Xe.parseJsonObject(t[i],new re)):t[i]==null?e.put(i,new ie):e.put(i,t[i])}),e}static parseJsonArray(t){const e=new Ii;return Object.keys(t).forEach(i=>{if(typeof Number(i)=="number")if(typeof t[i]=="boolean"){const a=!!t[i];e.add(new _t(a))}else if(typeof t[i]=="string"){const a=String(t[i]);e.add(new ae(a))}else if(typeof t[i]=="number"){const a=Number(t[i]);e.add(new Ge(a))}else t[i]instanceof Array?e.add(this.parseJsonArray(t[i])):t[i]instanceof Object?e.add(this.parseJsonObject(t[i],new re)):t[i]==null?e.add(new ie):e.add(t[i]);else if(t[i]instanceof Array)e.add(this.parseJsonArray(t[i]));else if(t[i]instanceof Object)e.add(this.parseJsonObject(t[i],new re));else if(t[i]==null)e.add(new ie);else{const a=Array(t[i]);for(let o=0;o<a.length;o++)e.add(a[o])}}),e}}const Ye="Error: type mismatch",en="Error: index out of bounds";var ot;let lt=(ot=class{constructor(){n(this,"_stringBuffer")}getRawString(t,e){return this.getString(t,e)}toInt(t=0){return t}toFloat(t=0){return t}toBoolean(t=!1){return t}getSize(){return 0}getArray(t=null){return t}getVector(t=new L){return t}getMap(t){return t}getValueByIndex(t){return ot.errorValue.setErrorNotForClientCall(Ye)}getValueByString(t){return ot.nullValue.setErrorNotForClientCall(Ye)}getKeys(){return ot.s_dummyKeys}isError(){return!1}isNull(){return!1}isBool(){return!1}isFloat(){return!1}isString(){return!1}isArray(){return!1}isMap(){return!1}equals(t){return!1}isStatic(){return!1}setErrorNotForClientCall(t){return ye.errorValue}static staticInitializeNotForClientCall(){_t.trueValue=new _t(!0),_t.falseValue=new _t(!1),ot.errorValue=new ye("ERROR",!0),ot.nullValue=new ie,ot.s_dummyKeys=new L}static staticReleaseNotForClientCall(){_t.trueValue=null,_t.falseValue=null,ot.errorValue=null,ot.nullValue=null,ot.s_dummyKeys=null}},n(ot,"s_dummyKeys"),n(ot,"errorValue"),n(ot,"nullValue"),ot);class nt{constructor(t,e){n(this,"_parseCallback",Xe.parseJsonObject);n(this,"_error");n(this,"_lineCount");n(this,"_root");this._error=null,this._lineCount=0,this._root=null,t!=null&&this.parseBytes(t,e,this._parseCallback)}static create(t,e){const i=new nt;return i.parseBytes(t,e,i._parseCallback)?i:(nt.delete(i),null)}static delete(t){}getRoot(){return this._root}static arrayBufferToString(t){const e=new Uint8Array(t);let i="";for(let s=0,a=e.length;s<a;++s)i+="%"+this.pad(e[s].toString(16));return i=decodeURIComponent(i),i}static pad(t){return t.length<2?"0"+t:t}parseBytes(t,e,i){const s=new Array(1),a=nt.arrayBufferToString(t);if(i==null?this._root=this.parseValue(a,e,0,s):this._root=i(JSON.parse(a),new re),this._error){let o="\0";return o="Json parse error : @line "+(this._lineCount+1)+`
`,this._root=new ae(o),Mt("{0}",this._root.getRawString()),!1}else if(this._root==null)return this._root=new ye(new St(this._error),!1),!1;return!0}getParseError(){return this._error}checkEndOfFile(){return this._root.getArray()[1].equals("EOF")}parseValue(t,e,i,s){if(this._error)return null;let a=null,o=i,l;for(;o<e;o++)switch(t[o]){case"-":case".":case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{const g=new Array(1);return l=rn(t.slice(o),g),s[0]=t.indexOf(g[0]),new Ge(l)}case'"':return new ae(this.parseString(t,e,o+1,s));case"[":return a=this.parseArray(t,e,o+1,s),a;case"{":return a=this.parseObject(t,e,o+1,s),a;case"n":return o+3<e?(a=new ie,s[0]=o+4):this._error="parse null",a;case"t":return o+3<e?(a=_t.trueValue,s[0]=o+4):this._error="parse true",a;case"f":return o+4<e?(a=_t.falseValue,s[0]=o+5):this._error="illegal ',' position",a;case",":return this._error="illegal ',' position",null;case"]":return s[0]=o,null;case`
`:this._lineCount++}return this._error="illegal end of value",null}parseString(t,e,i,s){if(this._error)return null;let a=i,o,l;const c=new St("");let g=i;for(;a<e;a++)switch(o=t[a],o){case'"':return s[0]=a+1,c.append(t.slice(g),a-g),c.s;case"//":if(a++,a-1>g&&c.append(t.slice(g),a-g),g=a+1,a<e)switch(l=t[a],l){case"\\":c.expansion(1,"\\");break;case'"':c.expansion(1,'"');break;case"/":c.expansion(1,"/");break;case"b":c.expansion(1,"\b");break;case"f":c.expansion(1,"\f");break;case"n":c.expansion(1,`
`);break;case"r":c.expansion(1,"\r");break;case"t":c.expansion(1,"	");break;case"u":this._error="parse string/unicord escape not supported";break}else this._error="parse string/escape error"}return this._error="parse string/illegal end",null}parseObject(t,e,i,s){if(this._error)return null;const a=new re;let o="",l=i,c="";const g=Array(1);let f=!1;for(;l<e;l++){t:for(;l<e;l++)switch(c=t[l],c){case'"':if(o=this.parseString(t,e,l+1,g),this._error)return null;l=g[0],f=!0;break t;case"}":return s[0]=l+1,a;case":":this._error="illegal ':' position";break;case`
`:this._lineCount++}if(!f)return this._error="key not found",null;f=!1;t:for(;l<e;l++)switch(c=t[l],c){case":":f=!0,l++;break t;case"}":this._error="illegal '}' position";break;case`
`:this._lineCount++}if(!f)return this._error="':' not found",null;const p=this.parseValue(t,e,l,g);if(this._error)return null;l=g[0],a.put(o,p);t:for(;l<e;l++)switch(c=t[l],c){case",":break t;case"}":return s[0]=l+1,a;case`
`:this._lineCount++}}return this._error="illegal end of perseObject",null}parseArray(t,e,i,s){if(this._error)return null;let a=new Ii,o=i,l;const c=new Array(1);for(;o<e;o++){const g=this.parseValue(t,e,o,c);if(this._error)return null;o=c[0],g&&a.add(g);t:for(;o<e;o++)switch(l=t[o],l){case",":break t;case"]":return s[0]=o+1,a;case`
`:++this._lineCount}}return a=void 0,this._error="illegal end of parseObject",null}}class Ge extends lt{constructor(e){super();n(this,"_value");this._value=e}isFloat(){return!0}getString(e,i){const s="\0";return this._value=parseFloat(s),this._stringBuffer=s,this._stringBuffer}toInt(e=0){return parseInt(this._value.toString())}toFloat(e=0){return this._value}equals(e){return typeof e=="number"?Math.round(e)?!1:e==this._value:!1}}class _t extends lt{constructor(e){super();n(this,"_boolValue");this._boolValue=e}isBool(){return!0}toBoolean(e=!1){return this._boolValue}getString(e,i){return this._stringBuffer=this._boolValue?"true":"false",this._stringBuffer}equals(e){return typeof e=="boolean"?e==this._boolValue:!1}isStatic(){return!0}}n(_t,"trueValue"),n(_t,"falseValue");class ae extends lt{constructor(t){super(),typeof t=="string"&&(this._stringBuffer=t),t instanceof St&&(this._stringBuffer=t.s)}isString(){return!0}getString(t,e){return this._stringBuffer}equals(t){return typeof t=="string"?this._stringBuffer==t:t instanceof St?this._stringBuffer==t.s:!1}}class ye extends ae{constructor(e,i){var t=(...args)=>{super(...args);n(this,"_isStatic")};t(e),this._isStatic=i}isStatic(){return this._isStatic}setErrorNotForClientCall(e){return this._stringBuffer=e,this}isError(){return!0}}class ie extends lt{isNull(){return!0}getString(t,e){return this._stringBuffer}isStatic(){return!0}setErrorNotForClientCall(t){return this._stringBuffer=t,ye.nullValue}constructor(){super(),this._stringBuffer="NullValue"}}class Ii extends lt{constructor(){super();n(this,"_array");this._array=new L}release(){for(let e=this._array.begin();e.notEqual(this._array.end());e.preIncrement()){let i=e.ptr();i&&!i.isStatic()&&(i=void 0,i=null)}}isArray(){return!0}getValueByIndex(e){if(e<0||this._array.getSize()<=e)return lt.errorValue.setErrorNotForClientCall(en);const i=this._array.at(e);return i??lt.nullValue}getValueByString(e){return lt.errorValue.setErrorNotForClientCall(Ye)}getString(e,i){const s=i+`[
`;for(let a=this._array.begin();a.notEqual(this._array.end());a.increment()){const o=a.ptr();this._stringBuffer+=i+""+o.getString(i+" ")+`
`}return this._stringBuffer=s+i+`]
`,this._stringBuffer}add(e){this._array.pushBack(e)}getVector(e=null){return this._array}getSize(){return this._array.getSize()}}class re extends lt{constructor(){super();n(this,"_map");n(this,"_keys");this._map=new ft}release(){const e=this._map.begin();for(;e.notEqual(this._map.end());){let i=e.ptr().second;i&&!i.isStatic()&&(i=void 0,i=null),e.preIncrement()}}isMap(){return!0}getValueByString(e){if(e instanceof St){const i=this._map.getValue(e.s);return i??lt.nullValue}for(let i=this._map.begin();i.notEqual(this._map.end());i.preIncrement())if(i.ptr().first==e)return i.ptr().second==null?lt.nullValue:i.ptr().second;return lt.nullValue}getValueByIndex(e){return lt.errorValue.setErrorNotForClientCall(Ye)}getString(e,i){this._stringBuffer=i+`{
`;const s=this._map.begin();for(;s.notEqual(this._map.end());){const a=s.ptr().first,o=s.ptr().second;this._stringBuffer+=i+" "+a+" : "+o.getString(i+"   ")+` 
`,s.preIncrement()}return this._stringBuffer+=i+`}
`,this._stringBuffer}getMap(e){return this._map}put(e,i){this._map.setValue(e,i)}getKeys(){if(!this._keys){this._keys=new L;const e=this._map.begin();for(;e.notEqual(this._map.end());){const i=e.ptr().first;this._keys.pushBack(i),e.preIncrement()}}return this._keys}getSize(){return this._keys.getSize()}}var lr;(function(r){r.CubismJson=nt,r.JsonArray=Ii,r.JsonBoolean=_t,r.JsonError=ye,r.JsonFloat=Ge,r.JsonMap=re,r.JsonNullvalue=ie,r.JsonString=ae,r.Value=lt})(lr||(lr={}));function rn(r,t){let e=0;for(let s=1;;s++){const a=r.slice(s-1,s);if(a=="e"||a=="-"||a=="E")continue;const o=r.substring(0,s),l=Number(o);if(isNaN(l))break;e=s}let i=parseFloat(r);return isNaN(i)&&(i=NaN),t[0]=r.slice(e),i}let Ct=!1,qt=!1,Jt=null,he=null;const Ot=Object.freeze({vertexOffset:0,vertexStep:2});function sn(r){r&&(r=void 0)}class j{static startUp(t=null){if(Ct)return Mt("CubismFramework.startUp() is already done."),Ct;if(Jt=t,Jt!=null&&Live2DCubismCore.Logging.csmSetLogFunction(Jt.logFunction),Ct=!0,Ct){const e=Live2DCubismCore.Version.csmGetVersion(),i=(e&4278190080)>>24,s=(e&16711680)>>16,a=e&65535,o=e;Mt("Live2D Cubism Core version: {0}.{1}.{2} ({3})",("00"+i).slice(-2),("00"+s).slice(-2),("0000"+a).slice(-4),o)}return Mt("CubismFramework.startUp() is complete."),Ct}static cleanUp(){Ct=!1,qt=!1,Jt=null,he=null}static initialize(t=0){if(vt(Ct),!Ct){Lt("CubismFramework is not started.");return}if(qt){Lt("CubismFramework.initialize() skipped, already initialized.");return}lt.staticInitializeNotForClientCall(),he=new Cs,Live2DCubismCore.Memory.initializeAmountOfMemory(t),qt=!0,Mt("CubismFramework.initialize() is complete.")}static dispose(){if(vt(Ct),!Ct){Lt("CubismFramework is not started.");return}if(!qt){Lt("CubismFramework.dispose() skipped, not initialized.");return}lt.staticReleaseNotForClientCall(),he.release(),he=null,Pe.staticRelease(),qt=!1,Mt("CubismFramework.dispose() is complete.")}static isStarted(){return Ct}static isInitialized(){return qt}static coreLogFunction(t){Live2DCubismCore.Logging.csmGetLogFunction()&&Live2DCubismCore.Logging.csmGetLogFunction()(t)}static getLoggingLevel(){return Jt!=null?Jt.loggingLevel:Nt.LogLevel_Off}static getIdManager(){return he}constructor(){}}class an{constructor(){n(this,"logFunction");n(this,"loggingLevel")}}var Nt;(function(r){r[r.LogLevel_Verbose=0]="LogLevel_Verbose",r[r.LogLevel_Debug=1]="LogLevel_Debug",r[r.LogLevel_Info=2]="LogLevel_Info",r[r.LogLevel_Warning=3]="LogLevel_Warning",r[r.LogLevel_Error=4]="LogLevel_Error",r[r.LogLevel_Off=5]="LogLevel_Off"})(Nt||(Nt={}));var ur;(function(r){r.Constant=Ot,r.csmDelete=sn,r.CubismFramework=j})(ur||(ur={}));function nn(r){let{waifuPath:t,models:e,size:i,renderRatio:s,useCache:a,debug:o}=r;t.endsWith("/")||(t+="/"),Bs=t,xi=e,bs=e.length,Ps=a,Yt=o,i==="full"?je="full":je={width:i.width*s,height:i.height*s}}var je;const hr=1,on=2,ln=.8,un=-1,hn=1,cn=-2,gn=2,dn=-2,_n=2;var Bs,Ps,xi,bs;const fn="Idle",mn="TapBody",cr="Head",gr="Body",pn=1,yn=2,dr=3;var Yt;const Sn=Nt.LogLevel_Verbose,N=Object.freeze({HitAreaPrefix:"HitArea",HitAreaHead:"Head",HitAreaBody:"Body",PartsIdCore:"Parts01Core",PartsArmPrefix:"Parts01Arm_",PartsArmLPrefix:"Parts01ArmL_",PartsArmRPrefix:"Parts01ArmR_",ParamAngleX:"ParamAngleX",ParamAngleY:"ParamAngleY",ParamAngleZ:"ParamAngleZ",ParamEyeLOpen:"ParamEyeLOpen",ParamEyeLSmile:"ParamEyeLSmile",ParamEyeROpen:"ParamEyeROpen",ParamEyeRSmile:"ParamEyeRSmile",ParamEyeBallX:"ParamEyeBallX",ParamEyeBallY:"ParamEyeBallY",ParamEyeBallForm:"ParamEyeBallForm",ParamBrowLY:"ParamBrowLY",ParamBrowRY:"ParamBrowRY",ParamBrowLX:"ParamBrowLX",ParamBrowRX:"ParamBrowRX",ParamBrowLAngle:"ParamBrowLAngle",ParamBrowRAngle:"ParamBrowRAngle",ParamBrowLForm:"ParamBrowLForm",ParamBrowRForm:"ParamBrowRForm",ParamMouthForm:"ParamMouthForm",ParamMouthOpenY:"ParamMouthOpenY",ParamCheek:"ParamCheek",ParamBodyAngleX:"ParamBodyAngleX",ParamBodyAngleY:"ParamBodyAngleY",ParamBodyAngleZ:"ParamBodyAngleZ",ParamBreath:"ParamBreath",ParamArmLA:"ParamArmLA",ParamArmRA:"ParamArmRA",ParamArmLB:"ParamArmLB",ParamArmRB:"ParamArmRB",ParamHandL:"ParamHandL",ParamHandR:"ParamHandR",ParamHairFront:"ParamHairFront",ParamHairSide:"ParamHairSide",ParamHairBack:"ParamHairBack",ParamHairFluffy:"ParamHairFluffy",ParamShoulderY:"ParamShoulderY",ParamBustX:"ParamBustX",ParamBustY:"ParamBustY",ParamBaseX:"ParamBaseX",ParamBaseY:"ParamBaseY",ParamNONE:"NONE:"});var _r;(function(r){r.HitAreaBody=N.HitAreaBody,r.HitAreaHead=N.HitAreaHead,r.HitAreaPrefix=N.HitAreaPrefix,r.ParamAngleX=N.ParamAngleX,r.ParamAngleY=N.ParamAngleY,r.ParamAngleZ=N.ParamAngleZ,r.ParamArmLA=N.ParamArmLA,r.ParamArmLB=N.ParamArmLB,r.ParamArmRA=N.ParamArmRA,r.ParamArmRB=N.ParamArmRB,r.ParamBaseX=N.ParamBaseX,r.ParamBaseY=N.ParamBaseY,r.ParamBodyAngleX=N.ParamBodyAngleX,r.ParamBodyAngleY=N.ParamBodyAngleY,r.ParamBodyAngleZ=N.ParamBodyAngleZ,r.ParamBreath=N.ParamBreath,r.ParamBrowLAngle=N.ParamBrowLAngle,r.ParamBrowLForm=N.ParamBrowLForm,r.ParamBrowLX=N.ParamBrowLX,r.ParamBrowLY=N.ParamBrowLY,r.ParamBrowRAngle=N.ParamBrowRAngle,r.ParamBrowRForm=N.ParamBrowRForm,r.ParamBrowRX=N.ParamBrowRX,r.ParamBrowRY=N.ParamBrowRY,r.ParamBustX=N.ParamBustX,r.ParamBustY=N.ParamBustY,r.ParamCheek=N.ParamCheek,r.ParamEyeBallForm=N.ParamEyeBallForm,r.ParamEyeBallX=N.ParamEyeBallX,r.ParamEyeBallY=N.ParamEyeBallY,r.ParamEyeLOpen=N.ParamEyeLOpen,r.ParamEyeLSmile=N.ParamEyeLSmile,r.ParamEyeROpen=N.ParamEyeROpen,r.ParamEyeRSmile=N.ParamEyeRSmile,r.ParamHairBack=N.ParamHairBack,r.ParamHairFluffy=N.ParamHairFluffy,r.ParamHairFront=N.ParamHairFront,r.ParamHairSide=N.ParamHairSide,r.ParamHandL=N.ParamHandL,r.ParamHandR=N.ParamHandR,r.ParamMouthForm=N.ParamMouthForm,r.ParamMouthOpenY=N.ParamMouthOpenY,r.ParamNONE=N.ParamNONE,r.ParamShoulderY=N.ParamShoulderY,r.PartsArmLPrefix=N.PartsArmLPrefix,r.PartsArmPrefix=N.PartsArmPrefix,r.PartsArmRPrefix=N.PartsArmRPrefix,r.PartsIdCore=N.PartsIdCore})(_r||(_r={}));class Is{}var fr;(function(r){r.ICubismModelSetting=Is})(fr||(fr={}));const Ft="FileReferences",xn="Groups",Cn="Layout",vn="HitAreas",Mn="Moc",Bn="Textures",Pn="Physics",bn="Pose",In="Expressions",wn="Motions",mr="UserData",At="Name",pr="File",Tn="Id",Ee="Ids",yr="Sound",Sr="FadeInTime",xr="FadeOutTime",ui="LipSync",hi="EyeBlink";var z;(function(r){r[r.FrequestNode_Groups=0]="FrequestNode_Groups",r[r.FrequestNode_Moc=1]="FrequestNode_Moc",r[r.FrequestNode_Motions=2]="FrequestNode_Motions",r[r.FrequestNode_Expressions=3]="FrequestNode_Expressions",r[r.FrequestNode_Textures=4]="FrequestNode_Textures",r[r.FrequestNode_Physics=5]="FrequestNode_Physics",r[r.FrequestNode_Pose=6]="FrequestNode_Pose",r[r.FrequestNode_HitAreas=7]="FrequestNode_HitAreas"})(z||(z={}));class ws extends Is{constructor(e,i){super();n(this,"_json");n(this,"_jsonValue");this._json=nt.create(e,i),this._json&&(this._jsonValue=new L,this._jsonValue.pushBack(this._json.getRoot().getValueByString(xn)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(Ft).getValueByString(Mn)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(Ft).getValueByString(wn)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(Ft).getValueByString(In)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(Ft).getValueByString(Bn)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(Ft).getValueByString(Pn)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(Ft).getValueByString(bn)),this._jsonValue.pushBack(this._json.getRoot().getValueByString(vn)))}release(){nt.delete(this._json),this._jsonValue=null}GetJson(){return this._json}getModelFileName(){return this.isExistModelFile()?this._jsonValue.at(z.FrequestNode_Moc).getRawString():""}getTextureCount(){return this.isExistTextureFiles()?this._jsonValue.at(z.FrequestNode_Textures).getSize():0}getTextureDirectory(){const i=this._jsonValue.at(z.FrequestNode_Textures).getValueByIndex(0).getRawString().split("/"),s=i.length-1;let a="";for(let o=0;o<s;o++)a+=i[o],o<s-1&&(a+="/");return a}getTextureFileName(e){return this._jsonValue.at(z.FrequestNode_Textures).getValueByIndex(e).getRawString()}getHitAreasCount(){return this.isExistHitAreas()?this._jsonValue.at(z.FrequestNode_HitAreas).getSize():0}getHitAreaId(e){return j.getIdManager().getId(this._jsonValue.at(z.FrequestNode_HitAreas).getValueByIndex(e).getValueByString(Tn).getRawString())}getHitAreaName(e){return this._jsonValue.at(z.FrequestNode_HitAreas).getValueByIndex(e).getValueByString(At).getRawString()}getPhysicsFileName(){return this.isExistPhysicsFile()?this._jsonValue.at(z.FrequestNode_Physics).getRawString():""}getPoseFileName(){return this.isExistPoseFile()?this._jsonValue.at(z.FrequestNode_Pose).getRawString():""}getExpressionCount(){return this.isExistExpressionFile()?this._jsonValue.at(z.FrequestNode_Expressions).getSize():0}getExpressionName(e){return this._jsonValue.at(z.FrequestNode_Expressions).getValueByIndex(e).getValueByString(At).getRawString()}getExpressionFileName(e){return this._jsonValue.at(z.FrequestNode_Expressions).getValueByIndex(e).getValueByString(pr).getRawString()}getMotionGroupCount(){return this.isExistMotionGroups()?this._jsonValue.at(z.FrequestNode_Motions).getKeys().getSize():0}getMotionGroupName(e){return this.isExistMotionGroups()?this._jsonValue.at(z.FrequestNode_Motions).getKeys().at(e):null}getMotionCount(e){return this.isExistMotionGroupName(e)?this._jsonValue.at(z.FrequestNode_Motions).getValueByString(e).getSize():0}getMotionFileName(e,i){return this.isExistMotionGroupName(e)?this._jsonValue.at(z.FrequestNode_Motions).getValueByString(e).getValueByIndex(i).getValueByString(pr).getRawString():""}getMotionSoundFileName(e,i){return this.isExistMotionSoundFile(e,i)?this._jsonValue.at(z.FrequestNode_Motions).getValueByString(e).getValueByIndex(i).getValueByString(yr).getRawString():""}getMotionFadeInTimeValue(e,i){return this.isExistMotionFadeIn(e,i)?this._jsonValue.at(z.FrequestNode_Motions).getValueByString(e).getValueByIndex(i).getValueByString(Sr).toFloat():-1}getMotionFadeOutTimeValue(e,i){return this.isExistMotionFadeOut(e,i)?this._jsonValue.at(z.FrequestNode_Motions).getValueByString(e).getValueByIndex(i).getValueByString(xr).toFloat():-1}getUserDataFile(){return this.isExistUserDataFile()?this._json.getRoot().getValueByString(Ft).getValueByString(mr).getRawString():""}getLayoutMap(e){const i=this._json.getRoot().getValueByString(Cn).getMap();if(i==null)return!1;let s=!1;for(const a=i.begin();a.notEqual(i.end());a.preIncrement())e.setValue(a.ptr().first,a.ptr().second.toFloat()),s=!0;return s}getEyeBlinkParameterCount(){if(!this.isExistEyeBlinkParameters())return 0;let e=0;for(let i=0;i<this._jsonValue.at(z.FrequestNode_Groups).getSize();i++){const s=this._jsonValue.at(z.FrequestNode_Groups).getValueByIndex(i);if(!(s.isNull()||s.isError())&&s.getValueByString(At).getRawString()==hi){e=s.getValueByString(Ee).getVector().getSize();break}}return e}getEyeBlinkParameterId(e){if(!this.isExistEyeBlinkParameters())return null;for(let i=0;i<this._jsonValue.at(z.FrequestNode_Groups).getSize();i++){const s=this._jsonValue.at(z.FrequestNode_Groups).getValueByIndex(i);if(!(s.isNull()||s.isError())&&s.getValueByString(At).getRawString()==hi)return j.getIdManager().getId(s.getValueByString(Ee).getValueByIndex(e).getRawString())}return null}getLipSyncParameterCount(){if(!this.isExistLipSyncParameters())return 0;let e=0;for(let i=0;i<this._jsonValue.at(z.FrequestNode_Groups).getSize();i++){const s=this._jsonValue.at(z.FrequestNode_Groups).getValueByIndex(i);if(!(s.isNull()||s.isError())&&s.getValueByString(At).getRawString()==ui){e=s.getValueByString(Ee).getVector().getSize();break}}return e}getLipSyncParameterId(e){if(!this.isExistLipSyncParameters())return null;for(let i=0;i<this._jsonValue.at(z.FrequestNode_Groups).getSize();i++){const s=this._jsonValue.at(z.FrequestNode_Groups).getValueByIndex(i);if(!(s.isNull()||s.isError())&&s.getValueByString(At).getRawString()==ui)return j.getIdManager().getId(s.getValueByString(Ee).getValueByIndex(e).getRawString())}return null}isExistModelFile(){const e=this._jsonValue.at(z.FrequestNode_Moc);return!e.isNull()&&!e.isError()}isExistTextureFiles(){const e=this._jsonValue.at(z.FrequestNode_Textures);return!e.isNull()&&!e.isError()}isExistHitAreas(){const e=this._jsonValue.at(z.FrequestNode_HitAreas);return!e.isNull()&&!e.isError()}isExistPhysicsFile(){const e=this._jsonValue.at(z.FrequestNode_Physics);return!e.isNull()&&!e.isError()}isExistPoseFile(){const e=this._jsonValue.at(z.FrequestNode_Pose);return!e.isNull()&&!e.isError()}isExistExpressionFile(){const e=this._jsonValue.at(z.FrequestNode_Expressions);return!e.isNull()&&!e.isError()}isExistMotionGroups(){const e=this._jsonValue.at(z.FrequestNode_Motions);return!e.isNull()&&!e.isError()}isExistMotionGroupName(e){const i=this._jsonValue.at(z.FrequestNode_Motions).getValueByString(e);return!i.isNull()&&!i.isError()}isExistMotionSoundFile(e,i){const s=this._jsonValue.at(z.FrequestNode_Motions).getValueByString(e).getValueByIndex(i).getValueByString(yr);return!s.isNull()&&!s.isError()}isExistMotionFadeIn(e,i){const s=this._jsonValue.at(z.FrequestNode_Motions).getValueByString(e).getValueByIndex(i).getValueByString(Sr);return!s.isNull()&&!s.isError()}isExistMotionFadeOut(e,i){const s=this._jsonValue.at(z.FrequestNode_Motions).getValueByString(e).getValueByIndex(i).getValueByString(xr);return!s.isNull()&&!s.isError()}isExistUserDataFile(){const e=this._json.getRoot().getValueByString(Ft).getValueByString(mr);return!e.isNull()&&!e.isError()}isExistEyeBlinkParameters(){if(this._jsonValue.at(z.FrequestNode_Groups).isNull()||this._jsonValue.at(z.FrequestNode_Groups).isError())return!1;for(let e=0;e<this._jsonValue.at(z.FrequestNode_Groups).getSize();++e)if(this._jsonValue.at(z.FrequestNode_Groups).getValueByIndex(e).getValueByString(At).getRawString()==hi)return!0;return!1}isExistLipSyncParameters(){if(this._jsonValue.at(z.FrequestNode_Groups).isNull()||this._jsonValue.at(z.FrequestNode_Groups).isError())return!1;for(let e=0;e<this._jsonValue.at(z.FrequestNode_Groups).getSize();++e)if(this._jsonValue.at(z.FrequestNode_Groups).getValueByIndex(e).getValueByString(At).getRawString()==ui)return!0;return!1}}var Cr;(function(r){r.CubismModelSettingJson=ws})(Cr||(Cr={}));class be{constructor(){n(this,"_breathParameters");n(this,"_currentTime");this._currentTime=0}static create(){return new be}static delete(t){}setParameters(t){this._breathParameters=t}getParameters(){return this._breathParameters}updateParameters(t,e){this._currentTime+=e;const i=this._currentTime*2*3.14159;for(let s=0;s<this._breathParameters.getSize();++s){const a=this._breathParameters.at(s);t.addParameterValueById(a.parameterId,a.offset+a.peak*Math.sin(i/a.cycle),a.weight)}}}class te{constructor(t,e,i,s,a){n(this,"parameterId");n(this,"offset");n(this,"peak");n(this,"cycle");n(this,"weight");this.parameterId=t??null,this.offset=e??0,this.peak=i??0,this.cycle=s??0,this.weight=a??0}}var vr;(function(r){r.BreathParameterData=te,r.CubismBreath=be})(vr||(vr={}));const fe=class fe{constructor(t){n(this,"_blinkingState");n(this,"_parameterIds");n(this,"_nextBlinkingTime");n(this,"_stateStartTimeSeconds");n(this,"_blinkingIntervalSeconds");n(this,"_closingSeconds");n(this,"_closedSeconds");n(this,"_openingSeconds");n(this,"_userTimeSeconds");if(this._blinkingState=ht.EyeState_First,this._nextBlinkingTime=0,this._stateStartTimeSeconds=0,this._blinkingIntervalSeconds=4,this._closingSeconds=.1,this._closedSeconds=.05,this._openingSeconds=.15,this._userTimeSeconds=0,this._parameterIds=new L,t!=null)for(let e=0;e<t.getEyeBlinkParameterCount();++e)this._parameterIds.pushBack(t.getEyeBlinkParameterId(e))}static create(t=null){return new fe(t)}static delete(t){}setBlinkingInterval(t){this._blinkingIntervalSeconds=t}setBlinkingSetting(t,e,i){this._closingSeconds=t,this._closedSeconds=e,this._openingSeconds=i}setParameterIds(t){this._parameterIds=t}getParameterIds(){return this._parameterIds}updateParameters(t,e){this._userTimeSeconds+=e;let i,s=0;switch(this._blinkingState){case ht.EyeState_Closing:s=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closingSeconds,s>=1&&(s=1,this._blinkingState=ht.EyeState_Closed,this._stateStartTimeSeconds=this._userTimeSeconds),i=1-s;break;case ht.EyeState_Closed:s=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._closedSeconds,s>=1&&(this._blinkingState=ht.EyeState_Opening,this._stateStartTimeSeconds=this._userTimeSeconds),i=0;break;case ht.EyeState_Opening:s=(this._userTimeSeconds-this._stateStartTimeSeconds)/this._openingSeconds,s>=1&&(s=1,this._blinkingState=ht.EyeState_Interval,this._nextBlinkingTime=this.determinNextBlinkingTiming()),i=s;break;case ht.EyeState_Interval:this._nextBlinkingTime<this._userTimeSeconds&&(this._blinkingState=ht.EyeState_Closing,this._stateStartTimeSeconds=this._userTimeSeconds),i=1;break;case ht.EyeState_First:default:this._blinkingState=ht.EyeState_Interval,this._nextBlinkingTime=this.determinNextBlinkingTiming(),i=1;break}fe.CloseIfZero||(i=-i);for(let a=0;a<this._parameterIds.getSize();++a)t.setParameterValueById(this._parameterIds.at(a),i)}determinNextBlinkingTiming(){const t=Math.random();return this._userTimeSeconds+t*(2*this._blinkingIntervalSeconds-1)}};n(fe,"CloseIfZero",!0);let Se=fe;var ht;(function(r){r[r.EyeState_First=0]="EyeState_First",r[r.EyeState_Interval=1]="EyeState_Interval",r[r.EyeState_Closing=2]="EyeState_Closing",r[r.EyeState_Closed=3]="EyeState_Closed",r[r.EyeState_Opening=4]="EyeState_Opening"})(ht||(ht={}));var Mr;(function(r){r.CubismEyeBlink=Se,r.EyeState=ht})(Mr||(Mr={}));const Rn=.001,ci=.5,Br="FadeInTime",Pr="Link",Vn="Groups",En="Id";class xe{constructor(){n(this,"_partGroups");n(this,"_partGroupCounts");n(this,"_fadeTimeSeconds");n(this,"_lastModel");this._fadeTimeSeconds=ci,this._lastModel=null,this._partGroups=new L,this._partGroupCounts=new L}static create(t,e){const i=new xe,s=nt.create(t,e),a=s.getRoot();a.getValueByString(Br).isNull()||(i._fadeTimeSeconds=a.getValueByString(Br).toFloat(ci),i._fadeTimeSeconds<=0&&(i._fadeTimeSeconds=ci));const o=a.getValueByString(Vn),l=o.getSize();for(let c=0;c<l;++c){const g=o.getValueByIndex(c),f=g.getSize();let p=0;for(let C=0;C<f;++C){const v=g.getValueByIndex(C),S=new Ce,x=j.getIdManager().getId(v.getValueByString(En).getRawString());if(S.partId=x,!v.getValueByString(Pr).isNull()){const M=v.getValueByString(Pr),D=M.getSize();for(let w=0;w<D;++w){const O=new Ce,U=j.getIdManager().getId(M.getValueByIndex(w).getString());O.partId=U,S.link.pushBack(O)}}i._partGroups.pushBack(S.clone()),++p}i._partGroupCounts.pushBack(p)}return nt.delete(s),i}static delete(t){}updateParameters(t,e){t!=this._lastModel&&this.reset(t),this._lastModel=t,e<0&&(e=0);let i=0;for(let s=0;s<this._partGroupCounts.getSize();s++){const a=this._partGroupCounts.at(s);this.doFade(t,e,i,a),i+=a}this.copyPartOpacities(t)}reset(t){let e=0;for(let i=0;i<this._partGroupCounts.getSize();++i){const s=this._partGroupCounts.at(i);for(let a=e;a<e+s;++a){this._partGroups.at(a).initialize(t);const o=this._partGroups.at(a).partIndex,l=this._partGroups.at(a).parameterIndex;if(!(o<0)){t.setPartOpacityByIndex(o,a==e?1:0),t.setParameterValueByIndex(l,a==e?1:0);for(let c=0;c<this._partGroups.at(a).link.getSize();++c)this._partGroups.at(a).link.at(c).initialize(t)}}e+=s}}copyPartOpacities(t){for(let e=0;e<this._partGroups.getSize();++e){const i=this._partGroups.at(e);if(i.link.getSize()==0)continue;const s=this._partGroups.at(e).partIndex,a=t.getPartOpacityByIndex(s);for(let o=0;o<i.link.getSize();++o){const c=i.link.at(o).partIndex;c<0||t.setPartOpacityByIndex(c,a)}}}doFade(t,e,i,s){let a=-1,o=1;const l=.5,c=.15;for(let g=i;g<i+s;++g){const f=this._partGroups.at(g).partIndex,p=this._partGroups.at(g).parameterIndex;if(t.getParameterValueByIndex(p)>Rn){if(a>=0)break;a=g,o=t.getPartOpacityByIndex(f),o+=e/this._fadeTimeSeconds,o>1&&(o=1)}}a<0&&(a=0,o=1);for(let g=i;g<i+s;++g){const f=this._partGroups.at(g).partIndex;if(a==g)t.setPartOpacityByIndex(f,o);else{let p=t.getPartOpacityByIndex(f),C;o<l?C=o*(l-1)/l+1:C=(1-o)*l/(1-l),(1-C)*(1-o)>c&&(C=1-c/(1-o)),p>C&&(p=C),t.setPartOpacityByIndex(f,p)}}}}class Ce{constructor(t){n(this,"partId");n(this,"parameterIndex");n(this,"partIndex");n(this,"link");if(this.parameterIndex=0,this.partIndex=0,this.link=new L,t!=null){this.partId=t.partId;for(const e=t.link.begin();e.notEqual(t.link.end());e.preIncrement())this.link.pushBack(e.ptr().clone())}}assignment(t){this.partId=t.partId;for(const e=t.link.begin();e.notEqual(t.link.end());e.preIncrement())this.link.pushBack(e.ptr().clone());return this}initialize(t){this.parameterIndex=t.getParameterIndex(this.partId),this.partIndex=t.getPartIndex(this.partId),t.setParameterValueByIndex(this.parameterIndex,1)}clone(){const t=new Ce;t.partId=this.partId,t.parameterIndex=this.parameterIndex,t.partIndex=this.partIndex,t.link=new L;for(let e=this.link.begin();e.notEqual(this.link.end());e.increment())t.link.pushBack(e.ptr().clone());return t}}var br;(function(r){r.CubismPose=xe,r.PartData=Ce})(br||(br={}));class Ts extends et{constructor(e,i){super();n(this,"_width");n(this,"_height");this._width=e!==void 0?e:0,this._height=i!==void 0?i:0,this.setHeight(2)}setWidth(e){const i=e/this._width,s=i;this.scale(i,s)}setHeight(e){const i=e/this._height,s=i;this.scale(i,s)}setPosition(e,i){this.translate(e,i)}setCenterPosition(e,i){this.centerX(e),this.centerY(i)}top(e){this.setY(e)}bottom(e){const i=this._height*this.getScaleY();this.translateY(e-i)}left(e){this.setX(e)}right(e){const i=this._width*this.getScaleX();this.translateX(e-i)}centerX(e){const i=this._width*this.getScaleX();this.translateX(e-i/2)}setX(e){this.translateX(e)}centerY(e){const i=this._height*this.getScaleY();this.translateY(e-i/2)}setY(e){this.translateY(e)}setupFromLayout(e){const i="width",s="height",a="x",o="y",l="center_x",c="center_y",g="top",f="bottom",p="left",C="right";for(const v=e.begin();v.notEqual(e.end());v.preIncrement()){const S=v.ptr().first,x=v.ptr().second;S==i?this.setWidth(x):S==s&&this.setHeight(x)}for(const v=e.begin();v.notEqual(e.end());v.preIncrement()){const S=v.ptr().first,x=v.ptr().second;S==a?this.setX(x):S==o?this.setY(x):S==l?this.centerX(x):S==c?this.centerY(x):S==g?this.top(x):S==f?this.bottom(x):S==p?this.left(x):S==C&&this.right(x)}}}var Ir;(function(r){r.CubismModelMatrix=Ts})(Ir||(Ir={}));class k{constructor(t,e){n(this,"x");n(this,"y");this.x=t,this.y=e,this.x=t??0,this.y=e??0}add(t){const e=new k(0,0);return e.x=this.x+t.x,e.y=this.y+t.y,e}substract(t){const e=new k(0,0);return e.x=this.x-t.x,e.y=this.y-t.y,e}multiply(t){const e=new k(0,0);return e.x=this.x*t.x,e.y=this.y*t.y,e}multiplyByScaler(t){return this.multiply(new k(t,t))}division(t){const e=new k(0,0);return e.x=this.x/t.x,e.y=this.y/t.y,e}divisionByScalar(t){return this.division(new k(t,t))}getLength(){return Math.sqrt(this.x*this.x+this.y*this.y)}getDistanceWith(t){return Math.sqrt((this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y))}dot(t){return this.x*t.x+this.y*t.y}normalize(){const t=Math.pow(this.x*this.x+this.y*this.y,.5);this.x=this.x/t,this.y=this.y/t}isEqual(t){return this.x==t.x&&this.y==t.y}isNotEqual(t){return!this.isEqual(t)}}var wr;(function(r){r.CubismVector2=k})(wr||(wr={}));const ee=class ee{static range(t,e,i){return t<e?t=e:t>i&&(t=i),t}static sin(t){return Math.sin(t)}static cos(t){return Math.cos(t)}static abs(t){return Math.abs(t)}static sqrt(t){return Math.sqrt(t)}static cbrt(t){if(t===0)return t;let e=t;const i=e<0;i&&(e=-e);let s;return e===1/0?s=1/0:(s=Math.exp(Math.log(e)/3),s=(e/(s*s)+2*s)/3),i?-s:s}static getEasingSine(t){return t<0?0:t>1?1:.5-.5*this.cos(t*Math.PI)}static max(t,e){return t>e?t:e}static min(t,e){return t>e?e:t}static degreesToRadian(t){return t/180*Math.PI}static radianToDegrees(t){return t*180/Math.PI}static directionToRadian(t,e){const i=Math.atan2(e.y,e.x),s=Math.atan2(t.y,t.x);let a=i-s;for(;a<-Math.PI;)a+=Math.PI*2;for(;a>Math.PI;)a-=Math.PI*2;return a}static directionToDegrees(t,e){const i=this.directionToRadian(t,e);let s=this.radianToDegrees(i);return e.x-t.x>0&&(s=-s),s}static radianToDirection(t){const e=new k;return e.x=this.sin(t),e.y=this.cos(t),e}static quadraticEquation(t,e,i){return this.abs(t)<ee.Epsilon?this.abs(e)<ee.Epsilon?-i:-i/e:-(e+this.sqrt(e*e-4*t*i))/(2*t)}static cardanoAlgorithmForBezier(t,e,i,s){if(this.sqrt(t)<ee.Epsilon)return this.range(this.quadraticEquation(e,i,s),0,1);const a=e/t,o=i/t,l=s/t,c=(3*o-a*a)/3,g=c/3,f=(2*a*a*a-9*a*o+27*l)/27,p=f/2,C=p*p+g*g*g,v=.5,S=v+.01;if(C<0){const O=-c/3,U=O*O*O,B=this.sqrt(U),I=-f/(2*B),F=this.range(I,-1,1),Y=Math.acos(F),it=2*this.cbrt(B),st=it*this.cos(Y/3)-a/3;if(this.abs(st-v)<S)return this.range(st,0,1);const at=it*this.cos((Y+2*Math.PI)/3)-a/3;if(this.abs(at-v)<S)return this.range(at,0,1);const xt=it*this.cos((Y+4*Math.PI)/3)-a/3;return this.range(xt,0,1)}if(C==0){let O;p<0?O=this.cbrt(-p):O=-this.cbrt(p);const U=2*O-a/3;if(this.abs(U-v)<S)return this.range(U,0,1);const B=-O-a/3;return this.range(B,0,1)}const x=this.sqrt(C),M=this.cbrt(x-p),D=this.cbrt(x+p),w=M-D-a/3;return this.range(w,0,1)}constructor(){}};n(ee,"Epsilon",1e-5);let X=ee;var Tr;(function(r){r.CubismMath=X})(Tr||(Tr={}));const gi=30,Rr=.01;class Rs{constructor(){n(this,"_faceTargetX");n(this,"_faceTargetY");n(this,"_faceX");n(this,"_faceY");n(this,"_faceVX");n(this,"_faceVY");n(this,"_lastTimeSeconds");n(this,"_userTimeSeconds");this._faceTargetX=0,this._faceTargetY=0,this._faceX=0,this._faceY=0,this._faceVX=0,this._faceVY=0,this._lastTimeSeconds=0,this._userTimeSeconds=0}update(t){this._userTimeSeconds+=t;const i=40/10*1/gi;if(this._lastTimeSeconds==0){this._lastTimeSeconds=this._userTimeSeconds;return}const s=(this._userTimeSeconds-this._lastTimeSeconds)*gi;this._lastTimeSeconds=this._userTimeSeconds;const o=.15*gi,l=s*i/o,c=this._faceTargetX-this._faceX,g=this._faceTargetY-this._faceY;if(X.abs(c)<=Rr&&X.abs(g)<=Rr)return;const f=X.sqrt(c*c+g*g),p=i*c/f,C=i*g/f;let v=p-this._faceVX,S=C-this._faceVY;const x=X.sqrt(v*v+S*S);(x<-l||x>l)&&(v*=l/x,S*=l/x),this._faceVX+=v,this._faceVY+=S;{const M=.5*(X.sqrt(l*l+16*l*f-8*l*f)-l),D=X.sqrt(this._faceVX*this._faceVX+this._faceVY*this._faceVY);D>M&&(this._faceVX*=M/D,this._faceVY*=M/D)}this._faceX+=this._faceVX,this._faceY+=this._faceVY}getX(){return this._faceX}getY(){return this._faceY}set(t,e){this._faceTargetX=t,this._faceTargetY=e}}var Vr;(function(r){r.CubismTargetPoint=Rs})(Vr||(Vr={}));class ne{constructor(){n(this,"setFinishedMotionHandler",t=>this._onFinishedMotion=t);n(this,"getFinishedMotionHandler",()=>this._onFinishedMotion);n(this,"_fadeInSeconds");n(this,"_fadeOutSeconds");n(this,"_weight");n(this,"_offsetSeconds");n(this,"_firedEventValues");n(this,"_onFinishedMotion");this._fadeInSeconds=-1,this._fadeOutSeconds=-1,this._weight=1,this._offsetSeconds=0,this._firedEventValues=new L}static delete(t){t.release(),t=null}release(){this._weight=0}updateParameters(t,e,i){if(!e.isAvailable()||e.isFinished())return;if(!e.isStarted()){e.setIsStarted(!0),e.setStartTime(i-this._offsetSeconds),e.setFadeInStartTime(i);const l=this.getDuration();e.getEndTime()<0&&e.setEndTime(l<=0?-1:e.getStartTime()+l)}let s=this._weight;const a=this._fadeInSeconds==0?1:X.getEasingSine((i-e.getFadeInStartTime())/this._fadeInSeconds),o=this._fadeOutSeconds==0||e.getEndTime()<0?1:X.getEasingSine((e.getEndTime()-i)/this._fadeOutSeconds);s=s*a*o,e.setState(i,s),vt(0<=s&&s<=1),this.doUpdateParameters(t,i,s,e),e.getEndTime()>0&&e.getEndTime()<i&&e.setIsFinished(!0)}setFadeInTime(t){this._fadeInSeconds=t}setFadeOutTime(t){this._fadeOutSeconds=t}getFadeOutTime(){return this._fadeOutSeconds}getFadeInTime(){return this._fadeInSeconds}setWeight(t){this._weight=t}getWeight(){return this._weight}getDuration(){return-1}getLoopDuration(){return-1}setOffsetTime(t){this._offsetSeconds=t}getFiredEvent(t,e){return this._firedEventValues}isExistModelOpacity(){return!1}getModelOpacityIndex(){return-1}getModelOpacityId(t){return null}getModelOpacityValue(){return 1}}var Er;(function(r){r.ACubismMotion=ne})(Er||(Er={}));const Fn="FadeInTime",An="FadeOutTime",Fr="Parameters",Dn="Id",Ln="Value",Fe="Blend",On="Add",Nn="Multiply",kn="Overwrite",Ar=1;class Je extends ne{constructor(){super();n(this,"_parameters");this._parameters=new L}static create(e,i){const s=new Je;return s.parse(e,i),s}doUpdateParameters(e,i,s,a){for(let o=0;o<this._parameters.getSize();++o){const l=this._parameters.at(o);switch(l.blendType){case Pt.ExpressionBlendType_Add:{e.addParameterValueById(l.parameterId,l.value,s);break}case Pt.ExpressionBlendType_Multiply:{e.multiplyParameterValueById(l.parameterId,l.value,s);break}case Pt.ExpressionBlendType_Overwrite:{e.setParameterValueById(l.parameterId,l.value,s);break}}}}parse(e,i){const s=nt.create(e,i),a=s.getRoot();this.setFadeInTime(a.getValueByString(Fn).toFloat(Ar)),this.setFadeOutTime(a.getValueByString(An).toFloat(Ar));const o=a.getValueByString(Fr).getSize();this._parameters.prepareCapacity(o);for(let l=0;l<o;++l){const c=a.getValueByString(Fr).getValueByIndex(l),g=j.getIdManager().getId(c.getValueByString(Dn).getRawString()),f=c.getValueByString(Ln).toFloat();let p;c.getValueByString(Fe).isNull()||c.getValueByString(Fe).getString()==On?p=Pt.ExpressionBlendType_Add:c.getValueByString(Fe).getString()==Nn?p=Pt.ExpressionBlendType_Multiply:c.getValueByString(Fe).getString()==kn?p=Pt.ExpressionBlendType_Overwrite:p=Pt.ExpressionBlendType_Add;const C=new Vs;C.parameterId=g,C.blendType=p,C.value=f,this._parameters.pushBack(C)}nt.delete(s)}}var Pt;(function(r){r[r.ExpressionBlendType_Add=0]="ExpressionBlendType_Add",r[r.ExpressionBlendType_Multiply=1]="ExpressionBlendType_Multiply",r[r.ExpressionBlendType_Overwrite=2]="ExpressionBlendType_Overwrite"})(Pt||(Pt={}));class Vs{constructor(){n(this,"parameterId");n(this,"blendType");n(this,"value")}}var Dr;(function(r){r.CubismExpressionMotion=Je,r.ExpressionBlendType=Pt,r.ExpressionParameter=Vs})(Dr||(Dr={}));var dt;(function(r){r[r.CubismMotionCurveTarget_Model=0]="CubismMotionCurveTarget_Model",r[r.CubismMotionCurveTarget_Parameter=1]="CubismMotionCurveTarget_Parameter",r[r.CubismMotionCurveTarget_PartOpacity=2]="CubismMotionCurveTarget_PartOpacity"})(dt||(dt={}));var pt;(function(r){r[r.CubismMotionSegmentType_Linear=0]="CubismMotionSegmentType_Linear",r[r.CubismMotionSegmentType_Bezier=1]="CubismMotionSegmentType_Bezier",r[r.CubismMotionSegmentType_Stepped=2]="CubismMotionSegmentType_Stepped",r[r.CubismMotionSegmentType_InverseStepped=3]="CubismMotionSegmentType_InverseStepped"})(pt||(pt={}));class wi{constructor(){n(this,"time",0);n(this,"value",0)}}class Es{constructor(){n(this,"evaluate");n(this,"basePointIndex");n(this,"segmentType");this.evaluate=null,this.basePointIndex=0,this.segmentType=0}}class Fs{constructor(){n(this,"type");n(this,"id");n(this,"segmentCount");n(this,"baseSegmentIndex");n(this,"fadeInTime");n(this,"fadeOutTime");this.type=dt.CubismMotionCurveTarget_Model,this.segmentCount=0,this.baseSegmentIndex=0,this.fadeInTime=0,this.fadeOutTime=0}}class As{constructor(){n(this,"fireTime",0);n(this,"value")}}class Ds{constructor(){n(this,"duration");n(this,"loop");n(this,"curveCount");n(this,"eventCount");n(this,"fps");n(this,"curves");n(this,"segments");n(this,"points");n(this,"events");this.duration=0,this.loop=!1,this.curveCount=0,this.eventCount=0,this.fps=0,this.curves=new L,this.segments=new L,this.points=new L,this.events=new L}}var Lr;(function(r){r.CubismMotionCurve=Fs,r.CubismMotionCurveTarget=dt,r.CubismMotionData=Ds,r.CubismMotionEvent=As,r.CubismMotionPoint=wi,r.CubismMotionSegment=Es,r.CubismMotionSegmentType=pt})(Lr||(Lr={}));const gt="Meta",Un="Duration",zn="Loop",Xn="AreBeziersRestricted",Yn="CurveCount",Gn="Fps",jn="TotalSegmentCount",Hn="TotalPointCount",Dt="Curves",Wn="Target",$n="Id",Ae="FadeInTime",De="FadeOutTime",Or="Segments",Nr="UserData",qn="UserDataCount",Jn="TotalUserDataSize",Kn="Time",Zn="Value";class Ls{constructor(t,e){n(this,"_json");this._json=nt.create(t,e)}release(){nt.delete(this._json)}getMotionDuration(){return this._json.getRoot().getValueByString(gt).getValueByString(Un).toFloat()}isMotionLoop(){return this._json.getRoot().getValueByString(gt).getValueByString(zn).toBoolean()}getEvaluationOptionFlag(t){return He.EvaluationOptionFlag_AreBeziersRistricted==t?this._json.getRoot().getValueByString(gt).getValueByString(Xn).toBoolean():!1}getMotionCurveCount(){return this._json.getRoot().getValueByString(gt).getValueByString(Yn).toInt()}getMotionFps(){return this._json.getRoot().getValueByString(gt).getValueByString(Gn).toFloat()}getMotionTotalSegmentCount(){return this._json.getRoot().getValueByString(gt).getValueByString(jn).toInt()}getMotionTotalPointCount(){return this._json.getRoot().getValueByString(gt).getValueByString(Hn).toInt()}isExistMotionFadeInTime(){return!this._json.getRoot().getValueByString(gt).getValueByString(Ae).isNull()}isExistMotionFadeOutTime(){return!this._json.getRoot().getValueByString(gt).getValueByString(De).isNull()}getMotionFadeInTime(){return this._json.getRoot().getValueByString(gt).getValueByString(Ae).toFloat()}getMotionFadeOutTime(){return this._json.getRoot().getValueByString(gt).getValueByString(De).toFloat()}getMotionCurveTarget(t){return this._json.getRoot().getValueByString(Dt).getValueByIndex(t).getValueByString(Wn).getRawString()}getMotionCurveId(t){return j.getIdManager().getId(this._json.getRoot().getValueByString(Dt).getValueByIndex(t).getValueByString($n).getRawString())}isExistMotionCurveFadeInTime(t){return!this._json.getRoot().getValueByString(Dt).getValueByIndex(t).getValueByString(Ae).isNull()}isExistMotionCurveFadeOutTime(t){return!this._json.getRoot().getValueByString(Dt).getValueByIndex(t).getValueByString(De).isNull()}getMotionCurveFadeInTime(t){return this._json.getRoot().getValueByString(Dt).getValueByIndex(t).getValueByString(Ae).toFloat()}getMotionCurveFadeOutTime(t){return this._json.getRoot().getValueByString(Dt).getValueByIndex(t).getValueByString(De).toFloat()}getMotionCurveSegmentCount(t){return this._json.getRoot().getValueByString(Dt).getValueByIndex(t).getValueByString(Or).getVector().getSize()}getMotionCurveSegment(t,e){return this._json.getRoot().getValueByString(Dt).getValueByIndex(t).getValueByString(Or).getValueByIndex(e).toFloat()}getEventCount(){return this._json.getRoot().getValueByString(gt).getValueByString(qn).toInt()}getTotalEventValueSize(){return this._json.getRoot().getValueByString(gt).getValueByString(Jn).toInt()}getEventTime(t){return this._json.getRoot().getValueByString(Nr).getValueByIndex(t).getValueByString(Kn).toFloat()}getEventValue(t){return new St(this._json.getRoot().getValueByString(Nr).getValueByIndex(t).getValueByString(Zn).getRawString())}}var He;(function(r){r[r.EvaluationOptionFlag_AreBeziersRistricted=0]="EvaluationOptionFlag_AreBeziersRistricted"})(He||(He={}));var kr;(function(r){r.CubismMotionJson=Ls})(kr||(kr={}));const Qn="EyeBlink",to="LipSync",eo="Model",io="Parameter",ro="PartOpacity",Le="Opacity",so=!1;function yt(r,t,e){const i=new wi;return i.time=r.time+(t.time-r.time)*e,i.value=r.value+(t.value-r.value)*e,i}function ao(r,t){let e=(t-r[0].time)/(r[1].time-r[0].time);return e<0&&(e=0),r[0].value+(r[1].value-r[0].value)*e}function no(r,t){let e=(t-r[0].time)/(r[3].time-r[0].time);e<0&&(e=0);const i=yt(r[0],r[1],e),s=yt(r[1],r[2],e),a=yt(r[2],r[3],e),o=yt(i,s,e),l=yt(s,a,e);return yt(o,l,e).value}function oo(r,t){const e=t,i=r[0].time,s=r[3].time,a=r[1].time,o=r[2].time,l=s-3*o+3*a-i,c=3*o-6*a+3*i,g=3*a-3*i,f=i-e,p=X.cardanoAlgorithmForBezier(l,c,g,f),C=yt(r[0],r[1],p),v=yt(r[1],r[2],p),S=yt(r[2],r[3],p),x=yt(C,v,p),M=yt(v,S,p);return yt(x,M,p).value}function lo(r,t){return r[0].value}function uo(r,t){return r[1].value}function di(r,t,e){const i=r.curves.at(t);let s=-1;const a=i.baseSegmentIndex+i.segmentCount;let o=0;for(let c=i.baseSegmentIndex;c<a;++c)if(o=r.segments.at(c).basePointIndex+(r.segments.at(c).segmentType==pt.CubismMotionSegmentType_Bezier?3:1),r.points.at(o).time>e){s=c;break}if(s==-1)return r.points.at(o).value;const l=r.segments.at(s);return l.evaluate(r.points.get(l.basePointIndex),e)}class Ke extends ne{constructor(){super();n(this,"_sourceFrameRate");n(this,"_loopDurationSeconds");n(this,"_isLoop");n(this,"_isLoopFadeIn");n(this,"_lastWeight");n(this,"_motionData");n(this,"_eyeBlinkParameterIds");n(this,"_lipSyncParameterIds");n(this,"_modelCurveIdEyeBlink");n(this,"_modelCurveIdLipSync");n(this,"_modelCurveIdOpacity");n(this,"_modelOpacity");this._sourceFrameRate=30,this._loopDurationSeconds=-1,this._isLoop=!1,this._isLoopFadeIn=!0,this._lastWeight=0,this._motionData=null,this._modelCurveIdEyeBlink=null,this._modelCurveIdLipSync=null,this._modelCurveIdOpacity=null,this._eyeBlinkParameterIds=null,this._lipSyncParameterIds=null,this._modelOpacity=1}static create(e,i,s){const a=new Ke;return a.parse(e,i),a._sourceFrameRate=a._motionData.fps,a._loopDurationSeconds=a._motionData.duration,a._onFinishedMotion=s,a}doUpdateParameters(e,i,s,a){this._modelCurveIdEyeBlink==null&&(this._modelCurveIdEyeBlink=j.getIdManager().getId(Qn)),this._modelCurveIdLipSync==null&&(this._modelCurveIdLipSync=j.getIdManager().getId(to)),this._modelCurveIdOpacity==null&&(this._modelCurveIdOpacity=j.getIdManager().getId(Le));let o=i-a.getStartTime();o<0&&(o=0);let l=Number.MAX_VALUE,c=Number.MAX_VALUE;const g=64;let f=0,p=0;this._eyeBlinkParameterIds.getSize()>g&&pe("too many eye blink targets : {0}",this._eyeBlinkParameterIds.getSize()),this._lipSyncParameterIds.getSize()>g&&pe("too many lip sync targets : {0}",this._lipSyncParameterIds.getSize());const C=this._fadeInSeconds<=0?1:X.getEasingSine((i-a.getFadeInStartTime())/this._fadeInSeconds),v=this._fadeOutSeconds<=0||a.getEndTime()<0?1:X.getEasingSine((a.getEndTime()-i)/this._fadeOutSeconds);let S,x,M,D=o;if(this._isLoop)for(;D>this._motionData.duration;)D-=this._motionData.duration;const w=this._motionData.curves;for(x=0;x<this._motionData.curveCount&&w.at(x).type==dt.CubismMotionCurveTarget_Model;++x)S=di(this._motionData,x,D),w.at(x).id==this._modelCurveIdEyeBlink?c=S:w.at(x).id==this._modelCurveIdLipSync?l=S:w.at(x).id==this._modelCurveIdOpacity&&(this._modelOpacity=S,e.setModelOapcity(this.getModelOpacityValue()));for(;x<this._motionData.curveCount&&w.at(x).type==dt.CubismMotionCurveTarget_Parameter;++x){if(M=e.getParameterIndex(w.at(x).id),M==-1)continue;const O=e.getParameterValueByIndex(M);if(S=di(this._motionData,x,D),c!=Number.MAX_VALUE){for(let B=0;B<this._eyeBlinkParameterIds.getSize()&&B<g;++B)if(this._eyeBlinkParameterIds.at(B)==w.at(x).id){S*=c,p|=1<<B;break}}if(l!=Number.MAX_VALUE){for(let B=0;B<this._lipSyncParameterIds.getSize()&&B<g;++B)if(this._lipSyncParameterIds.at(B)==w.at(x).id){S+=l,f|=1<<B;break}}let U;if(w.at(x).fadeInTime<0&&w.at(x).fadeOutTime<0)U=O+(S-O)*s;else{let B,I;w.at(x).fadeInTime<0?B=C:B=w.at(x).fadeInTime==0?1:X.getEasingSine((i-a.getFadeInStartTime())/w.at(x).fadeInTime),w.at(x).fadeOutTime<0?I=v:I=w.at(x).fadeOutTime==0||a.getEndTime()<0?1:X.getEasingSine((a.getEndTime()-i)/w.at(x).fadeOutTime);const F=this._weight*B*I;U=O+(S-O)*F}e.setParameterValueByIndex(M,U,1)}{if(c!=Number.MAX_VALUE)for(let O=0;O<this._eyeBlinkParameterIds.getSize()&&O<g;++O){const U=e.getParameterValueById(this._eyeBlinkParameterIds.at(O));if(p>>O&1)continue;const B=U+(c-U)*s;e.setParameterValueById(this._eyeBlinkParameterIds.at(O),B)}if(l!=Number.MAX_VALUE)for(let O=0;O<this._lipSyncParameterIds.getSize()&&O<g;++O){const U=e.getParameterValueById(this._lipSyncParameterIds.at(O));if(f>>O&1)continue;const B=U+(l-U)*s;e.setParameterValueById(this._lipSyncParameterIds.at(O),B)}}for(;x<this._motionData.curveCount&&w.at(x).type==dt.CubismMotionCurveTarget_PartOpacity;++x)M=e.getParameterIndex(w.at(x).id),M!=-1&&(S=di(this._motionData,x,D),e.setParameterValueByIndex(M,S));o>=this._motionData.duration&&(this._isLoop?(a.setStartTime(i),this._isLoopFadeIn&&a.setFadeInStartTime(i)):(this._onFinishedMotion&&this._onFinishedMotion(this),a.setIsFinished(!0))),this._lastWeight=s}setIsLoop(e){this._isLoop=e}isLoop(){return this._isLoop}setIsLoopFadeIn(e){this._isLoopFadeIn=e}isLoopFadeIn(){return this._isLoopFadeIn}getDuration(){return this._isLoop?-1:this._loopDurationSeconds}getLoopDuration(){return this._loopDurationSeconds}setParameterFadeInTime(e,i){const s=this._motionData.curves;for(let a=0;a<this._motionData.curveCount;++a)if(e==s.at(a).id){s.at(a).fadeInTime=i;return}}setParameterFadeOutTime(e,i){const s=this._motionData.curves;for(let a=0;a<this._motionData.curveCount;++a)if(e==s.at(a).id){s.at(a).fadeOutTime=i;return}}getParameterFadeInTime(e){const i=this._motionData.curves;for(let s=0;s<this._motionData.curveCount;++s)if(e==i.at(s).id)return i.at(s).fadeInTime;return-1}getParameterFadeOutTime(e){const i=this._motionData.curves;for(let s=0;s<this._motionData.curveCount;++s)if(e==i.at(s).id)return i.at(s).fadeOutTime;return-1}setEffectIds(e,i){this._eyeBlinkParameterIds=e,this._lipSyncParameterIds=i}release(){this._motionData=void 0,this._motionData=null}parse(e,i){this._motionData=new Ds;let s=new Ls(e,i);this._motionData.duration=s.getMotionDuration(),this._motionData.loop=s.isMotionLoop(),this._motionData.curveCount=s.getMotionCurveCount(),this._motionData.fps=s.getMotionFps(),this._motionData.eventCount=s.getEventCount();const a=s.getEvaluationOptionFlag(He.EvaluationOptionFlag_AreBeziersRistricted);s.isExistMotionFadeInTime()?this._fadeInSeconds=s.getMotionFadeInTime()<0?1:s.getMotionFadeInTime():this._fadeInSeconds=1,s.isExistMotionFadeOutTime()?this._fadeOutSeconds=s.getMotionFadeOutTime()<0?1:s.getMotionFadeOutTime():this._fadeOutSeconds=1,this._motionData.curves.updateSize(this._motionData.curveCount,Fs,!0),this._motionData.segments.updateSize(s.getMotionTotalSegmentCount(),Es,!0),this._motionData.points.updateSize(s.getMotionTotalPointCount(),wi,!0),this._motionData.events.updateSize(this._motionData.eventCount,As,!0);let o=0,l=0;for(let c=0;c<this._motionData.curveCount;++c){s.getMotionCurveTarget(c)==eo?this._motionData.curves.at(c).type=dt.CubismMotionCurveTarget_Model:s.getMotionCurveTarget(c)==io?this._motionData.curves.at(c).type=dt.CubismMotionCurveTarget_Parameter:s.getMotionCurveTarget(c)==ro?this._motionData.curves.at(c).type=dt.CubismMotionCurveTarget_PartOpacity:Lt('Warning : Unable to get segment type from Curve! The number of "CurveCount" may be incorrect!'),this._motionData.curves.at(c).id=s.getMotionCurveId(c),this._motionData.curves.at(c).baseSegmentIndex=l,this._motionData.curves.at(c).fadeInTime=s.isExistMotionCurveFadeInTime(c)?s.getMotionCurveFadeInTime(c):-1,this._motionData.curves.at(c).fadeOutTime=s.isExistMotionCurveFadeOutTime(c)?s.getMotionCurveFadeOutTime(c):-1;for(let g=0;g<s.getMotionCurveSegmentCount(c);){switch(g==0?(this._motionData.segments.at(l).basePointIndex=o,this._motionData.points.at(o).time=s.getMotionCurveSegment(c,g),this._motionData.points.at(o).value=s.getMotionCurveSegment(c,g+1),o+=1,g+=2):this._motionData.segments.at(l).basePointIndex=o-1,s.getMotionCurveSegment(c,g)){case pt.CubismMotionSegmentType_Linear:{this._motionData.segments.at(l).segmentType=pt.CubismMotionSegmentType_Linear,this._motionData.segments.at(l).evaluate=ao,this._motionData.points.at(o).time=s.getMotionCurveSegment(c,g+1),this._motionData.points.at(o).value=s.getMotionCurveSegment(c,g+2),o+=1,g+=3;break}case pt.CubismMotionSegmentType_Bezier:{this._motionData.segments.at(l).segmentType=pt.CubismMotionSegmentType_Bezier,a||so?this._motionData.segments.at(l).evaluate=no:this._motionData.segments.at(l).evaluate=oo,this._motionData.points.at(o).time=s.getMotionCurveSegment(c,g+1),this._motionData.points.at(o).value=s.getMotionCurveSegment(c,g+2),this._motionData.points.at(o+1).time=s.getMotionCurveSegment(c,g+3),this._motionData.points.at(o+1).value=s.getMotionCurveSegment(c,g+4),this._motionData.points.at(o+2).time=s.getMotionCurveSegment(c,g+5),this._motionData.points.at(o+2).value=s.getMotionCurveSegment(c,g+6),o+=3,g+=7;break}case pt.CubismMotionSegmentType_Stepped:{this._motionData.segments.at(l).segmentType=pt.CubismMotionSegmentType_Stepped,this._motionData.segments.at(l).evaluate=lo,this._motionData.points.at(o).time=s.getMotionCurveSegment(c,g+1),this._motionData.points.at(o).value=s.getMotionCurveSegment(c,g+2),o+=1,g+=3;break}case pt.CubismMotionSegmentType_InverseStepped:{this._motionData.segments.at(l).segmentType=pt.CubismMotionSegmentType_InverseStepped,this._motionData.segments.at(l).evaluate=uo,this._motionData.points.at(o).time=s.getMotionCurveSegment(c,g+1),this._motionData.points.at(o).value=s.getMotionCurveSegment(c,g+2),o+=1,g+=3;break}default:{vt(0);break}}++this._motionData.curves.at(c).segmentCount,++l}}for(let c=0;c<s.getEventCount();++c)this._motionData.events.at(c).fireTime=s.getEventTime(c),this._motionData.events.at(c).value=s.getEventValue(c);s.release(),s=void 0,s=null}getFiredEvent(e,i){this._firedEventValues.updateSize(0);for(let s=0;s<this._motionData.eventCount;++s)this._motionData.events.at(s).fireTime>e&&this._motionData.events.at(s).fireTime<=i&&this._firedEventValues.pushBack(new St(this._motionData.events.at(s).value.s));return this._firedEventValues}isExistModelOpacity(){for(let e=0;e<this._motionData.curveCount;e++){const i=this._motionData.curves.at(e);if(i.type==dt.CubismMotionCurveTarget_Model&&i.id.getString().s.localeCompare(Le)==0)return!0}return!1}getModelOpacityIndex(){if(this.isExistModelOpacity())for(let e=0;e<this._motionData.curveCount;e++){const i=this._motionData.curves.at(e);if(i.type==dt.CubismMotionCurveTarget_Model&&i.id.getString().s.localeCompare(Le)==0)return e}return-1}getModelOpacityId(e){if(e!=-1){const i=this._motionData.curves.at(e);if(i.type==dt.CubismMotionCurveTarget_Model&&i.id.getString().s.localeCompare(Le)==0)return j.getIdManager().getId(i.id.getString().s)}return null}getModelOpacityValue(){return this._modelOpacity}}var Ur;(function(r){r.CubismMotion=Ke})(Ur||(Ur={}));class Os{constructor(){n(this,"_autoDelete");n(this,"_motion");n(this,"_available");n(this,"_finished");n(this,"_started");n(this,"_startTimeSeconds");n(this,"_fadeInStartTimeSeconds");n(this,"_endTimeSeconds");n(this,"_stateTimeSeconds");n(this,"_stateWeight");n(this,"_lastEventCheckSeconds");n(this,"_fadeOutSeconds");n(this,"_isTriggeredFadeOut");n(this,"_motionQueueEntryHandle");this._autoDelete=!1,this._motion=null,this._available=!0,this._finished=!1,this._started=!1,this._startTimeSeconds=-1,this._fadeInStartTimeSeconds=0,this._endTimeSeconds=-1,this._stateTimeSeconds=0,this._stateWeight=0,this._lastEventCheckSeconds=0,this._motionQueueEntryHandle=this,this._fadeOutSeconds=0,this._isTriggeredFadeOut=!1}release(){this._autoDelete&&this._motion&&ne.delete(this._motion)}setFadeOut(t){this._fadeOutSeconds=t,this._isTriggeredFadeOut=!0}startFadeOut(t,e){const i=e+t;this._isTriggeredFadeOut=!0,(this._endTimeSeconds<0||i<this._endTimeSeconds)&&(this._endTimeSeconds=i)}isFinished(){return this._finished}isStarted(){return this._started}getStartTime(){return this._startTimeSeconds}getFadeInStartTime(){return this._fadeInStartTimeSeconds}getEndTime(){return this._endTimeSeconds}setStartTime(t){this._startTimeSeconds=t}setFadeInStartTime(t){this._fadeInStartTimeSeconds=t}setEndTime(t){this._endTimeSeconds=t}setIsFinished(t){this._finished=t}setIsStarted(t){this._started=t}isAvailable(){return this._available}setIsAvailable(t){this._available=t}setState(t,e){this._stateTimeSeconds=t,this._stateWeight=e}getStateTime(){return this._stateTimeSeconds}getStateWeight(){return this._stateWeight}getLastCheckEventSeconds(){return this._lastEventCheckSeconds}setLastCheckEventSeconds(t){this._lastEventCheckSeconds=t}isTriggeredFadeOut(){return this._isTriggeredFadeOut}getFadeOutSeconds(){return this._fadeOutSeconds}}var zr;(function(r){r.CubismMotionQueueEntry=Os})(zr||(zr={}));class Ns{constructor(){n(this,"_userTimeSeconds");n(this,"_motions");n(this,"_eventCallBack");n(this,"_eventCustomData");this._userTimeSeconds=0,this._eventCallBack=null,this._eventCustomData=null,this._motions=new L}release(){for(let t=0;t<this._motions.getSize();++t)this._motions.at(t)&&(this._motions.at(t).release(),this._motions.set(t,null));this._motions=null}startMotion(t,e,i){if(t==null)return We;let s=null;for(let a=0;a<this._motions.getSize();++a)s=this._motions.at(a),s!=null&&s.setFadeOut(s._motion.getFadeOutTime());return s=new Os,s._autoDelete=e,s._motion=t,this._motions.pushBack(s),s._motionQueueEntryHandle}isFinished(){for(let t=this._motions.begin();t.notEqual(this._motions.end());){let e=t.ptr();if(e==null){t=this._motions.erase(t);continue}if(e._motion==null){e.release(),e=null,t=this._motions.erase(t);continue}if(e.isFinished())t.preIncrement();else return!1}return!0}isFinishedByHandle(t){for(let e=this._motions.begin();e.notEqual(this._motions.end());e.increment()){const i=e.ptr();if(i!=null&&i._motionQueueEntryHandle==t&&!i.isFinished())return!1}return!0}stopAllMotions(){for(let t=this._motions.begin();t.notEqual(this._motions.end());){let e=t.ptr();if(e==null){t=this._motions.erase(t);continue}e.release(),e=null,t=this._motions.erase(t)}}getCubismMotionQueueEntry(t){for(let e=this._motions.begin();e.notEqual(this._motions.end());e.preIncrement()){const i=e.ptr();if(i!=null&&i._motionQueueEntryHandle==t)return i}return null}setEventCallback(t,e=null){this._eventCallBack=t,this._eventCustomData=e}doUpdateMotion(t,e){let i=!1;for(let s=this._motions.begin();s.notEqual(this._motions.end());){let a=s.ptr();if(a==null){s=this._motions.erase(s);continue}const o=a._motion;if(o==null){a.release(),a=null,s=this._motions.erase(s);continue}o.updateParameters(t,a,e),i=!0;const l=o.getFiredEvent(a.getLastCheckEventSeconds()-a.getStartTime(),e-a.getStartTime());for(let c=0;c<l.getSize();++c)this._eventCallBack(this,l.at(c),this._eventCustomData);a.setLastCheckEventSeconds(e),a.isFinished()?(a.release(),a=null,s=this._motions.erase(s)):(a.isTriggeredFadeOut()&&a.startFadeOut(a.getFadeOutSeconds(),e),s.preIncrement())}return i}}const We=-1;var Xr;(function(r){r.CubismMotionQueueManager=Ns,r.InvalidMotionQueueEntryHandleValue=We})(Xr||(Xr={}));class Ci extends Ns{constructor(){super();n(this,"_currentPriority");n(this,"_reservePriority");this._currentPriority=0,this._reservePriority=0}getCurrentPriority(){return this._currentPriority}getReservePriority(){return this._reservePriority}setReservePriority(e){this._reservePriority=e}startMotionPriority(e,i,s){return s==this._reservePriority&&(this._reservePriority=0),this._currentPriority=s,super.startMotion(e,i,this._userTimeSeconds)}updateMotion(e,i){this._userTimeSeconds+=i;const s=super.doUpdateMotion(e,this._userTimeSeconds);return this.isFinished()&&(this._currentPriority=0),s}reserveMotion(e){return e<=this._reservePriority||e<=this._currentPriority?!1:(this._reservePriority=e,!0)}}var Yr;(function(r){r.CubismMotionManager=Ci})(Yr||(Yr={}));var ve;(function(r){r[r.CubismPhysicsTargetType_Parameter=0]="CubismPhysicsTargetType_Parameter"})(ve||(ve={}));var Tt;(function(r){r[r.CubismPhysicsSource_X=0]="CubismPhysicsSource_X",r[r.CubismPhysicsSource_Y=1]="CubismPhysicsSource_Y",r[r.CubismPhysicsSource_Angle=2]="CubismPhysicsSource_Angle"})(Tt||(Tt={}));class ho{constructor(){n(this,"gravity");n(this,"wind");this.gravity=new k(0,0),this.wind=new k(0,0)}}class Ti{constructor(){n(this,"id");n(this,"targetType")}}class vi{constructor(){n(this,"minimum");n(this,"maximum");n(this,"defalut")}}class ks{constructor(){n(this,"initialPosition");n(this,"mobility");n(this,"delay");n(this,"acceleration");n(this,"radius");n(this,"position");n(this,"lastPosition");n(this,"lastGravity");n(this,"force");n(this,"velocity");this.initialPosition=new k(0,0),this.position=new k(0,0),this.lastPosition=new k(0,0),this.lastGravity=new k(0,0),this.force=new k(0,0),this.velocity=new k(0,0)}}class Us{constructor(){n(this,"inputCount");n(this,"outputCount");n(this,"particleCount");n(this,"baseInputIndex");n(this,"baseOutputIndex");n(this,"baseParticleIndex");n(this,"normalizationPosition");n(this,"normalizationAngle");this.normalizationPosition=new vi,this.normalizationAngle=new vi}}class zs{constructor(){n(this,"source");n(this,"sourceParameterIndex");n(this,"weight");n(this,"type");n(this,"reflect");n(this,"getNormalizedParameterValue");this.source=new Ti}}class Xs{constructor(){n(this,"destination");n(this,"destinationParameterIndex");n(this,"vertexIndex");n(this,"translationScale");n(this,"angleScale");n(this,"weight");n(this,"type");n(this,"reflect");n(this,"valueBelowMinimum");n(this,"valueExceededMaximum");n(this,"getValue");n(this,"getScale");this.destination=new Ti,this.translationScale=new k(0,0)}}class Ys{constructor(){n(this,"subRigCount");n(this,"settings");n(this,"inputs");n(this,"outputs");n(this,"particles");n(this,"gravity");n(this,"wind");n(this,"fps");this.settings=new L,this.inputs=new L,this.outputs=new L,this.particles=new L,this.gravity=new k(0,0),this.wind=new k(0,0),this.fps=0}}var Gr;(function(r){r.CubismPhysicsInput=zs,r.CubismPhysicsNormalization=vi,r.CubismPhysicsOutput=Xs,r.CubismPhysicsParameter=Ti,r.CubismPhysicsParticle=ks,r.CubismPhysicsRig=Ys,r.CubismPhysicsSource=Tt,r.CubismPhysicsSubRig=Us,r.CubismPhysicsTargetType=ve,r.PhysicsJsonEffectiveForces=ho})(Gr||(Gr={}));const ce="Position",_i="X",fi="Y",mi="Angle",jr="Type",Hr="Id",It="Meta",Oe="EffectiveForces",co="TotalInputCount",go="TotalOutputCount",_o="PhysicsSettingCount",Wr="Gravity",$r="Wind",fo="VertexCount",mo="Fps",Z="PhysicsSettings",Kt="Normalization",qr="Minimum",Jr="Maximum",Kr="Default",Zr="Reflect",Qr="Weight",ge="Input",po="Source",kt="Output",yo="Scale",So="VertexIndex",xo="Destination",Ut="Vertices",Co="Mobility",vo="Delay",Mo="Radius",Bo="Acceleration";class Gs{constructor(t,e){n(this,"_json");this._json=nt.create(t,e)}release(){nt.delete(this._json)}getGravity(){const t=new k(0,0);return t.x=this._json.getRoot().getValueByString(It).getValueByString(Oe).getValueByString(Wr).getValueByString(_i).toFloat(),t.y=this._json.getRoot().getValueByString(It).getValueByString(Oe).getValueByString(Wr).getValueByString(fi).toFloat(),t}getWind(){const t=new k(0,0);return t.x=this._json.getRoot().getValueByString(It).getValueByString(Oe).getValueByString($r).getValueByString(_i).toFloat(),t.y=this._json.getRoot().getValueByString(It).getValueByString(Oe).getValueByString($r).getValueByString(fi).toFloat(),t}getFps(){return this._json.getRoot().getValueByString(It).getValueByString(mo).toFloat(0)}getSubRigCount(){return this._json.getRoot().getValueByString(It).getValueByString(_o).toInt()}getTotalInputCount(){return this._json.getRoot().getValueByString(It).getValueByString(co).toInt()}getTotalOutputCount(){return this._json.getRoot().getValueByString(It).getValueByString(go).toInt()}getVertexCount(){return this._json.getRoot().getValueByString(It).getValueByString(fo).toInt()}getNormalizationPositionMinimumValue(t){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Kt).getValueByString(ce).getValueByString(qr).toFloat()}getNormalizationPositionMaximumValue(t){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Kt).getValueByString(ce).getValueByString(Jr).toFloat()}getNormalizationPositionDefaultValue(t){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Kt).getValueByString(ce).getValueByString(Kr).toFloat()}getNormalizationAngleMinimumValue(t){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Kt).getValueByString(mi).getValueByString(qr).toFloat()}getNormalizationAngleMaximumValue(t){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Kt).getValueByString(mi).getValueByString(Jr).toFloat()}getNormalizationAngleDefaultValue(t){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Kt).getValueByString(mi).getValueByString(Kr).toFloat()}getInputCount(t){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(ge).getVector().getSize()}getInputWeight(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(ge).getValueByIndex(e).getValueByString(Qr).toFloat()}getInputReflect(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(ge).getValueByIndex(e).getValueByString(Zr).toBoolean()}getInputType(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(ge).getValueByIndex(e).getValueByString(jr).getRawString()}getInputSourceId(t,e){return j.getIdManager().getId(this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(ge).getValueByIndex(e).getValueByString(po).getValueByString(Hr).getRawString())}getOutputCount(t){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(kt).getVector().getSize()}getOutputVertexIndex(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(kt).getValueByIndex(e).getValueByString(So).toInt()}getOutputAngleScale(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(kt).getValueByIndex(e).getValueByString(yo).toFloat()}getOutputWeight(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(kt).getValueByIndex(e).getValueByString(Qr).toFloat()}getOutputDestinationId(t,e){return j.getIdManager().getId(this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(kt).getValueByIndex(e).getValueByString(xo).getValueByString(Hr).getRawString())}getOutputType(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(kt).getValueByIndex(e).getValueByString(jr).getRawString()}getOutputReflect(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(kt).getValueByIndex(e).getValueByString(Zr).toBoolean()}getParticleCount(t){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Ut).getVector().getSize()}getParticleMobility(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Ut).getValueByIndex(e).getValueByString(Co).toFloat()}getParticleDelay(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Ut).getValueByIndex(e).getValueByString(vo).toFloat()}getParticleAcceleration(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Ut).getValueByIndex(e).getValueByString(Bo).toFloat()}getParticleRadius(t,e){return this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Ut).getValueByIndex(e).getValueByString(Mo).toFloat()}getParticlePosition(t,e){const i=new k(0,0);return i.x=this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Ut).getValueByIndex(e).getValueByString(ce).getValueByString(_i).toFloat(),i.y=this._json.getRoot().getValueByString(Z).getValueByIndex(t).getValueByString(Ut).getValueByIndex(e).getValueByString(ce).getValueByString(fi).toFloat(),i}}var ts;(function(r){r.CubismPhysicsJson=Gs})(ts||(ts={}));const es="X",is="Y",rs="Angle",Po=5,Mi=100,ss=.001,bo=5;class Me{constructor(){n(this,"_physicsRig");n(this,"_options");n(this,"_currentRigOutputs");n(this,"_previousRigOutputs");n(this,"_currentRemainTime");n(this,"_parameterCaches");n(this,"_parameterInputCaches");this._physicsRig=null,this._options=new js,this._options.gravity.y=-1,this._options.gravity.x=0,this._options.wind.x=0,this._options.wind.y=0,this._currentRigOutputs=new L,this._previousRigOutputs=new L,this._currentRemainTime=0,this._parameterCaches=null,this._parameterInputCaches=null}static create(t,e){const i=new Me;return i.parse(t,e),i._physicsRig.gravity.y=0,i}static delete(t){t!=null&&(t.release(),t=null)}parse(t,e){this._physicsRig=new Ys;let i=new Gs(t,e);this._physicsRig.gravity=i.getGravity(),this._physicsRig.wind=i.getWind(),this._physicsRig.subRigCount=i.getSubRigCount(),this._physicsRig.fps=i.getFps(),this._physicsRig.settings.updateSize(this._physicsRig.subRigCount,Us,!0),this._physicsRig.inputs.updateSize(i.getTotalInputCount(),zs,!0),this._physicsRig.outputs.updateSize(i.getTotalOutputCount(),Xs,!0),this._physicsRig.particles.updateSize(i.getVertexCount(),ks,!0),this._currentRigOutputs.clear(),this._previousRigOutputs.clear();let s=0,a=0,o=0;for(let l=0;l<this._physicsRig.settings.getSize();++l){this._physicsRig.settings.at(l).normalizationPosition.minimum=i.getNormalizationPositionMinimumValue(l),this._physicsRig.settings.at(l).normalizationPosition.maximum=i.getNormalizationPositionMaximumValue(l),this._physicsRig.settings.at(l).normalizationPosition.defalut=i.getNormalizationPositionDefaultValue(l),this._physicsRig.settings.at(l).normalizationAngle.minimum=i.getNormalizationAngleMinimumValue(l),this._physicsRig.settings.at(l).normalizationAngle.maximum=i.getNormalizationAngleMaximumValue(l),this._physicsRig.settings.at(l).normalizationAngle.defalut=i.getNormalizationAngleDefaultValue(l),this._physicsRig.settings.at(l).inputCount=i.getInputCount(l),this._physicsRig.settings.at(l).baseInputIndex=s;for(let f=0;f<this._physicsRig.settings.at(l).inputCount;++f)this._physicsRig.inputs.at(s+f).sourceParameterIndex=-1,this._physicsRig.inputs.at(s+f).weight=i.getInputWeight(l,f),this._physicsRig.inputs.at(s+f).reflect=i.getInputReflect(l,f),i.getInputType(l,f)==es?(this._physicsRig.inputs.at(s+f).type=Tt.CubismPhysicsSource_X,this._physicsRig.inputs.at(s+f).getNormalizedParameterValue=wo):i.getInputType(l,f)==is?(this._physicsRig.inputs.at(s+f).type=Tt.CubismPhysicsSource_Y,this._physicsRig.inputs.at(s+f).getNormalizedParameterValue=To):i.getInputType(l,f)==rs&&(this._physicsRig.inputs.at(s+f).type=Tt.CubismPhysicsSource_Angle,this._physicsRig.inputs.at(s+f).getNormalizedParameterValue=Ro),this._physicsRig.inputs.at(s+f).source.targetType=ve.CubismPhysicsTargetType_Parameter,this._physicsRig.inputs.at(s+f).source.id=i.getInputSourceId(l,f);s+=this._physicsRig.settings.at(l).inputCount,this._physicsRig.settings.at(l).outputCount=i.getOutputCount(l),this._physicsRig.settings.at(l).baseOutputIndex=a;const c=new as;c.outputs.resize(this._physicsRig.settings.at(l).outputCount);const g=new as;g.outputs.resize(this._physicsRig.settings.at(l).outputCount);for(let f=0;f<this._physicsRig.settings.at(l).outputCount;++f)c.outputs.set(f,0),g.outputs.set(f,0),this._physicsRig.outputs.at(a+f).destinationParameterIndex=-1,this._physicsRig.outputs.at(a+f).vertexIndex=i.getOutputVertexIndex(l,f),this._physicsRig.outputs.at(a+f).angleScale=i.getOutputAngleScale(l,f),this._physicsRig.outputs.at(a+f).weight=i.getOutputWeight(l,f),this._physicsRig.outputs.at(a+f).destination.targetType=ve.CubismPhysicsTargetType_Parameter,this._physicsRig.outputs.at(a+f).destination.id=i.getOutputDestinationId(l,f),i.getOutputType(l,f)==es?(this._physicsRig.outputs.at(a+f).type=Tt.CubismPhysicsSource_X,this._physicsRig.outputs.at(a+f).getValue=Vo,this._physicsRig.outputs.at(a+f).getScale=Lo):i.getOutputType(l,f)==is?(this._physicsRig.outputs.at(a+f).type=Tt.CubismPhysicsSource_Y,this._physicsRig.outputs.at(a+f).getValue=Eo,this._physicsRig.outputs.at(a+f).getScale=Oo):i.getOutputType(l,f)==rs&&(this._physicsRig.outputs.at(a+f).type=Tt.CubismPhysicsSource_Angle,this._physicsRig.outputs.at(a+f).getValue=Fo,this._physicsRig.outputs.at(a+f).getScale=No),this._physicsRig.outputs.at(a+f).reflect=i.getOutputReflect(l,f);this._currentRigOutputs.pushBack(c),this._previousRigOutputs.pushBack(g),a+=this._physicsRig.settings.at(l).outputCount,this._physicsRig.settings.at(l).particleCount=i.getParticleCount(l),this._physicsRig.settings.at(l).baseParticleIndex=o;for(let f=0;f<this._physicsRig.settings.at(l).particleCount;++f)this._physicsRig.particles.at(o+f).mobility=i.getParticleMobility(l,f),this._physicsRig.particles.at(o+f).delay=i.getParticleDelay(l,f),this._physicsRig.particles.at(o+f).acceleration=i.getParticleAcceleration(l,f),this._physicsRig.particles.at(o+f).radius=i.getParticleRadius(l,f),this._physicsRig.particles.at(o+f).position=i.getParticlePosition(l,f);o+=this._physicsRig.settings.at(l).particleCount}this.initialize(),i.release(),i=void 0,i=null}stabilization(t){var x,M;let e,i,s,a;const o=new k;let l,c,g,f,p,C,v,S;p=t.getModel().parameters.values,C=t.getModel().parameters.maximumValues,v=t.getModel().parameters.minimumValues,S=t.getModel().parameters.defaultValues,(((x=this._parameterCaches)==null?void 0:x.length)??0)<t.getParameterCount()&&(this._parameterCaches=new Float32Array(t.getParameterCount())),(((M=this._parameterInputCaches)==null?void 0:M.length)??0)<t.getParameterCount()&&(this._parameterInputCaches=new Float32Array(t.getParameterCount()));for(let D=0;D<t.getParameterCount();++D)this._parameterCaches[D]=p[D],this._parameterInputCaches[D]=p[D];for(let D=0;D<this._physicsRig.subRigCount;++D){e={angle:0},o.x=0,o.y=0,l=this._physicsRig.settings.at(D),c=this._physicsRig.inputs.get(l.baseInputIndex),g=this._physicsRig.outputs.get(l.baseOutputIndex),f=this._physicsRig.particles.get(l.baseParticleIndex);for(let w=0;w<l.inputCount;++w)i=c[w].weight/Mi,c[w].sourceParameterIndex==-1&&(c[w].sourceParameterIndex=t.getParameterIndex(c[w].source.id)),c[w].getNormalizedParameterValue(o,e,p[c[w].sourceParameterIndex],v[c[w].sourceParameterIndex],C[c[w].sourceParameterIndex],S[c[w].sourceParameterIndex],l.normalizationPosition,l.normalizationAngle,c[w].reflect,i),this._parameterCaches[c[w].sourceParameterIndex]=p[c[w].sourceParameterIndex];s=X.degreesToRadian(-e.angle),o.x=o.x*X.cos(s)-o.y*X.sin(s),o.y=o.x*X.sin(s)+o.y*X.cos(s),Uo(f,l.particleCount,o,e.angle,this._options.wind,ss*l.normalizationPosition.maximum);for(let w=0;w<l.outputCount;++w){const O=g[w].vertexIndex;if(g[w].destinationParameterIndex==-1&&(g[w].destinationParameterIndex=t.getParameterIndex(g[w].destination.id)),O<1||O>=l.particleCount)continue;let U=new k;U=f[O].position.substract(f[O-1].position),a=g[w].getValue(U,f,O,g[w].reflect,this._options.gravity),this._currentRigOutputs.at(D).outputs.set(w,a),this._previousRigOutputs.at(D).outputs.set(w,a);const B=g[w].destinationParameterIndex,I=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(p.subarray(B))):p.slice(B);pi(I,v[B],C[B],a,g[w]);for(let F=B,Y=0;F<this._parameterCaches.length;F++,Y++)p[F]=this._parameterCaches[F]=I[Y]}}}evaluate(t,e){var w,O;let i,s,a,o;const l=new k;let c,g,f,p;if(0>=e)return;let C,v,S,x,M;if(this._currentRemainTime+=e,this._currentRemainTime>bo&&(this._currentRemainTime=0),C=t.getModel().parameters.values,v=t.getModel().parameters.maximumValues,S=t.getModel().parameters.minimumValues,x=t.getModel().parameters.defaultValues,(((w=this._parameterCaches)==null?void 0:w.length)??0)<t.getParameterCount()&&(this._parameterCaches=new Float32Array(t.getParameterCount())),(((O=this._parameterInputCaches)==null?void 0:O.length)??0)<t.getParameterCount()){this._parameterInputCaches=new Float32Array(t.getParameterCount());for(let U=0;U<t.getParameterCount();++U)this._parameterInputCaches[U]=C[U]}for(this._physicsRig.fps>0?M=1/this._physicsRig.fps:M=e;this._currentRemainTime>=M;){for(let B=0;B<this._physicsRig.subRigCount;++B){c=this._physicsRig.settings.at(B),f=this._physicsRig.outputs.get(c.baseOutputIndex);for(let I=0;I<c.outputCount;++I)this._previousRigOutputs.at(B).outputs.set(I,this._currentRigOutputs.at(B).outputs.at(I))}const U=M/this._currentRemainTime;for(let B=0;B<t.getParameterCount();++B)this._parameterCaches[B]=this._parameterInputCaches[B]*(1-U)+C[B]*U,this._parameterInputCaches[B]=this._parameterCaches[B];for(let B=0;B<this._physicsRig.subRigCount;++B){i={angle:0},l.x=0,l.y=0,c=this._physicsRig.settings.at(B),g=this._physicsRig.inputs.get(c.baseInputIndex),f=this._physicsRig.outputs.get(c.baseOutputIndex),p=this._physicsRig.particles.get(c.baseParticleIndex);for(let I=0;I<c.inputCount;++I)s=g[I].weight/Mi,g[I].sourceParameterIndex==-1&&(g[I].sourceParameterIndex=t.getParameterIndex(g[I].source.id)),g[I].getNormalizedParameterValue(l,i,this._parameterCaches[g[I].sourceParameterIndex],S[g[I].sourceParameterIndex],v[g[I].sourceParameterIndex],x[g[I].sourceParameterIndex],c.normalizationPosition,c.normalizationAngle,g[I].reflect,s);a=X.degreesToRadian(-i.angle),l.x=l.x*X.cos(a)-l.y*X.sin(a),l.y=l.x*X.sin(a)+l.y*X.cos(a),ko(p,c.particleCount,l,i.angle,this._options.wind,ss*c.normalizationPosition.maximum,M,Po);for(let I=0;I<c.outputCount;++I){const F=f[I].vertexIndex;if(f[I].destinationParameterIndex==-1&&(f[I].destinationParameterIndex=t.getParameterIndex(f[I].destination.id)),F<1||F>=c.particleCount)continue;const Y=new k;Y.x=p[F].position.x-p[F-1].position.x,Y.y=p[F].position.y-p[F-1].position.y,o=f[I].getValue(Y,p,F,f[I].reflect,this._options.gravity),this._currentRigOutputs.at(B).outputs.set(I,o);const J=f[I].destinationParameterIndex,it=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(this._parameterCaches.subarray(J))):this._parameterCaches.slice(J);pi(it,S[J],v[J],o,f[I]);for(let st=J,at=0;st<this._parameterCaches.length;st++,at++)this._parameterCaches[st]=it[at]}}this._currentRemainTime-=M}const D=this._currentRemainTime/M;this.interpolate(t,D)}interpolate(t,e){let i,s,a,o,l;a=t.getModel().parameters.values,o=t.getModel().parameters.maximumValues,l=t.getModel().parameters.minimumValues;for(let c=0;c<this._physicsRig.subRigCount;++c){s=this._physicsRig.settings.at(c),i=this._physicsRig.outputs.get(s.baseOutputIndex);for(let g=0;g<s.outputCount;++g){if(i[g].destinationParameterIndex==-1)continue;const f=i[g].destinationParameterIndex,p=!Float32Array.prototype.slice&&"subarray"in Float32Array.prototype?JSON.parse(JSON.stringify(a.subarray(f))):a.slice(f);pi(p,l[f],o[f],this._previousRigOutputs.at(c).outputs.at(g)*(1-e)+this._currentRigOutputs.at(c).outputs.at(g)*e,i[g]);for(let C=f,v=0;C<a.length;C++,v++)a[C]=p[v]}}}setOptions(t){this._options=t}getOption(){return this._options}release(){this._physicsRig=void 0,this._physicsRig=null}initialize(){let t,e,i;for(let s=0;s<this._physicsRig.subRigCount;++s){e=this._physicsRig.settings.at(s),t=this._physicsRig.particles.get(e.baseParticleIndex),t[0].initialPosition=new k(0,0),t[0].lastPosition=new k(t[0].initialPosition.x,t[0].initialPosition.y),t[0].lastGravity=new k(0,-1),t[0].lastGravity.y*=-1,t[0].velocity=new k(0,0),t[0].force=new k(0,0);for(let a=1;a<e.particleCount;++a)i=new k(0,0),i.y=t[a].radius,t[a].initialPosition=new k(t[a-1].initialPosition.x+i.x,t[a-1].initialPosition.y+i.y),t[a].position=new k(t[a].initialPosition.x,t[a].initialPosition.y),t[a].lastPosition=new k(t[a].initialPosition.x,t[a].initialPosition.y),t[a].lastGravity=new k(0,-1),t[a].lastGravity.y*=-1,t[a].velocity=new k(0,0),t[a].force=new k(0,0)}}}class js{constructor(){n(this,"gravity");n(this,"wind");this.gravity=new k(0,0),this.wind=new k(0,0)}}class as{constructor(){n(this,"outputs");this.outputs=new L(0)}}function Io(r){let t=0;return r>0?t=1:r<0&&(t=-1),t}function wo(r,t,e,i,s,a,o,l,c,g){r.x+=Ri(e,i,s,a,o.minimum,o.maximum,o.defalut,c)*g}function To(r,t,e,i,s,a,o,l,c,g){r.y+=Ri(e,i,s,a,o.minimum,o.maximum,o.defalut,c)*g}function Ro(r,t,e,i,s,a,o,l,c,g){t.angle+=Ri(e,i,s,a,l.minimum,l.maximum,l.defalut,c)*g}function Vo(r,t,e,i,s){let a=r.x;return i&&(a*=-1),a}function Eo(r,t,e,i,s){let a=r.y;return i&&(a*=-1),a}function Fo(r,t,e,i,s){let a;return e>=2?s=t[e-1].position.substract(t[e-2].position):s=s.multiplyByScaler(-1),a=X.directionToRadian(s,r),i&&(a*=-1),a}function Ao(r,t){const e=X.max(r,t),i=X.min(r,t);return X.abs(e-i)}function Do(r,t){return X.min(r,t)+Ao(r,t)/2}function Lo(r,t){return JSON.parse(JSON.stringify(r.x))}function Oo(r,t){return JSON.parse(JSON.stringify(r.y))}function No(r,t){return JSON.parse(JSON.stringify(t))}function ko(r,t,e,i,s,a,o,l){let c,g,f,p,C=new k(0,0),v=new k(0,0),S=new k(0,0),x=new k(0,0);r[0].position=new k(e.x,e.y),c=X.degreesToRadian(i),p=X.radianToDirection(c),p.normalize();for(let M=1;M<t;++M)r[M].force=p.multiplyByScaler(r[M].acceleration).add(s),r[M].lastPosition=new k(r[M].position.x,r[M].position.y),g=r[M].delay*o*30,C=r[M].position.substract(r[M-1].position),f=X.directionToRadian(r[M].lastGravity,p)/l,C.x=X.cos(f)*C.x-C.y*X.sin(f),C.y=X.sin(f)*C.x+C.y*X.cos(f),r[M].position=r[M-1].position.add(C),v=r[M].velocity.multiplyByScaler(g),S=r[M].force.multiplyByScaler(g).multiplyByScaler(g),r[M].position=r[M].position.add(v).add(S),x=r[M].position.substract(r[M-1].position),x.normalize(),r[M].position=r[M-1].position.add(x.multiplyByScaler(r[M].radius)),X.abs(r[M].position.x)<a&&(r[M].position.x=0),g!=0&&(r[M].velocity=r[M].position.substract(r[M].lastPosition),r[M].velocity=r[M].velocity.divisionByScalar(g),r[M].velocity=r[M].velocity.multiplyByScaler(r[M].mobility)),r[M].force=new k(0,0),r[M].lastGravity=new k(p.x,p.y)}function Uo(r,t,e,i,s,a){let o,l,c=new k(0,0);r[0].position=new k(e.x,e.y),o=X.degreesToRadian(i),l=X.radianToDirection(o),l.normalize();for(let g=1;g<t;++g)r[g].force=l.multiplyByScaler(r[g].acceleration).add(s),r[g].lastPosition=new k(r[g].position.x,r[g].position.y),r[g].velocity=new k(0,0),c=r[g].force,c.normalize(),c=c.multiplyByScaler(r[g].radius),r[g].position=r[g-1].position.add(c),X.abs(r[g].position.x)<a&&(r[g].position.x=0),r[g].force=new k(0,0),r[g].lastGravity=new k(l.x,l.y)}function pi(r,t,e,i,s){let a,o,l;a=s.getScale(s.translationScale,s.angleScale),o=i*a,o<t?(o<s.valueBelowMinimum&&(s.valueBelowMinimum=o),o=t):o>e&&(o>s.valueExceededMaximum&&(s.valueExceededMaximum=o),o=e),l=s.weight/Mi,l>=1||(o=r[0]*(1-l)+o*l),r[0]=o}function Ri(r,t,e,i,s,a,o,l){let c=0;const g=X.max(e,t);g<r&&(r=g);const f=X.min(e,t);f>r&&(r=f);const p=X.min(s,a),C=X.max(s,a),v=o,S=Do(f,g),x=r-S;switch(Io(x)){case 1:{const M=C-v,D=g-S;D!=0&&(c=x*(M/D),c+=v);break}case-1:{const M=p-v,D=f-S;D!=0&&(c=x*(M/D),c+=v);break}case 0:{c=v;break}}return l?c:c*-1}var ns;(function(r){r.CubismPhysics=Me,r.Options=js})(ns||(ns={}));class $e{constructor(t,e,i,s){n(this,"x");n(this,"y");n(this,"width");n(this,"height");this.x=t,this.y=e,this.width=i,this.height=s}getCenterX(){return this.x+.5*this.width}getCenterY(){return this.y+.5*this.height}getRight(){return this.x+this.width}getBottom(){return this.y+this.height}setRect(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height}expand(t,e){this.x-=t,this.y-=e,this.width+=t*2,this.height+=e*2}}var os;(function(r){r.csmRect=$e})(os||(os={}));const Ne=4,zo=36,Xo=32,Yo=10;let zt,Rt,qe;class Bi{constructor(){n(this,"_currentMaskRenderTexture");n(this,"_maskRenderTextures");n(this,"_maskColorBuffers");n(this,"_currentFrameNo");n(this,"_channelColors");n(this,"_maskTexture");n(this,"_clippingContextListForMask");n(this,"_clippingContextListForDraw");n(this,"_clippingMaskBufferSize");n(this,"_renderTextureCount");n(this,"_tmpMatrix");n(this,"_tmpMatrixForMask");n(this,"_tmpMatrixForDraw");n(this,"_tmpBoundsOnModel");n(this,"_clearedFrameBufferflags");n(this,"gl");this._currentMaskRenderTexture=null,this._maskColorBuffers=null,this._currentFrameNo=0,this._renderTextureCount=0,this._clippingMaskBufferSize=256,this._clippingContextListForMask=new L,this._clippingContextListForDraw=new L,this._channelColors=new L,this._tmpBoundsOnModel=new $e,this._tmpMatrix=new et,this._tmpMatrixForMask=new et,this._tmpMatrixForDraw=new et,this._maskTexture=null;let t=new ct;t.R=1,t.G=0,t.B=0,t.A=0,this._channelColors.pushBack(t),t=new ct,t.R=0,t.G=1,t.B=0,t.A=0,this._channelColors.pushBack(t),t=new ct,t.R=0,t.G=0,t.B=1,t.A=0,this._channelColors.pushBack(t),t=new ct,t.R=0,t.G=0,t.B=0,t.A=1,this._channelColors.pushBack(t)}getChannelFlagAsColor(t){return this._channelColors.at(t)}getMaskRenderTexture(){if(this._maskTexture&&this._maskTexture.textures!=null)this._maskTexture.frameNo=this._currentFrameNo;else{this._maskRenderTextures!=null&&this._maskRenderTextures.clear(),this._maskRenderTextures=new L,this._maskColorBuffers!=null&&this._maskColorBuffers.clear(),this._maskColorBuffers=new L;const t=this._clippingMaskBufferSize;for(let e=0;e<this._renderTextureCount;e++)this._maskColorBuffers.pushBack(this.gl.createTexture()),this.gl.bindTexture(this.gl.TEXTURE_2D,this._maskColorBuffers.at(e)),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,t,t,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this._maskRenderTextures.pushBack(this.gl.createFramebuffer()),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._maskRenderTextures.at(e)),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this._maskColorBuffers.at(e),0);this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,qe),this._maskTexture=new Hs(this._currentFrameNo,this._maskRenderTextures)}return this._maskTexture.textures}setGL(t){this.gl=t}calcClippedDrawTotalBounds(t,e){let i=Number.MAX_VALUE,s=Number.MAX_VALUE,a=Number.MIN_VALUE,o=Number.MIN_VALUE;const l=e._clippedDrawableIndexList.length;for(let c=0;c<l;c++){const g=e._clippedDrawableIndexList[c],f=t.getDrawableVertexCount(g),p=t.getDrawableVertices(g);let C=Number.MAX_VALUE,v=Number.MAX_VALUE,S=-Number.MAX_VALUE,x=-Number.MAX_VALUE;const M=f*Ot.vertexStep;for(let D=Ot.vertexOffset;D<M;D+=Ot.vertexStep){const w=p[D],O=p[D+1];w<C&&(C=w),w>S&&(S=w),O<v&&(v=O),O>x&&(x=O)}if(C!=Number.MAX_VALUE)if(C<i&&(i=C),v<s&&(s=v),S>a&&(a=S),x>o&&(o=x),i==Number.MAX_VALUE)e._allClippedDrawRect.x=0,e._allClippedDrawRect.y=0,e._allClippedDrawRect.width=0,e._allClippedDrawRect.height=0,e._isUsing=!1;else{e._isUsing=!0;const D=a-i,w=o-s;e._allClippedDrawRect.x=i,e._allClippedDrawRect.y=s,e._allClippedDrawRect.width=D,e._allClippedDrawRect.height=w}}}release(){for(let t=0;t<this._clippingContextListForMask.getSize();t++)this._clippingContextListForMask.at(t)&&(this._clippingContextListForMask.at(t).release(),this._clippingContextListForMask.set(t,void 0)),this._clippingContextListForMask.set(t,null);this._clippingContextListForMask=null;for(let t=0;t<this._clippingContextListForDraw.getSize();t++)this._clippingContextListForDraw.set(t,null);if(this._clippingContextListForDraw=null,this._maskTexture){for(let t=0;t<this._maskTexture.textures.getSize();t++)this.gl.deleteFramebuffer(this._maskTexture.textures.at(t));this._maskTexture.textures.clear(),this._maskTexture.textures=null,this._maskTexture=null}for(let t=0;t<this._channelColors.getSize();t++)this._channelColors.set(t,null);if(this._channelColors=null,this._maskColorBuffers!=null){for(let t=0;t<this._maskColorBuffers.getSize();t++)this.gl.deleteTexture(this._maskColorBuffers.at(t));this._maskColorBuffers.clear()}this._maskColorBuffers=null,this._maskRenderTextures!=null&&this._maskRenderTextures.clear(),this._maskRenderTextures=null,this._clearedFrameBufferflags!=null&&this._clearedFrameBufferflags.clear(),this._clearedFrameBufferflags=null}initialize(t,e,i,s,a){a%1!=0&&(Lt("The number of render textures must be specified as an integer. The decimal point is rounded down and corrected to an integer."),a=~~a),a<1&&Lt("The number of render textures must be an integer greater than or equal to 1. Set the number of render textures to 1."),this._renderTextureCount=a<1?1:a,this._clearedFrameBufferflags=new L(this._renderTextureCount);for(let o=0;o<e;o++){if(s[o]<=0){this._clippingContextListForDraw.pushBack(null);continue}let l=this.findSameClip(i[o],s[o]);l==null&&(l=new Ws(this,i[o],s[o]),this._clippingContextListForMask.pushBack(l)),l.addClippedDrawable(o),this._clippingContextListForDraw.pushBack(l)}}setupClippingContext(t,e){this._currentFrameNo++;let i=0;for(let s=0;s<this._clippingContextListForMask.getSize();s++){const a=this._clippingContextListForMask.at(s);this.calcClippedDrawTotalBounds(t,a),a._isUsing&&i++}if(i>0){this.setupLayoutBounds(e.isUsingHighPrecisionMask()?0:i),e.isUsingHighPrecisionMask()||(this.gl.viewport(0,0,this._clippingMaskBufferSize,this._clippingMaskBufferSize),this._currentMaskRenderTexture=this.getMaskRenderTexture().at(0),e.preDraw(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._currentMaskRenderTexture)),this._clearedFrameBufferflags.getSize()!=this._renderTextureCount&&(this._clearedFrameBufferflags.clear(),this._clearedFrameBufferflags=new L(this._renderTextureCount));for(let s=0;s<this._clearedFrameBufferflags.getSize();s++)this._clearedFrameBufferflags.set(s,!1);for(let s=0;s<this._clippingContextListForMask.getSize();s++){const a=this._clippingContextListForMask.at(s),o=a._allClippedDrawRect,l=a._layoutBounds,c=.05;let g=0,f=0;const p=this.getMaskRenderTexture().at(a._bufferIndex);if(this._currentMaskRenderTexture!=p&&!e.isUsingHighPrecisionMask()&&(this._currentMaskRenderTexture=p,e.preDraw(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this._currentMaskRenderTexture)),e.isUsingHighPrecisionMask()){const C=t.getPixelsPerUnit(),v=a.getClippingManager()._clippingMaskBufferSize,S=l.width*v,x=l.height*v;this._tmpBoundsOnModel.setRect(o),this._tmpBoundsOnModel.width*C>S?(this._tmpBoundsOnModel.expand(o.width*c,0),g=l.width/this._tmpBoundsOnModel.width):g=C/S,this._tmpBoundsOnModel.height*C>x?(this._tmpBoundsOnModel.expand(0,o.height*c),f=l.height/this._tmpBoundsOnModel.height):f=C/x}else this._tmpBoundsOnModel.setRect(o),this._tmpBoundsOnModel.expand(o.width*c,o.height*c),g=l.width/this._tmpBoundsOnModel.width,f=l.height/this._tmpBoundsOnModel.height;if(this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(-1,-1),this._tmpMatrix.scaleRelative(2,2),this._tmpMatrix.translateRelative(l.x,l.y),this._tmpMatrix.scaleRelative(g,f),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForMask.setMatrix(this._tmpMatrix.getArray()),this._tmpMatrix.loadIdentity(),this._tmpMatrix.translateRelative(l.x,l.y),this._tmpMatrix.scaleRelative(g,f),this._tmpMatrix.translateRelative(-this._tmpBoundsOnModel.x,-this._tmpBoundsOnModel.y),this._tmpMatrixForDraw.setMatrix(this._tmpMatrix.getArray()),a._matrixForMask.setMatrix(this._tmpMatrixForMask.getArray()),a._matrixForDraw.setMatrix(this._tmpMatrixForDraw.getArray()),!e.isUsingHighPrecisionMask()){const C=a._clippingIdCount;for(let v=0;v<C;v++){const S=a._clippingIdList[v];t.getDrawableDynamicFlagVertexPositionsDidChange(S)&&(e.setIsCulling(t.getDrawableCulling(S)!=!1),this._clearedFrameBufferflags.at(a._bufferIndex)||(this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this._clearedFrameBufferflags.set(a._bufferIndex,!0)),e.setClippingContextBufferForMask(a),e.drawMesh(t.getDrawableTextureIndex(S),t.getDrawableVertexIndexCount(S),t.getDrawableVertexCount(S),t.getDrawableVertexIndices(S),t.getDrawableVertices(S),t.getDrawableVertexUvs(S),t.getMultiplyColor(S),t.getScreenColor(S),t.getDrawableOpacity(S),Bt.CubismBlendMode_Normal,!1))}}}e.isUsingHighPrecisionMask()||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,qe),e.setClippingContextBufferForMask(null),this.gl.viewport(Rt[0],Rt[1],Rt[2],Rt[3]))}}findSameClip(t,e){for(let i=0;i<this._clippingContextListForMask.getSize();i++){const s=this._clippingContextListForMask.at(i),a=s._clippingIdCount;if(a!=e)continue;let o=0;for(let l=0;l<a;l++){const c=s._clippingIdList[l];for(let g=0;g<a;g++)if(t[g]==c){o++;break}}if(o==a)return s}return null}setupLayoutBounds(t){const e=this._renderTextureCount<=1?zo:Xo*this._renderTextureCount;if(t<=0||t>e){t>e&&ut(`not supported mask count : {0}
[Details] render texture count : {1}, mask count : {2}`,t-e,this._renderTextureCount,t);for(let g=0;g<this._clippingContextListForMask.getSize();g++){const f=this._clippingContextListForMask.at(g);f._layoutChannelNo=0,f._layoutBounds.x=0,f._layoutBounds.y=0,f._layoutBounds.width=1,f._layoutBounds.height=1,f._bufferIndex=0}return}const i=this._renderTextureCount<=1?9:8;let s=t/this._renderTextureCount,a=t%this._renderTextureCount;s=~~s,a=~~a;let o=s/Ne,l=s%Ne;o=~~o,l=~~l;let c=0;for(let g=0;g<this._renderTextureCount;g++)for(let f=0;f<Ne;f++){let p=o+(f<l?1:0);const C=l+1>=Ne?0:l+1;if(p<i&&f==C&&(p+=g<a?1:0),p!=0)if(p==1){const v=this._clippingContextListForMask.at(c++);v._layoutChannelNo=f,v._layoutBounds.x=0,v._layoutBounds.y=0,v._layoutBounds.width=1,v._layoutBounds.height=1,v._bufferIndex=g}else if(p==2)for(let v=0;v<p;v++){let S=v%2;S=~~S;const x=this._clippingContextListForMask.at(c++);x._layoutChannelNo=f,x._layoutBounds.x=S*.5,x._layoutBounds.y=0,x._layoutBounds.width=.5,x._layoutBounds.height=1,x._bufferIndex=g}else if(p<=4)for(let v=0;v<p;v++){let S=v%2,x=v/2;S=~~S,x=~~x;const M=this._clippingContextListForMask.at(c++);M._layoutChannelNo=f,M._layoutBounds.x=S*.5,M._layoutBounds.y=x*.5,M._layoutBounds.width=.5,M._layoutBounds.height=.5,M._bufferIndex=g}else if(p<=i)for(let v=0;v<p;v++){let S=v%3,x=v/3;S=~~S,x=~~x;const M=this._clippingContextListForMask.at(c++);M._layoutChannelNo=f,M._layoutBounds.x=S/3,M._layoutBounds.y=x/3,M._layoutBounds.width=1/3,M._layoutBounds.height=1/3,M._bufferIndex=g}else{ut(`not supported mask count : {0}
[Details] render texture count : {1}, mask count : {2}`,t-e,this._renderTextureCount,t);for(let v=0;v<p;v++){const S=this._clippingContextListForMask.at(c++);S._layoutChannelNo=0,S._layoutBounds.x=0,S._layoutBounds.y=0,S._layoutBounds.width=1,S._layoutBounds.height=1,S._bufferIndex=0}}}}getColorBuffer(){return this._maskColorBuffers}getClippingContextListForDraw(){return this._clippingContextListForDraw}getClippingMaskCount(){return this._clippingContextListForMask.getSize()}setClippingMaskBufferSize(t){this._clippingMaskBufferSize=t}getClippingMaskBufferSize(){return this._clippingMaskBufferSize}getRenderTextureCount(){return this._renderTextureCount}}class Hs{constructor(t,e){n(this,"frameNo");n(this,"textures");this.frameNo=t,this.textures=e}}class Ws{constructor(t,e,i){n(this,"_isUsing");n(this,"_clippingIdList");n(this,"_clippingIdCount");n(this,"_layoutChannelNo");n(this,"_layoutBounds");n(this,"_allClippedDrawRect");n(this,"_matrixForMask");n(this,"_matrixForDraw");n(this,"_clippedDrawableIndexList");n(this,"_bufferIndex");n(this,"_owner");this._owner=t,this._clippingIdList=e,this._clippingIdCount=i,this._allClippedDrawRect=new $e,this._layoutBounds=new $e,this._clippedDrawableIndexList=[],this._matrixForMask=new et,this._matrixForDraw=new et,this._bufferIndex=0}release(){this._layoutBounds!=null&&(this._layoutBounds=null),this._allClippedDrawRect!=null&&(this._allClippedDrawRect=null),this._clippedDrawableIndexList!=null&&(this._clippedDrawableIndexList=null)}addClippedDrawable(t){this._clippedDrawableIndexList.push(t)}getClippingManager(){return this._owner}setGl(t){this._owner.setGL(t)}}class Go{constructor(){n(this,"_lastArrayBufferBinding");n(this,"_lastElementArrayBufferBinding");n(this,"_lastProgram");n(this,"_lastActiveTexture");n(this,"_lastTexture0Binding2D");n(this,"_lastTexture1Binding2D");n(this,"_lastVertexAttribArrayEnabled");n(this,"_lastScissorTest");n(this,"_lastBlend");n(this,"_lastStencilTest");n(this,"_lastDepthTest");n(this,"_lastCullFace");n(this,"_lastFrontFace");n(this,"_lastColorMask");n(this,"_lastBlending");n(this,"_lastFBO");n(this,"_lastViewport");n(this,"gl");this._lastVertexAttribArrayEnabled=new Array(4),this._lastColorMask=new Array(4),this._lastBlending=new Array(4),this._lastViewport=new Array(4)}setGlEnable(t,e){e?this.gl.enable(t):this.gl.disable(t)}setGlEnableVertexAttribArray(t,e){e?this.gl.enableVertexAttribArray(t):this.gl.disableVertexAttribArray(t)}save(){if(this.gl==null){ut(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this._lastArrayBufferBinding=this.gl.getParameter(this.gl.ARRAY_BUFFER_BINDING),this._lastArrayBufferBinding=this.gl.getParameter(this.gl.ELEMENT_ARRAY_BUFFER_BINDING),this._lastProgram=this.gl.getParameter(this.gl.CURRENT_PROGRAM),this._lastActiveTexture=this.gl.getParameter(this.gl.ACTIVE_TEXTURE),this.gl.activeTexture(this.gl.TEXTURE1),this._lastTexture1Binding2D=this.gl.getParameter(this.gl.TEXTURE_BINDING_2D),this.gl.activeTexture(this.gl.TEXTURE0),this._lastTexture0Binding2D=this.gl.getParameter(this.gl.TEXTURE_BINDING_2D),this._lastVertexAttribArrayEnabled[0]=this.gl.getVertexAttrib(0,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[1]=this.gl.getVertexAttrib(1,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[2]=this.gl.getVertexAttrib(2,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastVertexAttribArrayEnabled[3]=this.gl.getVertexAttrib(3,this.gl.VERTEX_ATTRIB_ARRAY_ENABLED),this._lastScissorTest=this.gl.isEnabled(this.gl.SCISSOR_TEST),this._lastStencilTest=this.gl.isEnabled(this.gl.STENCIL_TEST),this._lastDepthTest=this.gl.isEnabled(this.gl.DEPTH_TEST),this._lastCullFace=this.gl.isEnabled(this.gl.CULL_FACE),this._lastBlend=this.gl.isEnabled(this.gl.BLEND),this._lastFrontFace=this.gl.getParameter(this.gl.FRONT_FACE),this._lastColorMask=this.gl.getParameter(this.gl.COLOR_WRITEMASK),this._lastBlending[0]=this.gl.getParameter(this.gl.BLEND_SRC_RGB),this._lastBlending[1]=this.gl.getParameter(this.gl.BLEND_DST_RGB),this._lastBlending[2]=this.gl.getParameter(this.gl.BLEND_SRC_ALPHA),this._lastBlending[3]=this.gl.getParameter(this.gl.BLEND_DST_ALPHA),this._lastFBO=this.gl.getParameter(this.gl.FRAMEBUFFER_BINDING),this._lastViewport=this.gl.getParameter(this.gl.VIEWPORT)}restore(){if(this.gl==null){ut(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this.gl.useProgram(this._lastProgram),this.setGlEnableVertexAttribArray(0,this._lastVertexAttribArrayEnabled[0]),this.setGlEnableVertexAttribArray(1,this._lastVertexAttribArrayEnabled[1]),this.setGlEnableVertexAttribArray(2,this._lastVertexAttribArrayEnabled[2]),this.setGlEnableVertexAttribArray(3,this._lastVertexAttribArrayEnabled[3]),this.setGlEnable(this.gl.SCISSOR_TEST,this._lastScissorTest),this.setGlEnable(this.gl.STENCIL_TEST,this._lastStencilTest),this.setGlEnable(this.gl.DEPTH_TEST,this._lastDepthTest),this.setGlEnable(this.gl.CULL_FACE,this._lastCullFace),this.setGlEnable(this.gl.BLEND,this._lastBlend),this.gl.frontFace(this._lastFrontFace),this.gl.colorMask(this._lastColorMask[0],this._lastColorMask[1],this._lastColorMask[2],this._lastColorMask[3]),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this._lastArrayBufferBinding),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,this._lastElementArrayBufferBinding),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this._lastTexture1Binding2D),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this._lastTexture0Binding2D),this.gl.activeTexture(this._lastActiveTexture),this.gl.blendFuncSeparate(this._lastBlending[0],this._lastBlending[1],this._lastBlending[2],this._lastBlending[3])}setGl(t){this.gl=t}}class se{constructor(){n(this,"_shaderSets");n(this,"gl");this._shaderSets=new L}static getInstance(){return zt==null&&(zt=new se),zt}static deleteInstance(){zt&&(zt.release(),zt=null)}release(){this.releaseShaderProgram()}setupShaderProgram(t,e,i,s,a,o,l,c,g,f,p,C,v,S,x){v||ut("NoPremultipliedAlpha is not allowed"),this._shaderSets.getSize()==0&&this.generateShaders();let M,D,w,O;if(t.getClippingContextBufferForMask()!=null){const U=this._shaderSets.at(Gt.ShaderNames_SetupMask);this.gl.useProgram(U.shaderProgram),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(U.samplerTexture0Location,0),l.vertex==null&&(l.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,l.vertex),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(U.attributePositionLocation),this.gl.vertexAttribPointer(U.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),l.uv==null&&(l.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,l.uv),this.gl.bufferData(this.gl.ARRAY_BUFFER,o,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(U.attributeTexCoordLocation),this.gl.vertexAttribPointer(U.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0);const B=t.getClippingContextBufferForMask()._layoutChannelNo,I=t.getClippingContextBufferForMask().getClippingManager().getChannelFlagAsColor(B);this.gl.uniform4f(U.uniformChannelFlagLocation,I.R,I.G,I.B,I.A),this.gl.uniformMatrix4fv(U.uniformClipMatrixLocation,!1,t.getClippingContextBufferForMask()._matrixForMask.getArray());const F=t.getClippingContextBufferForMask()._layoutBounds;this.gl.uniform4f(U.uniformBaseColorLocation,F.x*2-1,F.y*2-1,F.getRight()*2-1,F.getBottom()*2-1),this.gl.uniform4f(U.uniformMultiplyColorLocation,p.R,p.G,p.B,p.A),this.gl.uniform4f(U.uniformScreenColorLocation,C.R,C.G,C.B,C.A),M=this.gl.ZERO,D=this.gl.ONE_MINUS_SRC_COLOR,w=this.gl.ZERO,O=this.gl.ONE_MINUS_SRC_ALPHA}else{const U=t.getClippingContextBufferForDraw()!=null,B=U?x?2:1:0;let I=new Pi;switch(g){case Bt.CubismBlendMode_Normal:default:I=this._shaderSets.at(Gt.ShaderNames_NormalPremultipliedAlpha+B),M=this.gl.ONE,D=this.gl.ONE_MINUS_SRC_ALPHA,w=this.gl.ONE,O=this.gl.ONE_MINUS_SRC_ALPHA;break;case Bt.CubismBlendMode_Additive:I=this._shaderSets.at(Gt.ShaderNames_AddPremultipliedAlpha+B),M=this.gl.ONE,D=this.gl.ONE,w=this.gl.ZERO,O=this.gl.ONE;break;case Bt.CubismBlendMode_Multiplicative:I=this._shaderSets.at(Gt.ShaderNames_MultPremultipliedAlpha+B),M=this.gl.DST_COLOR,D=this.gl.ONE_MINUS_SRC_ALPHA,w=this.gl.ZERO,O=this.gl.ONE;break}if(this.gl.useProgram(I.shaderProgram),l.vertex==null&&(l.vertex=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,l.vertex),this.gl.bufferData(this.gl.ARRAY_BUFFER,s,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(I.attributePositionLocation),this.gl.vertexAttribPointer(I.attributePositionLocation,2,this.gl.FLOAT,!1,0,0),l.uv==null&&(l.uv=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,l.uv),this.gl.bufferData(this.gl.ARRAY_BUFFER,o,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(I.attributeTexCoordLocation),this.gl.vertexAttribPointer(I.attributeTexCoordLocation,2,this.gl.FLOAT,!1,0,0),U){this.gl.activeTexture(this.gl.TEXTURE1);const F=t.getClippingContextBufferForDraw().getClippingManager().getColorBuffer().at(t.getClippingContextBufferForDraw()._bufferIndex);this.gl.bindTexture(this.gl.TEXTURE_2D,F),this.gl.uniform1i(I.samplerTexture1Location,1),this.gl.uniformMatrix4fv(I.uniformClipMatrixLocation,!1,t.getClippingContextBufferForDraw()._matrixForDraw.getArray());const Y=t.getClippingContextBufferForDraw()._layoutChannelNo,J=t.getClippingContextBufferForDraw().getClippingManager().getChannelFlagAsColor(Y);this.gl.uniform4f(I.uniformChannelFlagLocation,J.R,J.G,J.B,J.A)}this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.uniform1i(I.samplerTexture0Location,0),this.gl.uniformMatrix4fv(I.uniformMatrixLocation,!1,S.getArray()),this.gl.uniform4f(I.uniformBaseColorLocation,f.R,f.G,f.B,f.A),this.gl.uniform4f(I.uniformMultiplyColorLocation,p.R,p.G,p.B,p.A),this.gl.uniform4f(I.uniformScreenColorLocation,C.R,C.G,C.B,C.A)}l.index==null&&(l.index=this.gl.createBuffer()),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,l.index),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,a,this.gl.DYNAMIC_DRAW),this.gl.blendFuncSeparate(M,D,w,O)}releaseShaderProgram(){for(let t=0;t<this._shaderSets.getSize();t++)this.gl.deleteProgram(this._shaderSets.at(t).shaderProgram),this._shaderSets.at(t).shaderProgram=0,this._shaderSets.set(t,void 0),this._shaderSets.set(t,null)}generateShaders(){for(let t=0;t<Yo;t++)this._shaderSets.pushBack(new Pi);this._shaderSets.at(0).shaderProgram=this.loadShaderProgram(jo,Ho),this._shaderSets.at(1).shaderProgram=this.loadShaderProgram(Wo,$o),this._shaderSets.at(2).shaderProgram=this.loadShaderProgram(ls,qo),this._shaderSets.at(3).shaderProgram=this.loadShaderProgram(ls,Jo),this._shaderSets.at(4).shaderProgram=this._shaderSets.at(1).shaderProgram,this._shaderSets.at(5).shaderProgram=this._shaderSets.at(2).shaderProgram,this._shaderSets.at(6).shaderProgram=this._shaderSets.at(3).shaderProgram,this._shaderSets.at(7).shaderProgram=this._shaderSets.at(1).shaderProgram,this._shaderSets.at(8).shaderProgram=this._shaderSets.at(2).shaderProgram,this._shaderSets.at(9).shaderProgram=this._shaderSets.at(3).shaderProgram,this._shaderSets.at(0).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(0).shaderProgram,"a_position"),this._shaderSets.at(0).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(0).shaderProgram,"a_texCoord"),this._shaderSets.at(0).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"s_texture0"),this._shaderSets.at(0).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_clipMatrix"),this._shaderSets.at(0).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_channelFlag"),this._shaderSets.at(0).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_baseColor"),this._shaderSets.at(0).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_multiplyColor"),this._shaderSets.at(0).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(0).shaderProgram,"u_screenColor"),this._shaderSets.at(1).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(1).shaderProgram,"a_position"),this._shaderSets.at(1).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(1).shaderProgram,"a_texCoord"),this._shaderSets.at(1).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"s_texture0"),this._shaderSets.at(1).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_matrix"),this._shaderSets.at(1).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_baseColor"),this._shaderSets.at(1).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_multiplyColor"),this._shaderSets.at(1).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(1).shaderProgram,"u_screenColor"),this._shaderSets.at(2).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(2).shaderProgram,"a_position"),this._shaderSets.at(2).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(2).shaderProgram,"a_texCoord"),this._shaderSets.at(2).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"s_texture0"),this._shaderSets.at(2).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"s_texture1"),this._shaderSets.at(2).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_matrix"),this._shaderSets.at(2).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_clipMatrix"),this._shaderSets.at(2).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_channelFlag"),this._shaderSets.at(2).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_baseColor"),this._shaderSets.at(2).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_multiplyColor"),this._shaderSets.at(2).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(2).shaderProgram,"u_screenColor"),this._shaderSets.at(3).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(3).shaderProgram,"a_position"),this._shaderSets.at(3).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(3).shaderProgram,"a_texCoord"),this._shaderSets.at(3).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"s_texture0"),this._shaderSets.at(3).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"s_texture1"),this._shaderSets.at(3).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_matrix"),this._shaderSets.at(3).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_clipMatrix"),this._shaderSets.at(3).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_channelFlag"),this._shaderSets.at(3).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_baseColor"),this._shaderSets.at(3).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_multiplyColor"),this._shaderSets.at(3).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(3).shaderProgram,"u_screenColor"),this._shaderSets.at(4).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(4).shaderProgram,"a_position"),this._shaderSets.at(4).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(4).shaderProgram,"a_texCoord"),this._shaderSets.at(4).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"s_texture0"),this._shaderSets.at(4).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_matrix"),this._shaderSets.at(4).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_baseColor"),this._shaderSets.at(4).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_multiplyColor"),this._shaderSets.at(4).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(4).shaderProgram,"u_screenColor"),this._shaderSets.at(5).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(5).shaderProgram,"a_position"),this._shaderSets.at(5).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(5).shaderProgram,"a_texCoord"),this._shaderSets.at(5).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"s_texture0"),this._shaderSets.at(5).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"s_texture1"),this._shaderSets.at(5).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_matrix"),this._shaderSets.at(5).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_clipMatrix"),this._shaderSets.at(5).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_channelFlag"),this._shaderSets.at(5).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_baseColor"),this._shaderSets.at(5).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_multiplyColor"),this._shaderSets.at(5).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(5).shaderProgram,"u_screenColor"),this._shaderSets.at(6).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(6).shaderProgram,"a_position"),this._shaderSets.at(6).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(6).shaderProgram,"a_texCoord"),this._shaderSets.at(6).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"s_texture0"),this._shaderSets.at(6).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"s_texture1"),this._shaderSets.at(6).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_matrix"),this._shaderSets.at(6).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_clipMatrix"),this._shaderSets.at(6).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_channelFlag"),this._shaderSets.at(6).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_baseColor"),this._shaderSets.at(6).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_multiplyColor"),this._shaderSets.at(6).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(6).shaderProgram,"u_screenColor"),this._shaderSets.at(7).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(7).shaderProgram,"a_position"),this._shaderSets.at(7).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(7).shaderProgram,"a_texCoord"),this._shaderSets.at(7).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"s_texture0"),this._shaderSets.at(7).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_matrix"),this._shaderSets.at(7).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_baseColor"),this._shaderSets.at(7).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_multiplyColor"),this._shaderSets.at(7).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(7).shaderProgram,"u_screenColor"),this._shaderSets.at(8).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(8).shaderProgram,"a_position"),this._shaderSets.at(8).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(8).shaderProgram,"a_texCoord"),this._shaderSets.at(8).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"s_texture0"),this._shaderSets.at(8).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"s_texture1"),this._shaderSets.at(8).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_matrix"),this._shaderSets.at(8).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_clipMatrix"),this._shaderSets.at(8).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_channelFlag"),this._shaderSets.at(8).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_baseColor"),this._shaderSets.at(8).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_multiplyColor"),this._shaderSets.at(8).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(8).shaderProgram,"u_screenColor"),this._shaderSets.at(9).attributePositionLocation=this.gl.getAttribLocation(this._shaderSets.at(9).shaderProgram,"a_position"),this._shaderSets.at(9).attributeTexCoordLocation=this.gl.getAttribLocation(this._shaderSets.at(9).shaderProgram,"a_texCoord"),this._shaderSets.at(9).samplerTexture0Location=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"s_texture0"),this._shaderSets.at(9).samplerTexture1Location=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"s_texture1"),this._shaderSets.at(9).uniformMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_matrix"),this._shaderSets.at(9).uniformClipMatrixLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_clipMatrix"),this._shaderSets.at(9).uniformChannelFlagLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_channelFlag"),this._shaderSets.at(9).uniformBaseColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_baseColor"),this._shaderSets.at(9).uniformMultiplyColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_multiplyColor"),this._shaderSets.at(9).uniformScreenColorLocation=this.gl.getUniformLocation(this._shaderSets.at(9).shaderProgram,"u_screenColor")}loadShaderProgram(t,e){let i=this.gl.createProgram(),s=this.compileShaderSource(this.gl.VERTEX_SHADER,t);if(!s)return ut("Vertex shader compile error!"),0;let a=this.compileShaderSource(this.gl.FRAGMENT_SHADER,e);return a?(this.gl.attachShader(i,s),this.gl.attachShader(i,a),this.gl.linkProgram(i),this.gl.getProgramParameter(i,this.gl.LINK_STATUS)?(this.gl.deleteShader(s),this.gl.deleteShader(a),i):(ut("Failed to link program: {0}",i),this.gl.deleteShader(s),s=0,this.gl.deleteShader(a),a=0,i&&(this.gl.deleteProgram(i),i=0),0)):(ut("Vertex shader compile error!"),0)}compileShaderSource(t,e){const i=e,s=this.gl.createShader(t);if(this.gl.shaderSource(s,i),this.gl.compileShader(s),!s){const o=this.gl.getShaderInfoLog(s);ut("Shader compile log: {0} ",o)}return this.gl.getShaderParameter(s,this.gl.COMPILE_STATUS)?s:(this.gl.deleteShader(s),null)}setGl(t){this.gl=t}}class Pi{constructor(){n(this,"shaderProgram");n(this,"attributePositionLocation");n(this,"attributeTexCoordLocation");n(this,"uniformMatrixLocation");n(this,"uniformClipMatrixLocation");n(this,"samplerTexture0Location");n(this,"samplerTexture1Location");n(this,"uniformBaseColorLocation");n(this,"uniformChannelFlagLocation");n(this,"uniformMultiplyColorLocation");n(this,"uniformScreenColorLocation")}}var Gt;(function(r){r[r.ShaderNames_SetupMask=0]="ShaderNames_SetupMask",r[r.ShaderNames_NormalPremultipliedAlpha=1]="ShaderNames_NormalPremultipliedAlpha",r[r.ShaderNames_NormalMaskedPremultipliedAlpha=2]="ShaderNames_NormalMaskedPremultipliedAlpha",r[r.ShaderNames_NomralMaskedInvertedPremultipliedAlpha=3]="ShaderNames_NomralMaskedInvertedPremultipliedAlpha",r[r.ShaderNames_AddPremultipliedAlpha=4]="ShaderNames_AddPremultipliedAlpha",r[r.ShaderNames_AddMaskedPremultipliedAlpha=5]="ShaderNames_AddMaskedPremultipliedAlpha",r[r.ShaderNames_AddMaskedPremultipliedAlphaInverted=6]="ShaderNames_AddMaskedPremultipliedAlphaInverted",r[r.ShaderNames_MultPremultipliedAlpha=7]="ShaderNames_MultPremultipliedAlpha",r[r.ShaderNames_MultMaskedPremultipliedAlpha=8]="ShaderNames_MultMaskedPremultipliedAlpha",r[r.ShaderNames_MultMaskedPremultipliedAlphaInverted=9]="ShaderNames_MultMaskedPremultipliedAlphaInverted"})(Gt||(Gt={}));const jo="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_myPos;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_clipMatrix * a_position;   v_myPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",Ho="precision mediump float;varying vec2       v_texCoord;varying vec4       v_myPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;void main(){   float isInside =        step(u_baseColor.x, v_myPos.x/v_myPos.w)       * step(u_baseColor.y, v_myPos.y/v_myPos.w)       * step(v_myPos.x/v_myPos.w, u_baseColor.z)       * step(v_myPos.y/v_myPos.w, u_baseColor.w);   gl_FragColor = u_channelFlag * texture2D(s_texture0, v_texCoord).a * isInside;}",Wo="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;uniform mat4       u_matrix;void main(){   gl_Position = u_matrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",ls="attribute vec4     a_position;attribute vec2     a_texCoord;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform mat4       u_matrix;uniform mat4       u_clipMatrix;void main(){   gl_Position = u_matrix * a_position;   v_clipPos = u_clipMatrix * a_position;   v_texCoord = a_texCoord;   v_texCoord.y = 1.0 - v_texCoord.y;}",$o="precision mediump float;varying vec2       v_texCoord;uniform vec4       u_baseColor;uniform sampler2D  s_texture0;uniform vec4       u_multiplyColor;uniform vec4       u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 color = texColor * u_baseColor;   gl_FragColor = vec4(color.rgb, color.a);}",qo="precision mediump float;varying vec2       v_texCoord;varying vec4       v_clipPos;uniform vec4       u_baseColor;uniform vec4       u_channelFlag;uniform sampler2D  s_texture0;uniform sampler2D  s_texture1;uniform vec4       u_multiplyColor;uniform vec4       u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 col_formask = texColor * u_baseColor;   vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;   float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;   col_formask = col_formask * maskVal;   gl_FragColor = col_formask;}",Jo="precision mediump float;varying vec2      v_texCoord;varying vec4      v_clipPos;uniform sampler2D s_texture0;uniform sampler2D s_texture1;uniform vec4      u_channelFlag;uniform vec4      u_baseColor;uniform vec4      u_multiplyColor;uniform vec4      u_screenColor;void main(){   vec4 texColor = texture2D(s_texture0, v_texCoord);   texColor.rgb = texColor.rgb * u_multiplyColor.rgb;   texColor.rgb = (texColor.rgb + u_screenColor.rgb * texColor.a) - (texColor.rgb * u_screenColor.rgb);   vec4 col_formask = texColor * u_baseColor;   vec4 clipMask = (1.0 - texture2D(s_texture1, v_clipPos.xy / v_clipPos.w)) * u_channelFlag;   float maskVal = clipMask.r + clipMask.g + clipMask.b + clipMask.a;   col_formask = col_formask * (1.0 - maskVal);   gl_FragColor = col_formask;}";class Vi extends Pe{constructor(){super();n(this,"_textures");n(this,"_sortedDrawableIndexList");n(this,"_clippingManager");n(this,"_clippingContextBufferForMask");n(this,"_clippingContextBufferForDraw");n(this,"_rendererProfile");n(this,"firstDraw");n(this,"_bufferData");n(this,"_extension");n(this,"gl");this._clippingContextBufferForMask=null,this._clippingContextBufferForDraw=null,this._rendererProfile=new Go,this.firstDraw=!0,this._textures=new ft,this._sortedDrawableIndexList=new L,this._bufferData={vertex:WebGLBuffer=null,uv:WebGLBuffer=null,index:WebGLBuffer=null},this._textures.prepareCapacity(32,!0)}initialize(e,i=1){e.isUsingMasking()&&(this._clippingManager=new Bi,this._clippingManager.initialize(e,e.getDrawableCount(),e.getDrawableMasks(),e.getDrawableMaskCounts(),i)),this._sortedDrawableIndexList.resize(e.getDrawableCount(),0),super.initialize(e)}bindTexture(e,i){this._textures.setValue(e,i)}getBindedTextures(){return this._textures}setClippingMaskBufferSize(e){if(!this._model.isUsingMasking())return;const i=this._clippingManager.getRenderTextureCount();this._clippingManager.release(),this._clippingManager=void 0,this._clippingManager=null,this._clippingManager=new Bi,this._clippingManager.setClippingMaskBufferSize(e),this._clippingManager.initialize(this.getModel(),this.getModel().getDrawableCount(),this.getModel().getDrawableMasks(),this.getModel().getDrawableMaskCounts(),i)}getClippingMaskBufferSize(){return this._model.isUsingMasking()?this._clippingManager.getClippingMaskBufferSize():-1}getRenderTextureCount(){return this._model.isUsingMasking()?this._clippingManager.getRenderTextureCount():-1}release(){this._clippingManager&&(this._clippingManager.release(),this._clippingManager=void 0,this._clippingManager=null),this.gl!=null&&(this.gl.deleteBuffer(this._bufferData.vertex),this._bufferData.vertex=null,this.gl.deleteBuffer(this._bufferData.uv),this._bufferData.uv=null,this.gl.deleteBuffer(this._bufferData.index),this._bufferData.index=null,this._bufferData=null,this._textures=null)}doDrawModel(){if(this.gl==null){ut(`'gl' is null. WebGLRenderingContext is required.
Please call 'CubimRenderer_WebGL.startUp' function.`);return}this._clippingManager!=null&&(this.preDraw(),this._clippingManager.setupClippingContext(this.getModel(),this)),this.preDraw();const e=this.getModel().getDrawableCount(),i=this.getModel().getDrawableRenderOrders();for(let s=0;s<e;++s){const a=i[s];this._sortedDrawableIndexList.set(a,s)}for(let s=0;s<e;++s){const a=this._sortedDrawableIndexList.at(s);if(!this.getModel().getDrawableDynamicFlagIsVisible(a))continue;const o=this._clippingManager!=null?this._clippingManager.getClippingContextListForDraw().at(a):null;if(o!=null&&this.isUsingHighPrecisionMask()){o._isUsing&&(this.gl.viewport(0,0,this._clippingManager.getClippingMaskBufferSize(),this._clippingManager.getClippingMaskBufferSize()),this.preDraw(),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,o.getClippingManager().getMaskRenderTexture().at(o._bufferIndex)),this.gl.clearColor(1,1,1,1),this.gl.clear(this.gl.COLOR_BUFFER_BIT));{const l=o._clippingIdCount;for(let c=0;c<l;c++){const g=o._clippingIdList[c];this._model.getDrawableDynamicFlagVertexPositionsDidChange(g)&&(this.setIsCulling(this._model.getDrawableCulling(g)!=!1),this.setClippingContextBufferForMask(o),this.drawMesh(this.getModel().getDrawableTextureIndex(g),this.getModel().getDrawableVertexIndexCount(g),this.getModel().getDrawableVertexCount(g),this.getModel().getDrawableVertexIndices(g),this.getModel().getDrawableVertices(g),this.getModel().getDrawableVertexUvs(g),this.getModel().getMultiplyColor(g),this.getModel().getScreenColor(g),this.getModel().getDrawableOpacity(g),Bt.CubismBlendMode_Normal,!1))}}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,qe),this.setClippingContextBufferForMask(null),this.gl.viewport(Rt[0],Rt[1],Rt[2],Rt[3]),this.preDraw()}this.setClippingContextBufferForDraw(o),this.setIsCulling(this.getModel().getDrawableCulling(a)),this.drawMesh(this.getModel().getDrawableTextureIndex(a),this.getModel().getDrawableVertexIndexCount(a),this.getModel().getDrawableVertexCount(a),this.getModel().getDrawableVertexIndices(a),this.getModel().getDrawableVertices(a),this.getModel().getDrawableVertexUvs(a),this.getModel().getMultiplyColor(a),this.getModel().getScreenColor(a),this.getModel().getDrawableOpacity(a),this.getModel().getDrawableBlendMode(a),this.getModel().getDrawableInvertedMaskBit(a))}}drawMesh(e,i,s,a,o,l,c,g,f,p,C){this.isCulling()?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this.gl.frontFace(this.gl.CCW);const v=this.getModelColor();this.getClippingContextBufferForMask()==null&&(v.A*=f,this.isPremultipliedAlpha()&&(v.R*=v.A,v.G*=v.A,v.B*=v.A));let S;this._textures.getValue(e)!=null?S=this._textures.getValue(e):S=null,se.getInstance().setupShaderProgram(this,S,s,o,a,l,this._bufferData,f,p,v,c,g,this.isPremultipliedAlpha(),this.getMvpMatrix(),C),this.gl.drawElements(this.gl.TRIANGLES,i,this.gl.UNSIGNED_SHORT,0),this.gl.useProgram(null),this.setClippingContextBufferForDraw(null),this.setClippingContextBufferForMask(null)}saveProfile(){this._rendererProfile.save()}restoreProfile(){this._rendererProfile.restore()}static doStaticRelease(){se.deleteInstance()}setRenderState(e,i){qe=e,Rt=i}preDraw(){if(this.firstDraw&&(this.firstDraw=!1),this.gl.disable(this.gl.SCISSOR_TEST),this.gl.disable(this.gl.STENCIL_TEST),this.gl.disable(this.gl.DEPTH_TEST),this.gl.frontFace(this.gl.CW),this.gl.enable(this.gl.BLEND),this.gl.colorMask(!0,!0,!0,!0),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,null),this.getAnisotropy()>0&&this._extension)for(let e=0;e<this._textures.getSize();++e)this.gl.bindTexture(this.gl.TEXTURE_2D,this._textures.getValue(e)),this.gl.texParameterf(this.gl.TEXTURE_2D,this._extension.TEXTURE_MAX_ANISOTROPY_EXT,this.getAnisotropy())}setClippingContextBufferForMask(e){this._clippingContextBufferForMask=e}getClippingContextBufferForMask(){return this._clippingContextBufferForMask}setClippingContextBufferForDraw(e){this._clippingContextBufferForDraw=e}getClippingContextBufferForDraw(){return this._clippingContextBufferForDraw}startUp(e){this.gl=e,this._clippingManager&&this._clippingManager.setGL(e),se.getInstance().setGl(e),this._rendererProfile.setGl(e),this._extension=this.gl.getExtension("EXT_texture_filter_anisotropic")||this.gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic")||this.gl.getExtension("MOZ_EXT_texture_filter_anisotropic")}}Pe.staticRelease=()=>{Vi.doStaticRelease()};var us;(function(r){r.CubismClippingContext=Ws,r.CubismClippingManager_WebGL=Bi,r.CubismRenderTextureResource=Hs,r.CubismRenderer_WebGL=Vi,r.CubismShaderSet=Pi,r.CubismShader_WebGL=se,r.ShaderNames=Gt})(us||(us={}));class hs{constructor(t=!1,e=new ct){n(this,"isOverwritten");n(this,"Color");this.isOverwritten=t,this.Color=e}}class cs{constructor(t=!1,e=new ct){n(this,"isOverwritten");n(this,"Color");this.isOverwritten=t,this.Color=e}}class Ko{constructor(t=!1,e=!1){n(this,"isOverwritten");n(this,"isCulling");this.isOverwritten=t,this.isCulling=e}}class $s{constructor(t){n(this,"_notExistPartOpacities");n(this,"_notExistPartId");n(this,"_notExistParameterValues");n(this,"_notExistParameterId");n(this,"_savedParameters");n(this,"_isOverwrittenModelMultiplyColors");n(this,"_isOverwrittenModelScreenColors");n(this,"_userMultiplyColors");n(this,"_userScreenColors");n(this,"_userPartScreenColors");n(this,"_userPartMultiplyColors");n(this,"_partChildDrawables");n(this,"_model");n(this,"_parameterValues");n(this,"_parameterMaximumValues");n(this,"_parameterMinimumValues");n(this,"_partOpacities");n(this,"_modelOpacity");n(this,"_parameterIds");n(this,"_partIds");n(this,"_drawableIds");n(this,"_isOverwrittenCullings");n(this,"_userCullings");this._model=t,this._parameterValues=null,this._parameterMaximumValues=null,this._parameterMinimumValues=null,this._partOpacities=null,this._savedParameters=new L,this._parameterIds=new L,this._drawableIds=new L,this._partIds=new L,this._isOverwrittenModelMultiplyColors=!1,this._isOverwrittenModelScreenColors=!1,this._isOverwrittenCullings=!1,this._modelOpacity=1,this._userMultiplyColors=new L,this._userScreenColors=new L,this._userCullings=new L,this._userPartMultiplyColors=new L,this._userPartScreenColors=new L,this._partChildDrawables=new L,this._notExistPartId=new ft,this._notExistParameterId=new ft,this._notExistParameterValues=new ft,this._notExistPartOpacities=new ft}update(){this._model.update(),this._model.drawables.resetDynamicFlags()}getPixelsPerUnit(){return this._model==null?0:this._model.canvasinfo.PixelsPerUnit}getCanvasWidth(){return this._model==null?0:this._model.canvasinfo.CanvasWidth/this._model.canvasinfo.PixelsPerUnit}getCanvasHeight(){return this._model==null?0:this._model.canvasinfo.CanvasHeight/this._model.canvasinfo.PixelsPerUnit}saveParameters(){const t=this._model.parameters.count,e=this._savedParameters.getSize();for(let i=0;i<t;++i)i<e?this._savedParameters.set(i,this._parameterValues[i]):this._savedParameters.pushBack(this._parameterValues[i])}getMultiplyColor(t){return this.getOverwriteFlagForModelMultiplyColors()||this.getOverwriteFlagForDrawableMultiplyColors(t)?this._userMultiplyColors.at(t).Color:this.getDrawableMultiplyColor(t)}getScreenColor(t){return this.getOverwriteFlagForModelScreenColors()||this.getOverwriteFlagForDrawableScreenColors(t)?this._userScreenColors.at(t).Color:this.getDrawableScreenColor(t)}setMultiplyColorByTextureColor(t,e){this.setMultiplyColorByRGBA(t,e.R,e.G,e.B,e.A)}setMultiplyColorByRGBA(t,e,i,s,a=1){this._userMultiplyColors.at(t).Color.R=e,this._userMultiplyColors.at(t).Color.G=i,this._userMultiplyColors.at(t).Color.B=s,this._userMultiplyColors.at(t).Color.A=a}setScreenColorByTextureColor(t,e){this.setScreenColorByRGBA(t,e.R,e.G,e.B,e.A)}setScreenColorByRGBA(t,e,i,s,a=1){this._userScreenColors.at(t).Color.R=e,this._userScreenColors.at(t).Color.G=i,this._userScreenColors.at(t).Color.B=s,this._userScreenColors.at(t).Color.A=a}getPartMultiplyColor(t){return this._userPartMultiplyColors.at(t).Color}getPartScreenColor(t){return this._userPartScreenColors.at(t).Color}setPartColor(t,e,i,s,a,o,l){if(o.at(t).Color.R=e,o.at(t).Color.G=i,o.at(t).Color.B=s,o.at(t).Color.A=a,o.at(t).isOverwritten)for(let c=0;c<this._partChildDrawables.at(t).getSize();++c){const g=this._partChildDrawables.at(t).at(c);l.at(g).Color.R=e,l.at(g).Color.G=i,l.at(g).Color.B=s,l.at(g).Color.A=a}}setPartMultiplyColorByTextureColor(t,e){this.setPartMultiplyColorByRGBA(t,e.R,e.G,e.B,e.A)}setPartMultiplyColorByRGBA(t,e,i,s,a){this.setPartColor(t,e,i,s,a,this._userPartMultiplyColors,this._userMultiplyColors)}setPartScreenColorByTextureColor(t,e){this.setPartScreenColorByRGBA(t,e.R,e.G,e.B,e.A)}setPartScreenColorByRGBA(t,e,i,s,a){this.setPartColor(t,e,i,s,a,this._userPartScreenColors,this._userScreenColors)}getOverwriteFlagForModelMultiplyColors(){return this._isOverwrittenModelMultiplyColors}getOverwriteFlagForModelScreenColors(){return this._isOverwrittenModelScreenColors}setOverwriteFlagForModelMultiplyColors(t){this._isOverwrittenModelMultiplyColors=t}setOverwriteFlagForModelScreenColors(t){this._isOverwrittenModelScreenColors=t}getOverwriteFlagForDrawableMultiplyColors(t){return this._userMultiplyColors.at(t).isOverwritten}getOverwriteFlagForDrawableScreenColors(t){return this._userScreenColors.at(t).isOverwritten}setOverwriteFlagForDrawableMultiplyColors(t,e){this._userMultiplyColors.at(t).isOverwritten=e}setOverwriteFlagForDrawableScreenColors(t,e){this._userScreenColors.at(t).isOverwritten=e}getOverwriteColorForPartMultiplyColors(t){return this._userPartMultiplyColors.at(t).isOverwritten}getOverwriteColorForPartScreenColors(t){return this._userPartScreenColors.at(t).isOverwritten}setOverwriteColorForPartColors(t,e,i,s){i.at(t).isOverwritten=e;for(let a=0;a<this._partChildDrawables.at(t).getSize();++a){const o=this._partChildDrawables.at(t).at(a);s.at(o).isOverwritten=e,e&&(s.at(o).Color.R=i.at(t).Color.R,s.at(o).Color.G=i.at(t).Color.G,s.at(o).Color.B=i.at(t).Color.B,s.at(o).Color.A=i.at(t).Color.A)}}setOverwriteColorForPartMultiplyColors(t,e){this._userPartMultiplyColors.at(t).isOverwritten=e,this.setOverwriteColorForPartColors(t,e,this._userPartMultiplyColors,this._userMultiplyColors)}setOverwriteColorForPartScreenColors(t,e){this._userPartScreenColors.at(t).isOverwritten=e,this.setOverwriteColorForPartColors(t,e,this._userPartScreenColors,this._userScreenColors)}getDrawableCulling(t){if(this.getOverwriteFlagForModelCullings()||this.getOverwriteFlagForDrawableCullings(t))return this._userCullings.at(t).isCulling;const e=this._model.drawables.constantFlags;return!Live2DCubismCore.Utils.hasIsDoubleSidedBit(e[t])}setDrawableCulling(t,e){this._userCullings.at(t).isCulling=e}getOverwriteFlagForModelCullings(){return this._isOverwrittenCullings}setOverwriteFlagForModelCullings(t){this._isOverwrittenCullings=t}getOverwriteFlagForDrawableCullings(t){return this._userCullings.at(t).isOverwritten}setOverwriteFlagForDrawableCullings(t,e){this._userCullings.at(t).isOverwritten=e}getModelOapcity(){return this._modelOpacity}setModelOapcity(t){this._modelOpacity=t}getModel(){return this._model}getPartIndex(t){let e;const i=this._model.parts.count;for(e=0;e<i;++e)if(t==this._partIds.at(e))return e;return this._notExistPartId.isExist(t)?this._notExistPartId.getValue(t):(e=i+this._notExistPartId.getSize(),this._notExistPartId.setValue(t,e),this._notExistPartOpacities.appendKey(e),e)}getPartId(t){const e=this._model.parts.ids[t];return j.getIdManager().getId(e)}getPartCount(){return this._model.parts.count}setPartOpacityByIndex(t,e){if(this._notExistPartOpacities.isExist(t)){this._notExistPartOpacities.setValue(t,e);return}vt(0<=t&&t<this.getPartCount()),this._partOpacities[t]=e}setPartOpacityById(t,e){const i=this.getPartIndex(t);i<0||this.setPartOpacityByIndex(i,e)}getPartOpacityByIndex(t){return this._notExistPartOpacities.isExist(t)?this._notExistPartOpacities.getValue(t):(vt(0<=t&&t<this.getPartCount()),this._partOpacities[t])}getPartOpacityById(t){const e=this.getPartIndex(t);return e<0?0:this.getPartOpacityByIndex(e)}getParameterIndex(t){let e;const i=this._model.parameters.count;for(e=0;e<i;++e)if(t==this._parameterIds.at(e))return e;return this._notExistParameterId.isExist(t)?this._notExistParameterId.getValue(t):(e=this._model.parameters.count+this._notExistParameterId.getSize(),this._notExistParameterId.setValue(t,e),this._notExistParameterValues.appendKey(e),e)}getParameterCount(){return this._model.parameters.count}getParameterType(t){return this._model.parameters.types[t]}getParameterMaximumValue(t){return this._model.parameters.maximumValues[t]}getParameterMinimumValue(t){return this._model.parameters.minimumValues[t]}getParameterDefaultValue(t){return this._model.parameters.defaultValues[t]}getParameterValueByIndex(t){return this._notExistParameterValues.isExist(t)?this._notExistParameterValues.getValue(t):(vt(0<=t&&t<this.getParameterCount()),this._parameterValues[t])}getParameterValueById(t){const e=this.getParameterIndex(t);return this.getParameterValueByIndex(e)}setParameterValueByIndex(t,e,i=1){if(this._notExistParameterValues.isExist(t)){this._notExistParameterValues.setValue(t,i==1?e:this._notExistParameterValues.getValue(t)*(1-i)+e*i);return}vt(0<=t&&t<this.getParameterCount()),this._model.parameters.maximumValues[t]<e&&(e=this._model.parameters.maximumValues[t]),this._model.parameters.minimumValues[t]>e&&(e=this._model.parameters.minimumValues[t]),this._parameterValues[t]=i==1?e:this._parameterValues[t]=this._parameterValues[t]*(1-i)+e*i}setParameterValueById(t,e,i=1){const s=this.getParameterIndex(t);this.setParameterValueByIndex(s,e,i)}addParameterValueByIndex(t,e,i=1){this.setParameterValueByIndex(t,this.getParameterValueByIndex(t)+e*i)}addParameterValueById(t,e,i=1){const s=this.getParameterIndex(t);this.addParameterValueByIndex(s,e,i)}multiplyParameterValueById(t,e,i=1){const s=this.getParameterIndex(t);this.multiplyParameterValueByIndex(s,e,i)}multiplyParameterValueByIndex(t,e,i=1){this.setParameterValueByIndex(t,this.getParameterValueByIndex(t)*(1+(e-1)*i))}getDrawableIndex(t){const e=this._model.drawables.count;for(let i=0;i<e;++i)if(this._drawableIds.at(i)==t)return i;return-1}getDrawableCount(){return this._model.drawables.count}getDrawableId(t){const e=this._model.drawables.ids;return j.getIdManager().getId(e[t])}getDrawableRenderOrders(){return this._model.drawables.renderOrders}getDrawableTextureIndices(t){return this.getDrawableTextureIndex(t)}getDrawableTextureIndex(t){return this._model.drawables.textureIndices[t]}getDrawableDynamicFlagVertexPositionsDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVertexPositionsDidChangeBit(e[t])}getDrawableVertexIndexCount(t){return this._model.drawables.indexCounts[t]}getDrawableVertexCount(t){return this._model.drawables.vertexCounts[t]}getDrawableVertices(t){return this.getDrawableVertexPositions(t)}getDrawableVertexIndices(t){return this._model.drawables.indices[t]}getDrawableVertexPositions(t){return this._model.drawables.vertexPositions[t]}getDrawableVertexUvs(t){return this._model.drawables.vertexUvs[t]}getDrawableOpacity(t){return this._model.drawables.opacities[t]}getDrawableMultiplyColor(t){const e=this._model.drawables.multiplyColors,i=t*4,s=new ct;return s.R=e[i],s.G=e[i+1],s.B=e[i+2],s.A=e[i+3],s}getDrawableScreenColor(t){const e=this._model.drawables.screenColors,i=t*4,s=new ct;return s.R=e[i],s.G=e[i+1],s.B=e[i+2],s.A=e[i+3],s}getDrawableParentPartIndex(t){return this._model.drawables.parentPartIndices[t]}getDrawableBlendMode(t){const e=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasBlendAdditiveBit(e[t])?Bt.CubismBlendMode_Additive:Live2DCubismCore.Utils.hasBlendMultiplicativeBit(e[t])?Bt.CubismBlendMode_Multiplicative:Bt.CubismBlendMode_Normal}getDrawableInvertedMaskBit(t){const e=this._model.drawables.constantFlags;return Live2DCubismCore.Utils.hasIsInvertedMaskBit(e[t])}getDrawableMasks(){return this._model.drawables.masks}getDrawableMaskCounts(){return this._model.drawables.maskCounts}isUsingMasking(){for(let t=0;t<this._model.drawables.count;++t)if(!(this._model.drawables.maskCounts[t]<=0))return!0;return!1}getDrawableDynamicFlagIsVisible(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasIsVisibleBit(e[t])}getDrawableDynamicFlagVisibilityDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasVisibilityDidChangeBit(e[t])}getDrawableDynamicFlagOpacityDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasOpacityDidChangeBit(e[t])}getDrawableDynamicFlagRenderOrderDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasRenderOrderDidChangeBit(e[t])}getDrawableDynamicFlagBlendColorDidChange(t){const e=this._model.drawables.dynamicFlags;return Live2DCubismCore.Utils.hasBlendColorDidChangeBit(e[t])}loadParameters(){let t=this._model.parameters.count;const e=this._savedParameters.getSize();t>e&&(t=e);for(let i=0;i<t;++i)this._parameterValues[i]=this._savedParameters.at(i)}initialize(){vt(this._model),this._parameterValues=this._model.parameters.values,this._partOpacities=this._model.parts.opacities,this._parameterMaximumValues=this._model.parameters.maximumValues,this._parameterMinimumValues=this._model.parameters.minimumValues;{const e=this._model.parameters.ids,i=this._model.parameters.count;this._parameterIds.prepareCapacity(i);for(let s=0;s<i;++s)this._parameterIds.pushBack(j.getIdManager().getId(e[s]))}const t=this._model.parts.count;{const e=this._model.parts.ids;this._partIds.prepareCapacity(t);for(let i=0;i<t;++i)this._partIds.pushBack(j.getIdManager().getId(e[i]));this._userPartMultiplyColors.prepareCapacity(t),this._userPartScreenColors.prepareCapacity(t),this._partChildDrawables.prepareCapacity(t)}{const e=this._model.drawables.ids,i=this._model.drawables.count;this._userMultiplyColors.prepareCapacity(i),this._userScreenColors.prepareCapacity(i),this._userCullings.prepareCapacity(i);const s=new Ko(!1,!1);for(let a=0;a<t;++a){const o=new ct(1,1,1,1),l=new ct(0,0,0,1),c=new cs(!1,o),g=new cs(!1,l);this._userPartMultiplyColors.pushBack(c),this._userPartScreenColors.pushBack(g),this._partChildDrawables.pushBack(new L),this._partChildDrawables.at(a).prepareCapacity(i)}for(let a=0;a<i;++a){const o=new ct(1,1,1,1),l=new ct(0,0,0,1),c=new hs(!1,o),g=new hs(!1,l);this._drawableIds.pushBack(j.getIdManager().getId(e[a])),this._userMultiplyColors.pushBack(c),this._userScreenColors.pushBack(g),this._userCullings.pushBack(s);const f=this.getDrawableParentPartIndex(a);f>=0&&this._partChildDrawables.at(f).pushBack(a)}}}release(){this._model.release(),this._model=null}}var gs;(function(r){r.CubismModel=$s})(gs||(gs={}));class Ie{constructor(t){n(this,"_moc");n(this,"_modelCount");n(this,"_mocVersion");this._moc=t,this._modelCount=0,this._mocVersion=0}static create(t,e){let i=null;if(e&&!this.hasMocConsistency(t))return ut("Inconsistent MOC3."),i;const s=Live2DCubismCore.Moc.fromArrayBuffer(t);return s&&(i=new Ie(s),i._mocVersion=Live2DCubismCore.Version.csmGetMocVersion(s,t)),i}static delete(t){t._moc._release(),t._moc=null,t=null}createModel(){let t=null;const e=Live2DCubismCore.Model.fromMoc(this._moc);return e&&(t=new $s(e),t.initialize(),++this._modelCount),t}deleteModel(t){t!=null&&(t.release(),t=null,--this._modelCount)}release(){vt(this._modelCount==0),this._moc._release(),this._moc=null}getLatestMocVersion(){return Live2DCubismCore.Version.csmGetLatestMocVersion()}getMocVersion(){return this._mocVersion}static hasMocConsistency(t){return Live2DCubismCore.Moc.prototype.hasMocConsistency(t)===1}}var ds;(function(r){r.CubismMoc=Ie})(ds||(ds={}));const _s="Meta",Zo="UserDataCount",Qo="TotalUserDataSize",yi="UserData",tl="Target",el="Id",il="Value";class qs{constructor(t,e){n(this,"_json");this._json=nt.create(t,e)}release(){nt.delete(this._json)}getUserDataCount(){return this._json.getRoot().getValueByString(_s).getValueByString(Zo).toInt()}getTotalUserDataSize(){return this._json.getRoot().getValueByString(_s).getValueByString(Qo).toInt()}getUserDataTargetType(t){return this._json.getRoot().getValueByString(yi).getValueByIndex(t).getValueByString(tl).getRawString()}getUserDataId(t){return j.getIdManager().getId(this._json.getRoot().getValueByString(yi).getValueByIndex(t).getValueByString(el).getRawString())}getUserDataValue(t){return this._json.getRoot().getValueByString(yi).getValueByIndex(t).getValueByString(il).getRawString()}}var fs;(function(r){r.CubismModelUserDataJson=qs})(fs||(fs={}));const rl="ArtMesh";class Js{constructor(){n(this,"targetType");n(this,"targetId");n(this,"value")}}class Be{constructor(){n(this,"_userDataNodes");n(this,"_artMeshUserDataNode");this._userDataNodes=new L,this._artMeshUserDataNode=new L}static create(t,e){const i=new Be;return i.parseUserData(t,e),i}static delete(t){t!=null&&(t.release(),t=null)}getArtMeshUserDatas(){return this._artMeshUserDataNode}parseUserData(t,e){let i=new qs(t,e);const s=j.getIdManager().getId(rl),a=i.getUserDataCount();for(let o=0;o<a;o++){const l=new Js;l.targetId=i.getUserDataId(o),l.targetType=j.getIdManager().getId(i.getUserDataTargetType(o)),l.value=new St(i.getUserDataValue(o)),this._userDataNodes.pushBack(l),l.targetType==s&&this._artMeshUserDataNode.pushBack(l)}i.release(),i=void 0}release(){for(let t=0;t<this._userDataNodes.getSize();++t)this._userDataNodes.set(t,null);this._userDataNodes=null}}var ms;(function(r){r.CubismModelUserData=Be,r.CubismModelUserDataNode=Js})(ms||(ms={}));class Ze{constructor(){n(this,"loadMotion",(t,e,i,s)=>Ke.create(t,e,s));n(this,"_moc");n(this,"_model");n(this,"_motionManager");n(this,"_expressionManager");n(this,"_eyeBlink");n(this,"_breath");n(this,"_modelMatrix");n(this,"_pose");n(this,"_dragManager");n(this,"_physics");n(this,"_modelUserData");n(this,"_initialized");n(this,"_updating");n(this,"_opacity");n(this,"_lipsync");n(this,"_lastLipSyncValue");n(this,"_dragX");n(this,"_dragY");n(this,"_accelerationX");n(this,"_accelerationY");n(this,"_accelerationZ");n(this,"_mocConsistency");n(this,"_debugMode");n(this,"_renderer");this._moc=null,this._model=null,this._motionManager=null,this._expressionManager=null,this._eyeBlink=null,this._breath=null,this._modelMatrix=null,this._pose=null,this._dragManager=null,this._physics=null,this._modelUserData=null,this._initialized=!1,this._updating=!1,this._opacity=1,this._lipsync=!0,this._lastLipSyncValue=0,this._dragX=0,this._dragY=0,this._accelerationX=0,this._accelerationY=0,this._accelerationZ=0,this._mocConsistency=!1,this._debugMode=!1,this._renderer=null,this._motionManager=new Ci,this._motionManager.setEventCallback(Ze.cubismDefaultMotionEventCallback,this),this._expressionManager=new Ci,this._dragManager=new Rs}isInitialized(){return this._initialized}setInitialized(t){this._initialized=t}isUpdating(){return this._updating}setUpdating(t){this._updating=t}setDragging(t,e){this._dragManager.set(t,e)}setAcceleration(t,e,i){this._accelerationX=t,this._accelerationY=e,this._accelerationZ=i}getModelMatrix(){return this._modelMatrix}setOpacity(t){this._opacity=t}getOpacity(){return this._opacity}loadModel(t,e=!1){if(this._moc=Ie.create(t,e),this._moc==null){ut("Failed to CubismMoc.create().");return}if(this._model=this._moc.createModel(),this._model==null){ut("Failed to CreateModel().");return}this._model.saveParameters(),this._modelMatrix=new Ts(this._model.getCanvasWidth(),this._model.getCanvasHeight())}loadExpression(t,e,i){return Je.create(t,e)}loadPose(t,e){this._pose=xe.create(t,e)}loadUserData(t,e){this._modelUserData=Be.create(t,e)}loadPhysics(t,e){this._physics=Me.create(t,e)}isHit(t,e,i){const s=this._model.getDrawableIndex(t);if(s<0)return!1;const a=this._model.getDrawableVertexCount(s),o=this._model.getDrawableVertices(s);let l=o[0],c=o[0],g=o[1],f=o[1];for(let v=1;v<a;++v){const S=o[Ot.vertexOffset+v*Ot.vertexStep],x=o[Ot.vertexOffset+v*Ot.vertexStep+1];S<l&&(l=S),S>c&&(c=S),x<g&&(g=x),x>f&&(f=x)}const p=this._modelMatrix.invertTransformX(e),C=this._modelMatrix.invertTransformY(i);return l<=p&&p<=c&&g<=C&&C<=f}getModel(){return this._model}getRenderer(){return this._renderer}createRenderer(t=1){this._renderer&&this.deleteRenderer(),this._renderer=new Vi,this._renderer.initialize(this._model,t)}deleteRenderer(){this._renderer!=null&&(this._renderer.release(),this._renderer=null)}motionEventFired(t){Mt("{0}",t.s)}static cubismDefaultMotionEventCallback(t,e,i){const s=i;s!=null&&s.motionEventFired(e)}release(){this._motionManager!=null&&(this._motionManager.release(),this._motionManager=null),this._expressionManager!=null&&(this._expressionManager.release(),this._expressionManager=null),this._moc!=null&&(this._moc.deleteModel(this._model),this._moc.release(),this._moc=null),this._modelMatrix=null,xe.delete(this._pose),Se.delete(this._eyeBlink),be.delete(this._breath),this._dragManager=null,Me.delete(this._physics),Be.delete(this._modelUserData),this.deleteRenderer()}}var ps;(function(r){r.CubismUserModel=Ze})(ps||(ps={}));class H{static getDeltaTime(){return this.s_deltaTime}static updateTime(){this.s_currentFrame=Date.now(),this.s_deltaTime=(this.s_currentFrame-this.s_lastFrame)/1e3,this.s_lastFrame=this.s_currentFrame}static printMessage(t){console.log(t)}}n(H,"lastUpdate",Date.now()),n(H,"s_currentFrame",0),n(H,"s_lastFrame",0),n(H,"s_deltaTime",0);let Zt=null;class Ei{constructor(){n(this,"_pcmData");n(this,"_userTimeSeconds");n(this,"_lastRms");n(this,"_sampleOffset");n(this,"_wavFileInfo");n(this,"_byteReader");n(this,"_loadFiletoBytes",(t,e)=>{this._byteReader._fileByte=t,this._byteReader._fileDataView=new DataView(this._byteReader._fileByte),this._byteReader._fileSize=e});this._pcmData=null,this._userTimeSeconds=0,this._lastRms=0,this._sampleOffset=0,this._wavFileInfo=new sl,this._byteReader=new al}static getInstance(){return Zt==null&&(Zt=new Ei),Zt}static releaseInstance(){Zt!=null&&(Zt=void 0),Zt=null}update(t){let e,i;if(this._pcmData==null||this._sampleOffset>=this._wavFileInfo._samplesPerChannel)return this._lastRms=0,!1;this._userTimeSeconds+=t,e=Math.floor(this._userTimeSeconds*this._wavFileInfo._samplingRate),e>this._wavFileInfo._samplesPerChannel&&(e=this._wavFileInfo._samplesPerChannel),i=0;for(let s=0;s<this._wavFileInfo._numberOfChannels;s++)for(let a=this._sampleOffset;a<e;a++){const o=this._pcmData[s][a];i+=o*o}return i=Math.sqrt(i/(this._wavFileInfo._numberOfChannels*(e-this._sampleOffset))),this._lastRms=i,this._sampleOffset=e,!0}start(t){this._sampleOffset=0,this._userTimeSeconds=0,this._lastRms=0,this.loadWavFile(t)}getRms(){return this._lastRms}loadWavFile(t){let e=!1;this._pcmData!=null&&this.releasePcmData();const i=async()=>fetch(t).then(s=>s.arrayBuffer());return(async()=>{if(this._byteReader._fileByte=await i(),this._byteReader._fileDataView=new DataView(this._byteReader._fileByte),this._byteReader._fileSize=this._byteReader._fileByte.byteLength,this._byteReader._readOffset=0,this._byteReader._fileByte==null||this._byteReader._fileSize<4)return!1;this._wavFileInfo._fileName=t;try{if(!this._byteReader.getCheckSignature("RIFF"))throw e=!1,new Error('Cannot find Signeture "RIFF".');if(this._byteReader.get32LittleEndian(),!this._byteReader.getCheckSignature("WAVE"))throw e=!1,new Error('Cannot find Signeture "WAVE".');if(!this._byteReader.getCheckSignature("fmt "))throw e=!1,new Error('Cannot find Signeture "fmt".');const s=this._byteReader.get32LittleEndian();if(this._byteReader.get16LittleEndian()!=1)throw e=!1,new Error("File is not linear PCM.");for(this._wavFileInfo._numberOfChannels=this._byteReader.get16LittleEndian(),this._wavFileInfo._samplingRate=this._byteReader.get32LittleEndian(),this._byteReader.get32LittleEndian(),this._byteReader.get16LittleEndian(),this._wavFileInfo._bitsPerSample=this._byteReader.get16LittleEndian(),s>16&&(this._byteReader._readOffset+=s-16);!this._byteReader.getCheckSignature("data")&&this._byteReader._readOffset<this._byteReader._fileSize;)this._byteReader._readOffset+=this._byteReader.get32LittleEndian()+4;if(this._byteReader._readOffset>=this._byteReader._fileSize)throw e=!1,new Error('Cannot find "data" Chunk.');{const a=this._byteReader.get32LittleEndian();this._wavFileInfo._samplesPerChannel=a*8/(this._wavFileInfo._bitsPerSample*this._wavFileInfo._numberOfChannels)}this._pcmData=new Array(this._wavFileInfo._numberOfChannels);for(let a=0;a<this._wavFileInfo._numberOfChannels;a++)this._pcmData[a]=new Float32Array(this._wavFileInfo._samplesPerChannel);for(let a=0;a<this._wavFileInfo._samplesPerChannel;a++)for(let o=0;o<this._wavFileInfo._numberOfChannels;o++)this._pcmData[o][a]=this.getPcmSample();e=!0}catch(s){console.log(s)}})(),e}getPcmSample(){let t;switch(this._wavFileInfo._bitsPerSample){case 8:t=this._byteReader.get8()-128,t<<=24;break;case 16:t=this._byteReader.get16LittleEndian()<<16;break;case 24:t=this._byteReader.get24LittleEndian()<<8;break;default:t=0;break}return t/2147483647}releasePcmData(){for(let t=0;t<this._wavFileInfo._numberOfChannels;t++)delete this._pcmData[t];delete this._pcmData,this._pcmData=null}}class sl{constructor(){n(this,"_fileName");n(this,"_numberOfChannels");n(this,"_bitsPerSample");n(this,"_samplingRate");n(this,"_samplesPerChannel");this._fileName="",this._numberOfChannels=0,this._bitsPerSample=0,this._samplingRate=0,this._samplesPerChannel=0}}class al{constructor(){n(this,"_fileByte");n(this,"_fileDataView");n(this,"_fileSize");n(this,"_readOffset");this._fileByte=null,this._fileDataView=null,this._fileSize=0,this._readOffset=0}get8(){const t=this._fileDataView.getUint8(this._readOffset);return this._readOffset++,t}get16LittleEndian(){const t=this._fileDataView.getUint8(this._readOffset+1)<<8|this._fileDataView.getUint8(this._readOffset);return this._readOffset+=2,t}get24LittleEndian(){const t=this._fileDataView.getUint8(this._readOffset+2)<<16|this._fileDataView.getUint8(this._readOffset+1)<<8|this._fileDataView.getUint8(this._readOffset);return this._readOffset+=3,t}get32LittleEndian(){const t=this._fileDataView.getUint8(this._readOffset+3)<<24|this._fileDataView.getUint8(this._readOffset+2)<<16|this._fileDataView.getUint8(this._readOffset+1)<<8|this._fileDataView.getUint8(this._readOffset);return this._readOffset+=4,t}getCheckSignature(t){const e=new Uint8Array(4),i=new TextEncoder().encode(t);if(t.length!=4)return!1;for(let s=0;s<4;s++)e[s]=this.get8();return e[0]==i[0]&&e[1]==i[1]&&e[2]==i[2]&&e[3]==i[3]}}var ke=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function nl(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}function Ue(r){throw new Error('Could not dynamically require "'+r+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ks={exports:{}};/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/(function(r,t){(function(e){r.exports=e()})(function(){return function e(i,s,a){function o(g,f){if(!s[g]){if(!i[g]){var p=typeof Ue=="function"&&Ue;if(!f&&p)return p(g,!0);if(l)return l(g,!0);var C=new Error("Cannot find module '"+g+"'");throw C.code="MODULE_NOT_FOUND",C}var v=s[g]={exports:{}};i[g][0].call(v.exports,function(S){var x=i[g][1][S];return o(x||S)},v,v.exports,e,i,s,a)}return s[g].exports}for(var l=typeof Ue=="function"&&Ue,c=0;c<a.length;c++)o(a[c]);return o}({1:[function(e,i,s){(function(a){var o=a.MutationObserver||a.WebKitMutationObserver,l;if(o){var c=0,g=new o(S),f=a.document.createTextNode("");g.observe(f,{characterData:!0}),l=function(){f.data=c=++c%2}}else if(!a.setImmediate&&typeof a.MessageChannel<"u"){var p=new a.MessageChannel;p.port1.onmessage=S,l=function(){p.port2.postMessage(0)}}else"document"in a&&"onreadystatechange"in a.document.createElement("script")?l=function(){var M=a.document.createElement("script");M.onreadystatechange=function(){S(),M.onreadystatechange=null,M.parentNode.removeChild(M),M=null},a.document.documentElement.appendChild(M)}:l=function(){setTimeout(S,0)};var C,v=[];function S(){C=!0;for(var M,D,w=v.length;w;){for(D=v,v=[],M=-1;++M<w;)D[M]();w=v.length}C=!1}i.exports=x;function x(M){v.push(M)===1&&!C&&l()}}).call(this,typeof ke<"u"?ke:typeof self<"u"?self:typeof window<"u"?window:{})},{}],2:[function(e,i,s){var a=e(1);function o(){}var l={},c=["REJECTED"],g=["FULFILLED"],f=["PENDING"];i.exports=p;function p(B){if(typeof B!="function")throw new TypeError("resolver must be a function");this.state=f,this.queue=[],this.outcome=void 0,B!==o&&x(this,B)}p.prototype.catch=function(B){return this.then(null,B)},p.prototype.then=function(B,I){if(typeof B!="function"&&this.state===g||typeof I!="function"&&this.state===c)return this;var F=new this.constructor(o);if(this.state!==f){var Y=this.state===g?B:I;v(F,Y,this.outcome)}else this.queue.push(new C(F,B,I));return F};function C(B,I,F){this.promise=B,typeof I=="function"&&(this.onFulfilled=I,this.callFulfilled=this.otherCallFulfilled),typeof F=="function"&&(this.onRejected=F,this.callRejected=this.otherCallRejected)}C.prototype.callFulfilled=function(B){l.resolve(this.promise,B)},C.prototype.otherCallFulfilled=function(B){v(this.promise,this.onFulfilled,B)},C.prototype.callRejected=function(B){l.reject(this.promise,B)},C.prototype.otherCallRejected=function(B){v(this.promise,this.onRejected,B)};function v(B,I,F){a(function(){var Y;try{Y=I(F)}catch(J){return l.reject(B,J)}Y===B?l.reject(B,new TypeError("Cannot resolve promise with itself")):l.resolve(B,Y)})}l.resolve=function(B,I){var F=M(S,I);if(F.status==="error")return l.reject(B,F.value);var Y=F.value;if(Y)x(B,Y);else{B.state=g,B.outcome=I;for(var J=-1,it=B.queue.length;++J<it;)B.queue[J].callFulfilled(I)}return B},l.reject=function(B,I){B.state=c,B.outcome=I;for(var F=-1,Y=B.queue.length;++F<Y;)B.queue[F].callRejected(I);return B};function S(B){var I=B&&B.then;if(B&&(typeof B=="object"||typeof B=="function")&&typeof I=="function")return function(){I.apply(B,arguments)}}function x(B,I){var F=!1;function Y(at){F||(F=!0,l.reject(B,at))}function J(at){F||(F=!0,l.resolve(B,at))}function it(){I(J,Y)}var st=M(it);st.status==="error"&&Y(st.value)}function M(B,I){var F={};try{F.value=B(I),F.status="success"}catch(Y){F.status="error",F.value=Y}return F}p.resolve=D;function D(B){return B instanceof this?B:l.resolve(new this(o),B)}p.reject=w;function w(B){var I=new this(o);return l.reject(I,B)}p.all=O;function O(B){var I=this;if(Object.prototype.toString.call(B)!=="[object Array]")return this.reject(new TypeError("must be an array"));var F=B.length,Y=!1;if(!F)return this.resolve([]);for(var J=new Array(F),it=0,st=-1,at=new this(o);++st<F;)xt(B[st],st);return at;function xt(oe,we){I.resolve(oe).then(Qe,function(Wt){Y||(Y=!0,l.reject(at,Wt))});function Qe(Wt){J[we]=Wt,++it===F&&!Y&&(Y=!0,l.resolve(at,J))}}}p.race=U;function U(B){var I=this;if(Object.prototype.toString.call(B)!=="[object Array]")return this.reject(new TypeError("must be an array"));var F=B.length,Y=!1;if(!F)return this.resolve([]);for(var J=-1,it=new this(o);++J<F;)st(B[J]);return it;function st(at){I.resolve(at).then(function(xt){Y||(Y=!0,l.resolve(it,xt))},function(xt){Y||(Y=!0,l.reject(it,xt))})}}},{1:1}],3:[function(e,i,s){(function(a){typeof a.Promise!="function"&&(a.Promise=e(2))}).call(this,typeof ke<"u"?ke:typeof self<"u"?self:typeof window<"u"?window:{})},{2:2}],4:[function(e,i,s){var a=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(u){return typeof u}:function(u){return u&&typeof Symbol=="function"&&u.constructor===Symbol&&u!==Symbol.prototype?"symbol":typeof u};function o(u,d){if(!(u instanceof d))throw new TypeError("Cannot call a class as a function")}function l(){try{if(typeof indexedDB<"u")return indexedDB;if(typeof webkitIndexedDB<"u")return webkitIndexedDB;if(typeof mozIndexedDB<"u")return mozIndexedDB;if(typeof OIndexedDB<"u")return OIndexedDB;if(typeof msIndexedDB<"u")return msIndexedDB}catch{return}}var c=l();function g(){try{if(!c||!c.open)return!1;var u=typeof openDatabase<"u"&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),d=typeof fetch=="function"&&fetch.toString().indexOf("[native code")!==-1;return(!u||d)&&typeof indexedDB<"u"&&typeof IDBKeyRange<"u"}catch{return!1}}function f(u,d){u=u||[],d=d||{};try{return new Blob(u,d)}catch(_){if(_.name!=="TypeError")throw _;for(var h=typeof BlobBuilder<"u"?BlobBuilder:typeof MSBlobBuilder<"u"?MSBlobBuilder:typeof MozBlobBuilder<"u"?MozBlobBuilder:WebKitBlobBuilder,m=new h,y=0;y<u.length;y+=1)m.append(u[y]);return m.getBlob(d.type)}}typeof Promise>"u"&&e(3);var p=Promise;function C(u,d){d&&u.then(function(h){d(null,h)},function(h){d(h)})}function v(u,d,h){typeof d=="function"&&u.then(d),typeof h=="function"&&u.catch(h)}function S(u){return typeof u!="string"&&(console.warn(u+" used as a key, but it is not a string."),u=String(u)),u}function x(){if(arguments.length&&typeof arguments[arguments.length-1]=="function")return arguments[arguments.length-1]}var M="local-forage-detect-blob-support",D=void 0,w={},O=Object.prototype.toString,U="readonly",B="readwrite";function I(u){for(var d=u.length,h=new ArrayBuffer(d),m=new Uint8Array(h),y=0;y<d;y++)m[y]=u.charCodeAt(y);return h}function F(u){return new p(function(d){var h=u.transaction(M,B),m=f([""]);h.objectStore(M).put(m,"key"),h.onabort=function(y){y.preventDefault(),y.stopPropagation(),d(!1)},h.oncomplete=function(){var y=navigator.userAgent.match(/Chrome\/(\d+)/),_=navigator.userAgent.match(/Edge\//);d(_||!y||parseInt(y[1],10)>=43)}}).catch(function(){return!1})}function Y(u){return typeof D=="boolean"?p.resolve(D):F(u).then(function(d){return D=d,D})}function J(u){var d=w[u.name],h={};h.promise=new p(function(m,y){h.resolve=m,h.reject=y}),d.deferredOperations.push(h),d.dbReady?d.dbReady=d.dbReady.then(function(){return h.promise}):d.dbReady=h.promise}function it(u){var d=w[u.name],h=d.deferredOperations.pop();if(h)return h.resolve(),h.promise}function st(u,d){var h=w[u.name],m=h.deferredOperations.pop();if(m)return m.reject(d),m.promise}function at(u,d){return new p(function(h,m){if(w[u.name]=w[u.name]||Ai(),u.db)if(d)J(u),u.db.close();else return h(u.db);var y=[u.name];d&&y.push(u.version);var _=c.open.apply(c,y);d&&(_.onupgradeneeded=function(P){var b=_.result;try{b.createObjectStore(u.storeName),P.oldVersion<=1&&b.createObjectStore(M)}catch(T){if(T.name==="ConstraintError")console.warn('The database "'+u.name+'" has been upgraded from version '+P.oldVersion+" to version "+P.newVersion+', but the storage "'+u.storeName+'" already exists.');else throw T}}),_.onerror=function(P){P.preventDefault(),m(_.error)},_.onsuccess=function(){var P=_.result;P.onversionchange=function(b){b.target.close()},h(P),it(u)}})}function xt(u){return at(u,!1)}function oe(u){return at(u,!0)}function we(u,d){if(!u.db)return!0;var h=!u.db.objectStoreNames.contains(u.storeName),m=u.version<u.db.version,y=u.version>u.db.version;if(m&&(u.version!==d&&console.warn('The database "'+u.name+`" can't be downgraded from version `+u.db.version+" to version "+u.version+"."),u.version=u.db.version),y||h){if(h){var _=u.db.version+1;_>u.version&&(u.version=_)}return!0}return!1}function Qe(u){return new p(function(d,h){var m=new FileReader;m.onerror=h,m.onloadend=function(y){var _=btoa(y.target.result||"");d({__local_forage_encoded_blob:!0,data:_,type:u.type})},m.readAsBinaryString(u)})}function Wt(u){var d=I(atob(u.data));return f([d],{type:u.type})}function Fi(u){return u&&u.__local_forage_encoded_blob}function Qs(u){var d=this,h=d._initReady().then(function(){var m=w[d._dbInfo.name];if(m&&m.dbReady)return m.dbReady});return v(h,u,u),h}function ta(u){J(u);for(var d=w[u.name],h=d.forages,m=0;m<h.length;m++){var y=h[m];y._dbInfo.db&&(y._dbInfo.db.close(),y._dbInfo.db=null)}return u.db=null,xt(u).then(function(_){return u.db=_,we(u)?oe(u):_}).then(function(_){u.db=d.db=_;for(var P=0;P<h.length;P++)h[P]._dbInfo.db=_}).catch(function(_){throw st(u,_),_})}function bt(u,d,h,m){m===void 0&&(m=1);try{var y=u.db.transaction(u.storeName,d);h(null,y)}catch(_){if(m>0&&(!u.db||_.name==="InvalidStateError"||_.name==="NotFoundError"))return p.resolve().then(function(){if(!u.db||_.name==="NotFoundError"&&!u.db.objectStoreNames.contains(u.storeName)&&u.version<=u.db.version)return u.db&&(u.version=u.db.version+1),oe(u)}).then(function(){return ta(u).then(function(){bt(u,d,h,m-1)})}).catch(h);h(_)}}function Ai(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function ea(u){var d=this,h={db:null};if(u)for(var m in u)h[m]=u[m];var y=w[h.name];y||(y=Ai(),w[h.name]=y),y.forages.push(d),d._initReady||(d._initReady=d.ready,d.ready=Qs);var _=[];function P(){return p.resolve()}for(var b=0;b<y.forages.length;b++){var T=y.forages[b];T!==d&&_.push(T._initReady().catch(P))}var R=y.forages.slice(0);return p.all(_).then(function(){return h.db=y.db,xt(h)}).then(function(V){return h.db=V,we(h,d._defaultConfig.version)?oe(h):V}).then(function(V){h.db=y.db=V,d._dbInfo=h;for(var A=0;A<R.length;A++){var G=R[A];G!==d&&(G._dbInfo.db=h.db,G._dbInfo.version=h.version)}})}function ia(u,d){var h=this;u=S(u);var m=new p(function(y,_){h.ready().then(function(){bt(h._dbInfo,U,function(P,b){if(P)return _(P);try{var T=b.objectStore(h._dbInfo.storeName),R=T.get(u);R.onsuccess=function(){var V=R.result;V===void 0&&(V=null),Fi(V)&&(V=Wt(V)),y(V)},R.onerror=function(){_(R.error)}}catch(V){_(V)}})}).catch(_)});return C(m,d),m}function ra(u,d){var h=this,m=new p(function(y,_){h.ready().then(function(){bt(h._dbInfo,U,function(P,b){if(P)return _(P);try{var T=b.objectStore(h._dbInfo.storeName),R=T.openCursor(),V=1;R.onsuccess=function(){var A=R.result;if(A){var G=A.value;Fi(G)&&(G=Wt(G));var W=u(G,A.key,V++);W!==void 0?y(W):A.continue()}else y()},R.onerror=function(){_(R.error)}}catch(A){_(A)}})}).catch(_)});return C(m,d),m}function sa(u,d,h){var m=this;u=S(u);var y=new p(function(_,P){var b;m.ready().then(function(){return b=m._dbInfo,O.call(d)==="[object Blob]"?Y(b.db).then(function(T){return T?d:Qe(d)}):d}).then(function(T){bt(m._dbInfo,B,function(R,V){if(R)return P(R);try{var A=V.objectStore(m._dbInfo.storeName);T===null&&(T=void 0);var G=A.put(T,u);V.oncomplete=function(){T===void 0&&(T=null),_(T)},V.onabort=V.onerror=function(){var W=G.error?G.error:G.transaction.error;P(W)}}catch(W){P(W)}})}).catch(P)});return C(y,h),y}function aa(u,d){var h=this;u=S(u);var m=new p(function(y,_){h.ready().then(function(){bt(h._dbInfo,B,function(P,b){if(P)return _(P);try{var T=b.objectStore(h._dbInfo.storeName),R=T.delete(u);b.oncomplete=function(){y()},b.onerror=function(){_(R.error)},b.onabort=function(){var V=R.error?R.error:R.transaction.error;_(V)}}catch(V){_(V)}})}).catch(_)});return C(m,d),m}function na(u){var d=this,h=new p(function(m,y){d.ready().then(function(){bt(d._dbInfo,B,function(_,P){if(_)return y(_);try{var b=P.objectStore(d._dbInfo.storeName),T=b.clear();P.oncomplete=function(){m()},P.onabort=P.onerror=function(){var R=T.error?T.error:T.transaction.error;y(R)}}catch(R){y(R)}})}).catch(y)});return C(h,u),h}function oa(u){var d=this,h=new p(function(m,y){d.ready().then(function(){bt(d._dbInfo,U,function(_,P){if(_)return y(_);try{var b=P.objectStore(d._dbInfo.storeName),T=b.count();T.onsuccess=function(){m(T.result)},T.onerror=function(){y(T.error)}}catch(R){y(R)}})}).catch(y)});return C(h,u),h}function la(u,d){var h=this,m=new p(function(y,_){if(u<0){y(null);return}h.ready().then(function(){bt(h._dbInfo,U,function(P,b){if(P)return _(P);try{var T=b.objectStore(h._dbInfo.storeName),R=!1,V=T.openKeyCursor();V.onsuccess=function(){var A=V.result;if(!A){y(null);return}u===0||R?y(A.key):(R=!0,A.advance(u))},V.onerror=function(){_(V.error)}}catch(A){_(A)}})}).catch(_)});return C(m,d),m}function ua(u){var d=this,h=new p(function(m,y){d.ready().then(function(){bt(d._dbInfo,U,function(_,P){if(_)return y(_);try{var b=P.objectStore(d._dbInfo.storeName),T=b.openKeyCursor(),R=[];T.onsuccess=function(){var V=T.result;if(!V){m(R);return}R.push(V.key),V.continue()},T.onerror=function(){y(T.error)}}catch(V){y(V)}})}).catch(y)});return C(h,u),h}function ha(u,d){d=x.apply(this,arguments);var h=this.config();u=typeof u!="function"&&u||{},u.name||(u.name=u.name||h.name,u.storeName=u.storeName||h.storeName);var m=this,y;if(!u.name)y=p.reject("Invalid arguments");else{var _=u.name===h.name&&m._dbInfo.db,P=_?p.resolve(m._dbInfo.db):xt(u).then(function(b){var T=w[u.name],R=T.forages;T.db=b;for(var V=0;V<R.length;V++)R[V]._dbInfo.db=b;return b});u.storeName?y=P.then(function(b){if(b.objectStoreNames.contains(u.storeName)){var T=b.version+1;J(u);var R=w[u.name],V=R.forages;b.close();for(var A=0;A<V.length;A++){var G=V[A];G._dbInfo.db=null,G._dbInfo.version=T}var W=new p(function(K,rt){var tt=c.open(u.name,T);tt.onerror=function(mt){var ue=tt.result;ue.close(),rt(mt)},tt.onupgradeneeded=function(){var mt=tt.result;mt.deleteObjectStore(u.storeName)},tt.onsuccess=function(){var mt=tt.result;mt.close(),K(mt)}});return W.then(function(K){R.db=K;for(var rt=0;rt<V.length;rt++){var tt=V[rt];tt._dbInfo.db=K,it(tt._dbInfo)}}).catch(function(K){throw(st(u,K)||p.resolve()).catch(function(){}),K})}}):y=P.then(function(b){J(u);var T=w[u.name],R=T.forages;b.close();for(var V=0;V<R.length;V++){var A=R[V];A._dbInfo.db=null}var G=new p(function(W,K){var rt=c.deleteDatabase(u.name);rt.onerror=function(){var tt=rt.result;tt&&tt.close(),K(rt.error)},rt.onblocked=function(){console.warn('dropInstance blocked for database "'+u.name+'" until all open connections are closed')},rt.onsuccess=function(){var tt=rt.result;tt&&tt.close(),W(tt)}});return G.then(function(W){T.db=W;for(var K=0;K<R.length;K++){var rt=R[K];it(rt._dbInfo)}}).catch(function(W){throw(st(u,W)||p.resolve()).catch(function(){}),W})})}return C(y,d),y}var ca={_driver:"asyncStorage",_initStorage:ea,_support:g(),iterate:ra,getItem:ia,setItem:sa,removeItem:aa,clear:na,length:oa,key:la,keys:ua,dropInstance:ha};function ga(){return typeof openDatabase=="function"}var Vt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",da="~~local_forage_type~",Di=/^~~local_forage_type~([^~]+)~/,Te="__lfsc__:",ti=Te.length,ei="arbf",ii="blob",Li="si08",Oi="ui08",Ni="uic8",ki="si16",Ui="si32",zi="ur16",Xi="ui32",Yi="fl32",Gi="fl64",ji=ti+ei.length,Hi=Object.prototype.toString;function Wi(u){var d=u.length*.75,h=u.length,m,y=0,_,P,b,T;u[u.length-1]==="="&&(d--,u[u.length-2]==="="&&d--);var R=new ArrayBuffer(d),V=new Uint8Array(R);for(m=0;m<h;m+=4)_=Vt.indexOf(u[m]),P=Vt.indexOf(u[m+1]),b=Vt.indexOf(u[m+2]),T=Vt.indexOf(u[m+3]),V[y++]=_<<2|P>>4,V[y++]=(P&15)<<4|b>>2,V[y++]=(b&3)<<6|T&63;return R}function ri(u){var d=new Uint8Array(u),h="",m;for(m=0;m<d.length;m+=3)h+=Vt[d[m]>>2],h+=Vt[(d[m]&3)<<4|d[m+1]>>4],h+=Vt[(d[m+1]&15)<<2|d[m+2]>>6],h+=Vt[d[m+2]&63];return d.length%3===2?h=h.substring(0,h.length-1)+"=":d.length%3===1&&(h=h.substring(0,h.length-2)+"=="),h}function _a(u,d){var h="";if(u&&(h=Hi.call(u)),u&&(h==="[object ArrayBuffer]"||u.buffer&&Hi.call(u.buffer)==="[object ArrayBuffer]")){var m,y=Te;u instanceof ArrayBuffer?(m=u,y+=ei):(m=u.buffer,h==="[object Int8Array]"?y+=Li:h==="[object Uint8Array]"?y+=Oi:h==="[object Uint8ClampedArray]"?y+=Ni:h==="[object Int16Array]"?y+=ki:h==="[object Uint16Array]"?y+=zi:h==="[object Int32Array]"?y+=Ui:h==="[object Uint32Array]"?y+=Xi:h==="[object Float32Array]"?y+=Yi:h==="[object Float64Array]"?y+=Gi:d(new Error("Failed to get type for BinaryArray"))),d(y+ri(m))}else if(h==="[object Blob]"){var _=new FileReader;_.onload=function(){var P=da+u.type+"~"+ri(this.result);d(Te+ii+P)},_.readAsArrayBuffer(u)}else try{d(JSON.stringify(u))}catch(P){console.error("Couldn't convert value into a JSON string: ",u),d(null,P)}}function fa(u){if(u.substring(0,ti)!==Te)return JSON.parse(u);var d=u.substring(ji),h=u.substring(ti,ji),m;if(h===ii&&Di.test(d)){var y=d.match(Di);m=y[1],d=d.substring(y[0].length)}var _=Wi(d);switch(h){case ei:return _;case ii:return f([_],{type:m});case Li:return new Int8Array(_);case Oi:return new Uint8Array(_);case Ni:return new Uint8ClampedArray(_);case ki:return new Int16Array(_);case zi:return new Uint16Array(_);case Ui:return new Int32Array(_);case Xi:return new Uint32Array(_);case Yi:return new Float32Array(_);case Gi:return new Float64Array(_);default:throw new Error("Unkown type: "+h)}}var si={serialize:_a,deserialize:fa,stringToBuffer:Wi,bufferToString:ri};function $i(u,d,h,m){u.executeSql("CREATE TABLE IF NOT EXISTS "+d.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],h,m)}function ma(u){var d=this,h={db:null};if(u)for(var m in u)h[m]=typeof u[m]!="string"?u[m].toString():u[m];var y=new p(function(_,P){try{h.db=openDatabase(h.name,String(h.version),h.description,h.size)}catch(b){return P(b)}h.db.transaction(function(b){$i(b,h,function(){d._dbInfo=h,_()},function(T,R){P(R)})},P)});return h.serializer=si,y}function Et(u,d,h,m,y,_){u.executeSql(h,m,y,function(P,b){b.code===b.SYNTAX_ERR?P.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[d.storeName],function(T,R){R.rows.length?_(T,b):$i(T,d,function(){T.executeSql(h,m,y,_)},_)},_):_(P,b)},_)}function pa(u,d){var h=this;u=S(u);var m=new p(function(y,_){h.ready().then(function(){var P=h._dbInfo;P.db.transaction(function(b){Et(b,P,"SELECT * FROM "+P.storeName+" WHERE key = ? LIMIT 1",[u],function(T,R){var V=R.rows.length?R.rows.item(0).value:null;V&&(V=P.serializer.deserialize(V)),y(V)},function(T,R){_(R)})})}).catch(_)});return C(m,d),m}function ya(u,d){var h=this,m=new p(function(y,_){h.ready().then(function(){var P=h._dbInfo;P.db.transaction(function(b){Et(b,P,"SELECT * FROM "+P.storeName,[],function(T,R){for(var V=R.rows,A=V.length,G=0;G<A;G++){var W=V.item(G),K=W.value;if(K&&(K=P.serializer.deserialize(K)),K=u(K,W.key,G+1),K!==void 0){y(K);return}}y()},function(T,R){_(R)})})}).catch(_)});return C(m,d),m}function qi(u,d,h,m){var y=this;u=S(u);var _=new p(function(P,b){y.ready().then(function(){d===void 0&&(d=null);var T=d,R=y._dbInfo;R.serializer.serialize(d,function(V,A){A?b(A):R.db.transaction(function(G){Et(G,R,"INSERT OR REPLACE INTO "+R.storeName+" (key, value) VALUES (?, ?)",[u,V],function(){P(T)},function(W,K){b(K)})},function(G){if(G.code===G.QUOTA_ERR){if(m>0){P(qi.apply(y,[u,T,h,m-1]));return}b(G)}})})}).catch(b)});return C(_,h),_}function Sa(u,d,h){return qi.apply(this,[u,d,h,1])}function xa(u,d){var h=this;u=S(u);var m=new p(function(y,_){h.ready().then(function(){var P=h._dbInfo;P.db.transaction(function(b){Et(b,P,"DELETE FROM "+P.storeName+" WHERE key = ?",[u],function(){y()},function(T,R){_(R)})})}).catch(_)});return C(m,d),m}function Ca(u){var d=this,h=new p(function(m,y){d.ready().then(function(){var _=d._dbInfo;_.db.transaction(function(P){Et(P,_,"DELETE FROM "+_.storeName,[],function(){m()},function(b,T){y(T)})})}).catch(y)});return C(h,u),h}function va(u){var d=this,h=new p(function(m,y){d.ready().then(function(){var _=d._dbInfo;_.db.transaction(function(P){Et(P,_,"SELECT COUNT(key) as c FROM "+_.storeName,[],function(b,T){var R=T.rows.item(0).c;m(R)},function(b,T){y(T)})})}).catch(y)});return C(h,u),h}function Ma(u,d){var h=this,m=new p(function(y,_){h.ready().then(function(){var P=h._dbInfo;P.db.transaction(function(b){Et(b,P,"SELECT key FROM "+P.storeName+" WHERE id = ? LIMIT 1",[u+1],function(T,R){var V=R.rows.length?R.rows.item(0).key:null;y(V)},function(T,R){_(R)})})}).catch(_)});return C(m,d),m}function Ba(u){var d=this,h=new p(function(m,y){d.ready().then(function(){var _=d._dbInfo;_.db.transaction(function(P){Et(P,_,"SELECT key FROM "+_.storeName,[],function(b,T){for(var R=[],V=0;V<T.rows.length;V++)R.push(T.rows.item(V).key);m(R)},function(b,T){y(T)})})}).catch(y)});return C(h,u),h}function Pa(u){return new p(function(d,h){u.transaction(function(m){m.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(y,_){for(var P=[],b=0;b<_.rows.length;b++)P.push(_.rows.item(b).name);d({db:u,storeNames:P})},function(y,_){h(_)})},function(m){h(m)})})}function ba(u,d){d=x.apply(this,arguments);var h=this.config();u=typeof u!="function"&&u||{},u.name||(u.name=u.name||h.name,u.storeName=u.storeName||h.storeName);var m=this,y;return u.name?y=new p(function(_){var P;u.name===h.name?P=m._dbInfo.db:P=openDatabase(u.name,"","",0),u.storeName?_({db:P,storeNames:[u.storeName]}):_(Pa(P))}).then(function(_){return new p(function(P,b){_.db.transaction(function(T){function R(W){return new p(function(K,rt){T.executeSql("DROP TABLE IF EXISTS "+W,[],function(){K()},function(tt,mt){rt(mt)})})}for(var V=[],A=0,G=_.storeNames.length;A<G;A++)V.push(R(_.storeNames[A]));p.all(V).then(function(){P()}).catch(function(W){b(W)})},function(T){b(T)})})}):y=p.reject("Invalid arguments"),C(y,d),y}var Ia={_driver:"webSQLStorage",_initStorage:ma,_support:ga(),iterate:ya,getItem:pa,setItem:Sa,removeItem:xa,clear:Ca,length:va,key:Ma,keys:Ba,dropInstance:ba};function wa(){try{return typeof localStorage<"u"&&"setItem"in localStorage&&!!localStorage.setItem}catch{return!1}}function Ji(u,d){var h=u.name+"/";return u.storeName!==d.storeName&&(h+=u.storeName+"/"),h}function Ta(){var u="_localforage_support_test";try{return localStorage.setItem(u,!0),localStorage.removeItem(u),!1}catch{return!0}}function Ra(){return!Ta()||localStorage.length>0}function Va(u){var d=this,h={};if(u)for(var m in u)h[m]=u[m];return h.keyPrefix=Ji(u,d._defaultConfig),Ra()?(d._dbInfo=h,h.serializer=si,p.resolve()):p.reject()}function Ea(u){var d=this,h=d.ready().then(function(){for(var m=d._dbInfo.keyPrefix,y=localStorage.length-1;y>=0;y--){var _=localStorage.key(y);_.indexOf(m)===0&&localStorage.removeItem(_)}});return C(h,u),h}function Fa(u,d){var h=this;u=S(u);var m=h.ready().then(function(){var y=h._dbInfo,_=localStorage.getItem(y.keyPrefix+u);return _&&(_=y.serializer.deserialize(_)),_});return C(m,d),m}function Aa(u,d){var h=this,m=h.ready().then(function(){for(var y=h._dbInfo,_=y.keyPrefix,P=_.length,b=localStorage.length,T=1,R=0;R<b;R++){var V=localStorage.key(R);if(V.indexOf(_)===0){var A=localStorage.getItem(V);if(A&&(A=y.serializer.deserialize(A)),A=u(A,V.substring(P),T++),A!==void 0)return A}}});return C(m,d),m}function Da(u,d){var h=this,m=h.ready().then(function(){var y=h._dbInfo,_;try{_=localStorage.key(u)}catch{_=null}return _&&(_=_.substring(y.keyPrefix.length)),_});return C(m,d),m}function La(u){var d=this,h=d.ready().then(function(){for(var m=d._dbInfo,y=localStorage.length,_=[],P=0;P<y;P++){var b=localStorage.key(P);b.indexOf(m.keyPrefix)===0&&_.push(b.substring(m.keyPrefix.length))}return _});return C(h,u),h}function Oa(u){var d=this,h=d.keys().then(function(m){return m.length});return C(h,u),h}function Na(u,d){var h=this;u=S(u);var m=h.ready().then(function(){var y=h._dbInfo;localStorage.removeItem(y.keyPrefix+u)});return C(m,d),m}function ka(u,d,h){var m=this;u=S(u);var y=m.ready().then(function(){d===void 0&&(d=null);var _=d;return new p(function(P,b){var T=m._dbInfo;T.serializer.serialize(d,function(R,V){if(V)b(V);else try{localStorage.setItem(T.keyPrefix+u,R),P(_)}catch(A){(A.name==="QuotaExceededError"||A.name==="NS_ERROR_DOM_QUOTA_REACHED")&&b(A),b(A)}})})});return C(y,h),y}function Ua(u,d){if(d=x.apply(this,arguments),u=typeof u!="function"&&u||{},!u.name){var h=this.config();u.name=u.name||h.name,u.storeName=u.storeName||h.storeName}var m=this,y;return u.name?y=new p(function(_){u.storeName?_(Ji(u,m._defaultConfig)):_(u.name+"/")}).then(function(_){for(var P=localStorage.length-1;P>=0;P--){var b=localStorage.key(P);b.indexOf(_)===0&&localStorage.removeItem(b)}}):y=p.reject("Invalid arguments"),C(y,d),y}var za={_driver:"localStorageWrapper",_initStorage:Va,_support:wa(),iterate:Aa,getItem:Fa,setItem:ka,removeItem:Na,clear:Ea,length:Oa,key:Da,keys:La,dropInstance:Ua},Xa=function(d,h){return d===h||typeof d=="number"&&typeof h=="number"&&isNaN(d)&&isNaN(h)},Ya=function(d,h){for(var m=d.length,y=0;y<m;){if(Xa(d[y],h))return!0;y++}return!1},Ki=Array.isArray||function(u){return Object.prototype.toString.call(u)==="[object Array]"},le={},Zi={},$t={INDEXEDDB:ca,WEBSQL:Ia,LOCALSTORAGE:za},Ga=[$t.INDEXEDDB._driver,$t.WEBSQL._driver,$t.LOCALSTORAGE._driver],Re=["dropInstance"],ai=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(Re),ja={description:"",driver:Ga.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function Ha(u,d){u[d]=function(){var h=arguments;return u.ready().then(function(){return u[d].apply(u,h)})}}function ni(){for(var u=1;u<arguments.length;u++){var d=arguments[u];if(d)for(var h in d)d.hasOwnProperty(h)&&(Ki(d[h])?arguments[0][h]=d[h].slice():arguments[0][h]=d[h])}return arguments[0]}var Wa=function(){function u(d){o(this,u);for(var h in $t)if($t.hasOwnProperty(h)){var m=$t[h],y=m._driver;this[h]=y,le[y]||this.defineDriver(m)}this._defaultConfig=ni({},ja),this._config=ni({},this._defaultConfig,d),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return u.prototype.config=function(h){if((typeof h>"u"?"undefined":a(h))==="object"){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var m in h){if(m==="storeName"&&(h[m]=h[m].replace(/\W/g,"_")),m==="version"&&typeof h[m]!="number")return new Error("Database version must be a number.");this._config[m]=h[m]}return"driver"in h&&h.driver?this.setDriver(this._config.driver):!0}else return typeof h=="string"?this._config[h]:this._config},u.prototype.defineDriver=function(h,m,y){var _=new p(function(P,b){try{var T=h._driver,R=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!h._driver){b(R);return}for(var V=ai.concat("_initStorage"),A=0,G=V.length;A<G;A++){var W=V[A],K=!Ya(Re,W);if((K||h[W])&&typeof h[W]!="function"){b(R);return}}var rt=function(){for(var ue=function(Ja){return function(){var Ka=new Error("Method "+Ja+" is not implemented by the current driver"),Qi=p.reject(Ka);return C(Qi,arguments[arguments.length-1]),Qi}},oi=0,qa=Re.length;oi<qa;oi++){var li=Re[oi];h[li]||(h[li]=ue(li))}};rt();var tt=function(ue){le[T]&&console.info("Redefining LocalForage driver: "+T),le[T]=h,Zi[T]=ue,P()};"_support"in h?h._support&&typeof h._support=="function"?h._support().then(tt,b):tt(!!h._support):tt(!0)}catch(mt){b(mt)}});return v(_,m,y),_},u.prototype.driver=function(){return this._driver||null},u.prototype.getDriver=function(h,m,y){var _=le[h]?p.resolve(le[h]):p.reject(new Error("Driver not found."));return v(_,m,y),_},u.prototype.getSerializer=function(h){var m=p.resolve(si);return v(m,h),m},u.prototype.ready=function(h){var m=this,y=m._driverSet.then(function(){return m._ready===null&&(m._ready=m._initDriver()),m._ready});return v(y,h,h),y},u.prototype.setDriver=function(h,m,y){var _=this;Ki(h)||(h=[h]);var P=this._getSupportedDrivers(h);function b(){_._config.driver=_.driver()}function T(A){return _._extend(A),b(),_._ready=_._initStorage(_._config),_._ready}function R(A){return function(){var G=0;function W(){for(;G<A.length;){var K=A[G];return G++,_._dbInfo=null,_._ready=null,_.getDriver(K).then(T).catch(W)}b();var rt=new Error("No available storage method found.");return _._driverSet=p.reject(rt),_._driverSet}return W()}}var V=this._driverSet!==null?this._driverSet.catch(function(){return p.resolve()}):p.resolve();return this._driverSet=V.then(function(){var A=P[0];return _._dbInfo=null,_._ready=null,_.getDriver(A).then(function(G){_._driver=G._driver,b(),_._wrapLibraryMethodsWithReady(),_._initDriver=R(P)})}).catch(function(){b();var A=new Error("No available storage method found.");return _._driverSet=p.reject(A),_._driverSet}),v(this._driverSet,m,y),this._driverSet},u.prototype.supports=function(h){return!!Zi[h]},u.prototype._extend=function(h){ni(this,h)},u.prototype._getSupportedDrivers=function(h){for(var m=[],y=0,_=h.length;y<_;y++){var P=h[y];this.supports(P)&&m.push(P)}return m},u.prototype._wrapLibraryMethodsWithReady=function(){for(var h=0,m=ai.length;h<m;h++)Ha(this,ai[h])},u.prototype.createInstance=function(h){return new u(h)},u}(),$a=new Wa;i.exports=$a},{3:3}]},{},[4])(4)})})(Ks);var ol=Ks.exports,ys=nl(ol),$;(function(r){r[r.LoadAssets=0]="LoadAssets",r[r.LoadModel=1]="LoadModel",r[r.WaitLoadModel=2]="WaitLoadModel",r[r.LoadExpression=3]="LoadExpression",r[r.WaitLoadExpression=4]="WaitLoadExpression",r[r.LoadPhysics=5]="LoadPhysics",r[r.WaitLoadPhysics=6]="WaitLoadPhysics",r[r.LoadPose=7]="LoadPose",r[r.WaitLoadPose=8]="WaitLoadPose",r[r.SetupEyeBlink=9]="SetupEyeBlink",r[r.SetupBreath=10]="SetupBreath",r[r.LoadUserData=11]="LoadUserData",r[r.WaitLoadUserData=12]="WaitLoadUserData",r[r.SetupEyeBlinkIds=13]="SetupEyeBlinkIds",r[r.SetupLipSyncIds=14]="SetupLipSyncIds",r[r.SetupLayout=15]="SetupLayout",r[r.LoadMotion=16]="LoadMotion",r[r.WaitLoadMotion=17]="WaitLoadMotion",r[r.CompleteInitialize=18]="CompleteInitialize",r[r.CompleteSetupModel=19]="CompleteSetupModel",r[r.LoadTexture=20]="LoadTexture",r[r.WaitLoadTexture=21]="WaitLoadTexture",r[r.CompleteSetup=22]="CompleteSetup"})($||($={}));async function wt(r){const t=async()=>await(await fetch(r)).arrayBuffer();if(Ps){const e=await ys.getItem(r);if(e===null){Yt&&H.printMessage(`[Waifu]fetch : ${r}`);const i=await t();return await ys.setItem(r,i),await Promise.resolve(i)}else return Yt&&H.printMessage(`[Waifu]use cache : ${r}`),await Promise.resolve(e)}else return t()}class ll extends Ze{constructor(){super();n(this,"_modelSetting");n(this,"_modelHomeDir");n(this,"_userTimeSeconds");n(this,"_eyeBlinkIds");n(this,"_lipSyncIds");n(this,"_motions");n(this,"_expressions");n(this,"_hitArea");n(this,"_userArea");n(this,"_idParamAngleX");n(this,"_idParamAngleY");n(this,"_idParamAngleZ");n(this,"_idParamEyeBallX");n(this,"_idParamEyeBallY");n(this,"_idParamBodyAngleX");n(this,"_state");n(this,"_expressionCount");n(this,"_textureCount");n(this,"_motionCount");n(this,"_allMotionCount");n(this,"_wavFileHandler");n(this,"_consistency");this._modelSetting=null,this._modelHomeDir=null,this._userTimeSeconds=0,this._eyeBlinkIds=new L,this._lipSyncIds=new L,this._motions=new ft,this._expressions=new ft,this._hitArea=new L,this._userArea=new L,this._idParamAngleX=j.getIdManager().getId(N.ParamAngleX),this._idParamAngleY=j.getIdManager().getId(N.ParamAngleY),this._idParamAngleZ=j.getIdManager().getId(N.ParamAngleZ),this._idParamEyeBallX=j.getIdManager().getId(N.ParamEyeBallX),this._idParamEyeBallY=j.getIdManager().getId(N.ParamEyeBallY),this._idParamBodyAngleX=j.getIdManager().getId(N.ParamBodyAngleX),this._mocConsistency=!0,this._state=$.LoadAssets,this._expressionCount=0,this._textureCount=0,this._motionCount=0,this._allMotionCount=0,this._wavFileHandler=new Ei,this._consistency=!1}loadAssets(e,i){this._modelHomeDir=e,wt(`${this._modelHomeDir}${i}`).then(s=>{const a=new ws(s,s.byteLength);this._state=$.LoadModel,this.setupModel(a)})}setupModel(e){this._updating=!0,this._initialized=!1,this._modelSetting=e;const i=()=>{this._state=$.WaitLoadMotion,this._model.saveParameters(),this._allMotionCount=0,this._motionCount=0;const S=[],x=this._modelSetting.getMotionGroupCount();for(let M=0;M<x;M++)S[M]=this._modelSetting.getMotionGroupName(M),this._allMotionCount+=this._modelSetting.getMotionCount(S[M]);for(let M=0;M<x;M++)this.preLoadMotionGroup(S[M]);x==0&&(this._state=$.LoadTexture,this._motionManager.stopAllMotions(),this._updating=!1,this._initialized=!0,this.createRenderer(),this.setupTextures(),this.getRenderer().startUp(E))},s=()=>{const S=new ft;if(this._modelSetting==null||this._modelMatrix==null){ut("Failed to setupLayout().");return}this._modelSetting.getLayoutMap(S),this._modelMatrix.setupFromLayout(S),this._state=$.LoadMotion,i()},a=()=>{const S=this._modelSetting.getLipSyncParameterCount();for(let x=0;x<S;++x)this._lipSyncIds.pushBack(this._modelSetting.getLipSyncParameterId(x));this._state=$.SetupLayout,s()},o=()=>{const S=this._modelSetting.getEyeBlinkParameterCount();for(let x=0;x<S;++x)this._eyeBlinkIds.pushBack(this._modelSetting.getEyeBlinkParameterId(x));this._state=$.SetupLipSyncIds,a()},l=()=>{if(this._modelSetting.getUserDataFile()!=""){const S=this._modelSetting.getUserDataFile();wt(`${this._modelHomeDir}${S}`).then(x=>{this.loadUserData(x,x.byteLength),this._state=$.SetupEyeBlinkIds,o()}),this._state=$.WaitLoadUserData}else this._state=$.SetupEyeBlinkIds,o()},c=()=>{this._breath=be.create();const S=new L;S.pushBack(new te(this._idParamAngleX,0,15,6.5345,.5)),S.pushBack(new te(this._idParamAngleY,0,8,3.5345,.5)),S.pushBack(new te(this._idParamAngleZ,0,10,5.5345,.5)),S.pushBack(new te(this._idParamBodyAngleX,0,4,15.5345,.5)),S.pushBack(new te(j.getIdManager().getId(N.ParamBreath),.5,.5,3.2345,1)),this._breath.setParameters(S),this._state=$.LoadUserData,l()},g=()=>{this._modelSetting.getEyeBlinkParameterCount()>0&&(this._eyeBlink=Se.create(this._modelSetting),this._state=$.SetupBreath),c()},f=()=>{if(this._modelSetting.getPoseFileName()!=""){const S=this._modelSetting.getPoseFileName();wt(`${this._modelHomeDir}${S}`).then(x=>{this.loadPose(x,x.byteLength),this._state=$.SetupEyeBlink,g()}),this._state=$.WaitLoadPose}else this._state=$.SetupEyeBlink,g()},p=()=>{if(this._modelSetting.getPhysicsFileName()!=""){const S=this._modelSetting.getPhysicsFileName();wt(`${this._modelHomeDir}${S}`).then(x=>{this.loadPhysics(x,x.byteLength),this._state=$.LoadPose,f()}),this._state=$.WaitLoadPhysics}else this._state=$.LoadPose,f()},C=()=>{if(this._modelSetting.getExpressionCount()>0){const S=this._modelSetting.getExpressionCount();for(let x=0;x<S;x++){const M=this._modelSetting.getExpressionName(x),D=this._modelSetting.getExpressionFileName(x);wt(`${this._modelHomeDir}${D}`).then(w=>{const O=this.loadExpression(w,w.byteLength,M);this._expressions.getValue(M)!=null&&(ne.delete(this._expressions.getValue(M)),this._expressions.setValue(M,null)),this._expressions.setValue(M,O),this._expressionCount++,this._expressionCount>=S&&(this._state=$.LoadPhysics,p())})}this._state=$.WaitLoadExpression}else this._state=$.LoadPhysics,p()};if(this._modelSetting.getModelFileName()!=""){const S=this._modelSetting.getModelFileName();var v=this;wt(`${v._modelHomeDir}${S}`).then(x=>{v.loadModel(x,v._mocConsistency),v._state=$.LoadExpression,C()}).catch(x=>{H.printMessage(x)})}else H.printMessage("Model data does not exist.")}setupTextures(){if(this._state==$.LoadTexture){const i=this._modelSetting.getTextureCount();for(let s=0;s<i;s++){if(this._modelSetting.getTextureFileName(s)==""){console.log("getTextureFileName null");continue}let a=this._modelSetting.getTextureFileName(s);a=this._modelHomeDir+a;const o=l=>{this.getRenderer().bindTexture(s,l.id),this._textureCount++,this._textureCount>=i&&(this._state=$.CompleteSetup)};q.getInstance().getTextureManager().createTextureFromPngFile(a,!0,o),this.getRenderer().setIsPremultipliedAlpha(!0)}this._state=$.WaitLoadTexture}}reloadRenderer(){this.deleteRenderer(),this.createRenderer(),this.setupTextures()}update(){if(this._state!=$.CompleteSetup)return;const e=H.getDeltaTime();this._userTimeSeconds+=e,this._dragManager.update(e),this._dragX=this._dragManager.getX(),this._dragY=this._dragManager.getY();let i=!1;if(this._model.loadParameters(),this._motionManager.isFinished()?this.startRandomMotion(fn,pn):i=this._motionManager.updateMotion(this._model,e),this._model.saveParameters(),i||this._eyeBlink!=null&&this._eyeBlink.updateParameters(this._model,e),this._expressionManager!=null&&this._expressionManager.updateMotion(this._model,e),this._model.addParameterValueById(this._idParamAngleX,this._dragX*30),this._model.addParameterValueById(this._idParamAngleY,this._dragY*30),this._model.addParameterValueById(this._idParamAngleZ,this._dragX*this._dragY*-30),this._model.addParameterValueById(this._idParamBodyAngleX,this._dragX*10),this._model.addParameterValueById(this._idParamEyeBallX,this._dragX),this._model.addParameterValueById(this._idParamEyeBallY,this._dragY),this._breath!=null&&this._breath.updateParameters(this._model,e),this._physics!=null&&this._physics.evaluate(this._model,e),this._lipsync){let s=0;this._wavFileHandler.update(e),s=this._wavFileHandler.getRms();for(let a=0;a<this._lipSyncIds.getSize();++a)this._model.addParameterValueById(this._lipSyncIds.at(a),s,.8)}this._pose!=null&&this._pose.updateParameters(this._model,e),this._model.update()}startMotion(e,i,s,a){if(s==dr)this._motionManager.setReservePriority(s);else if(!this._motionManager.reserveMotion(s))return this._debugMode&&H.printMessage("[Waifu]can't start motion."),We;const o=this._modelSetting.getMotionFileName(e,i),l=`${e}_${i}`;let c=this._motions.getValue(l),g=!1;c==null?wt(`${this._modelHomeDir}${o}`).then(p=>{c=this.loadMotion(p,p.byteLength,null,a);let C=this._modelSetting.getMotionFadeInTimeValue(e,i);C>=0&&c.setFadeInTime(C),C=this._modelSetting.getMotionFadeOutTimeValue(e,i),C>=0&&c.setFadeOutTime(C),c.setEffectIds(this._eyeBlinkIds,this._lipSyncIds),g=!0}):c.setFinishedMotionHandler(a);const f=this._modelSetting.getMotionSoundFileName(e,i);if(f.localeCompare("")!=0){let p=f;p=this._modelHomeDir+p,this._wavFileHandler.start(p)}return this._debugMode&&H.printMessage(`[Waifu]start motion: [${e}_${i}`),this._motionManager.startMotionPriority(c,g,s)}startRandomMotion(e,i,s){if(this._modelSetting.getMotionCount(e)==0)return We;const a=Math.floor(Math.random()*this._modelSetting.getMotionCount(e));return this.startMotion(e,a,i,s)}setExpression(e){const i=this._expressions.getValue(e);this._debugMode&&H.printMessage(`[Waifu]expression: [${e}]`),i!=null?this._expressionManager.startMotionPriority(i,!1,dr):this._debugMode&&H.printMessage(`[Waifu]expression[${e}] is null`)}setRandomExpression(){if(this._expressions.getSize()==0)return;const e=Math.floor(Math.random()*this._expressions.getSize());for(let i=0;i<this._expressions.getSize();i++)if(i==e){const s=this._expressions._keyValues[i].first;this.setExpression(s);return}}motionEventFired(e){Mt("{0} is fired on LAppModel!!",e.s)}hitTest(e,i,s){if(this._opacity<1)return!1;const a=this._modelSetting.getHitAreasCount();for(let o=0;o<a;o++)if(this._modelSetting.getHitAreaName(o)==e){const l=this._modelSetting.getHitAreaId(o);return this.isHit(l,i,s)}return!1}preLoadMotionGroup(e){for(let i=0;i<this._modelSetting.getMotionCount(e);i++){const s=this._modelSetting.getMotionFileName(e,i),a=`${e}_${i}`;this._debugMode&&H.printMessage(`[Waifu]load motion: ${s} => [${a}]`),wt(`${this._modelHomeDir}${s}`).then(o=>{const l=this.loadMotion(o,o.byteLength,a);let c=this._modelSetting.getMotionFadeInTimeValue(e,i);c>=0&&l.setFadeInTime(c),c=this._modelSetting.getMotionFadeOutTimeValue(e,i),c>=0&&l.setFadeOutTime(c),l.setEffectIds(this._eyeBlinkIds,this._lipSyncIds),this._motions.getValue(a)!=null&&ne.delete(this._motions.getValue(a)),this._motions.setValue(a,l),this._motionCount++,this._motionCount>=this._allMotionCount&&(this._state=$.LoadTexture,this._motionManager.stopAllMotions(),this._updating=!1,this._initialized=!0,this.createRenderer(),this.setupTextures(),this.getRenderer().startUp(E))})}}releaseMotions(){this._motions.clear()}releaseExpressions(){this._expressions.clear()}doDraw(){if(this._model==null)return;const e=[0,0,Q.width,Q.height];this.getRenderer().setRenderState(bi,e),this.getRenderer().drawModel()}draw(e){this._model!=null&&this._state==$.CompleteSetup&&(e.multiplyByMatrix(this._modelMatrix),this.getRenderer().setMvpMatrix(e),this.doDraw())}async hasMocConsistencyFromFile(){if(vt(this._modelSetting.getModelFileName().localeCompare("")),this._modelSetting.getModelFileName()!=""){const e=this._modelSetting.getModelFileName(),i=await wt(`${this._modelHomeDir}${e}`);return this._consistency=Ie.hasMocConsistency(i),this._consistency?Mt("Consistent MOC3."):Mt("Inconsistent MOC3."),this._consistency}else H.printMessage("Model data does not exist.")}}let Qt=null;class Ht{constructor(){n(this,"_viewMatrix");n(this,"_models");n(this,"_sceneIndex");n(this,"_finishedMotion",t=>{H.printMessage("Motion Finished:"),console.log(t)});this._viewMatrix=new et,this._models=new L,this._sceneIndex=0,this.changeScene(this._sceneIndex)}static getInstance(){return Qt==null&&(Qt=new Ht),Qt}static releaseInstance(){Qt!=null&&(Qt=void 0),Qt=null}getModel(t){return t<this._models.getSize()?this._models.at(t):null}releaseAllModel(){for(let t=0;t<this._models.getSize();t++)this._models.at(t).release(),this._models.set(t,null);this._models.clear()}onDrag(t,e){for(let i=0;i<this._models.getSize();i++){const s=this.getModel(i);s&&s.setDragging(t,e)}}onTap(t,e){Yt&&H.printMessage(`[Waifu]tap point: {x: ${t.toFixed(2)} y: ${e.toFixed(2)}}`);for(let i=0;i<this._models.getSize();i++)this._models.at(i).hitTest(cr,t,e)?(Yt&&H.printMessage(`[Waifu]hit area: [${cr}]`),this._models.at(i).setRandomExpression()):this._models.at(i).hitTest(gr,t,e)&&(Yt&&H.printMessage(`[Waifu]hit area: [${gr}]`),this._models.at(i).startRandomMotion(mn,yn,this._finishedMotion))}onUpdate(){const{width:t,height:e}=Q,i=this._models.getSize();for(let s=0;s<i;++s){const a=new et,o=this.getModel(s);o.getModel()&&(o.getModel().getCanvasWidth()>1&&t<e?(o.getModelMatrix().setWidth(2),a.scale(1,t/e)):a.scale(e/t,1),this._viewMatrix!=null&&a.multiplyByMatrix(this._viewMatrix)),o.update(),o.draw(a)}}nextScene(){const t=(this._sceneIndex+1)%bs;this.changeScene(t)}changeScene(t){this._sceneIndex=t,Yt&&H.printMessage(`[Waifu]model index: ${this._sceneIndex}`);const e=xi[t],i=Bs+e+"/";let s=xi[t];s+=".model3.json",this.releaseAllModel(),this._models.pushBack(new ll),this._models.at(0).loadAssets(i,s)}setViewMatrix(t){for(let e=0;e<16;e++)this._viewMatrix.getArray()[e]=t.getArray()[e]}}class ul{constructor(){n(this,"_textures");this._textures=new L}release(){for(let t=this._textures.begin();t.notEqual(this._textures.end());t.preIncrement())E.deleteTexture(t.ptr().id);this._textures=null}createTextureFromPngFile(t,e,i){for(let a=this._textures.begin();a.notEqual(this._textures.end());a.preIncrement())if(a.ptr().fileName==t&&a.ptr().usePremultply==e){a.ptr().img=new Image,a.ptr().img.onload=()=>i(a.ptr()),a.ptr().img.src=t;return}const s=new Image;s.crossOrigin="anonymous",s.onload=()=>{const a=E.createTexture();E.bindTexture(E.TEXTURE_2D,a),E.texParameteri(E.TEXTURE_2D,E.TEXTURE_MIN_FILTER,E.LINEAR_MIPMAP_LINEAR),E.texParameteri(E.TEXTURE_2D,E.TEXTURE_MAG_FILTER,E.LINEAR),e&&E.pixelStorei(E.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),E.texImage2D(E.TEXTURE_2D,0,E.RGBA,E.RGBA,E.UNSIGNED_BYTE,s),E.generateMipmap(E.TEXTURE_2D),E.bindTexture(E.TEXTURE_2D,null);const o=new hl;o!=null&&(o.fileName=t,o.width=s.width,o.height=s.height,o.id=a,o.img=s,o.usePremultply=e,this._textures.pushBack(o)),i(o)},s.src=t}releaseTextures(){for(let t=0;t<this._textures.getSize();t++)this._textures.set(t,null);this._textures.clear()}releaseTextureByTexture(t){for(let e=0;e<this._textures.getSize();e++)if(this._textures.at(e).id==t){this._textures.set(e,null),this._textures.remove(e);break}}releaseTextureByFilePath(t){for(let e=0;e<this._textures.getSize();e++)if(this._textures.at(e).fileName==t){this._textures.set(e,null),this._textures.remove(e);break}}}class hl{constructor(){n(this,"img");n(this,"id",null);n(this,"width",0);n(this,"height",0);n(this,"usePremultply");n(this,"fileName")}}class Zs extends et{constructor(){super();n(this,"_screenLeft");n(this,"_screenRight");n(this,"_screenTop");n(this,"_screenBottom");n(this,"_maxLeft");n(this,"_maxRight");n(this,"_maxTop");n(this,"_maxBottom");n(this,"_maxScale");n(this,"_minScale");this._screenLeft=0,this._screenRight=0,this._screenTop=0,this._screenBottom=0,this._maxLeft=0,this._maxRight=0,this._maxTop=0,this._maxBottom=0,this._maxScale=0,this._minScale=0}adjustTranslate(e,i){this._tr[0]*this._maxLeft+(this._tr[12]+e)>this._screenLeft&&(e=this._screenLeft-this._tr[0]*this._maxLeft-this._tr[12]),this._tr[0]*this._maxRight+(this._tr[12]+e)<this._screenRight&&(e=this._screenRight-this._tr[0]*this._maxRight-this._tr[12]),this._tr[5]*this._maxTop+(this._tr[13]+i)<this._screenTop&&(i=this._screenTop-this._tr[5]*this._maxTop-this._tr[13]),this._tr[5]*this._maxBottom+(this._tr[13]+i)>this._screenBottom&&(i=this._screenBottom-this._tr[5]*this._maxBottom-this._tr[13]);const s=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,e,i,0,1]);et.multiply(s,this._tr,this._tr)}adjustScale(e,i,s){const a=this.getMaxScale(),o=this.getMinScale(),l=s*this._tr[0];l<o?this._tr[0]>0&&(s=o/this._tr[0]):l>a&&this._tr[0]>0&&(s=a/this._tr[0]);const c=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,e,i,0,1]),g=new Float32Array([s,0,0,0,0,s,0,0,0,0,1,0,0,0,0,1]),f=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,-e,-i,0,1]);et.multiply(f,this._tr,this._tr),et.multiply(g,this._tr,this._tr),et.multiply(c,this._tr,this._tr)}setScreenRect(e,i,s,a){this._screenLeft=e,this._screenRight=i,this._screenBottom=s,this._screenTop=a}setMaxScreenRect(e,i,s,a){this._maxLeft=e,this._maxRight=i,this._maxTop=a,this._maxBottom=s}setMaxScale(e){this._maxScale=e}setMinScale(e){this._minScale=e}getMaxScale(){return this._maxScale}getMinScale(){return this._minScale}isMaxScale(){return this.getScaleX()>=this._maxScale}isMinScale(){return this.getScaleX()<=this._minScale}getScreenLeft(){return this._screenLeft}getScreenRight(){return this._screenRight}getScreenBottom(){return this._screenBottom}getScreenTop(){return this._screenTop}getMaxLeft(){return this._maxLeft}getMaxRight(){return this._maxRight}getMaxBottom(){return this._maxBottom}getMaxTop(){return this._maxTop}}var Ss;(function(r){r.CubismViewMatrix=Zs})(Ss||(Ss={}));class cl{constructor(){n(this,"_startY");n(this,"_startX");n(this,"_lastX");n(this,"_lastY");n(this,"_lastX1");n(this,"_lastY1");n(this,"_lastX2");n(this,"_lastY2");n(this,"_lastTouchDistance");n(this,"_deltaX");n(this,"_deltaY");n(this,"_scale");n(this,"_touchSingle");n(this,"_flipAvailable");this._startX=0,this._startY=0,this._lastX=0,this._lastY=0,this._lastX1=0,this._lastY1=0,this._lastX2=0,this._lastY2=0,this._lastTouchDistance=0,this._deltaX=0,this._deltaY=0,this._scale=1,this._touchSingle=!1,this._flipAvailable=!1}getCenterX(){return this._lastX}getCenterY(){return this._lastY}getDeltaX(){return this._deltaX}getDeltaY(){return this._deltaY}getStartX(){return this._startX}getStartY(){return this._startY}getScale(){return this._scale}getX(){return this._lastX}getY(){return this._lastY}getX1(){return this._lastX1}getY1(){return this._lastY1}getX2(){return this._lastX2}getY2(){return this._lastY2}isSingleTouch(){return this._touchSingle}isFlickAvailable(){return this._flipAvailable}disableFlick(){this._flipAvailable=!1}touchesBegan(t,e){this._lastX=t,this._lastY=e,this._startX=t,this._startY=e,this._lastTouchDistance=-1,this._flipAvailable=!0,this._touchSingle=!0}touchesMoved(t,e){this._lastX=t,this._lastY=e,this._lastTouchDistance=-1,this._touchSingle=!0}getFlickDistance(){return this.calculateDistance(this._startX,this._startY,this._lastX,this._lastY)}calculateDistance(t,e,i,s){return Math.sqrt((t-i)*(t-i)+(e-s)*(e-s))}calculateMovingAmount(t,e){if(t>0!=e>0)return 0;const i=t>0?1:-1,s=Math.abs(t),a=Math.abs(e);return i*(s<a?s:a)}}class gl{constructor(){n(this,"_touchManager");n(this,"_deviceToScreen");n(this,"_viewMatrix");n(this,"_programId");n(this,"_changeModel");n(this,"_isClick");this._programId=null,this._touchManager=new cl,this._deviceToScreen=new et,this._viewMatrix=new Zs}initialize(){const{width:t,height:e}=Q,i=t/e,s=-i,a=i,o=un,l=hn;if(this._viewMatrix.setScreenRect(s,a,o,l),this._viewMatrix.scale(hr,hr),this._deviceToScreen.loadIdentity(),t>e){const c=Math.abs(a-s);this._deviceToScreen.scaleRelative(c/t,-c/t)}else{const c=Math.abs(l-o);this._deviceToScreen.scaleRelative(c/e,-c/e)}this._deviceToScreen.translateRelative(-t*.5,-e*.5),this._viewMatrix.setMaxScale(on),this._viewMatrix.setMinScale(ln),this._viewMatrix.setMaxScreenRect(cn,gn,dn,_n)}release(){this._viewMatrix=null,this._touchManager=null,this._deviceToScreen=null,E.deleteProgram(this._programId),this._programId=null}render(){E.useProgram(this._programId),E.flush();const t=Ht.getInstance();t.setViewMatrix(this._viewMatrix),t.onUpdate()}initializeSprite(){Q.width,Q.height,q.getInstance().getTextureManager(),this._programId==null&&(this._programId=q.getInstance().createShader())}onTouchesBegan(t,e){this._touchManager.touchesBegan(t,e)}onTouchesMoved(t,e){const i=this.transformViewX(this._touchManager.getX()),s=this.transformViewY(this._touchManager.getY());this._touchManager.touchesMoved(t,e),Ht.getInstance().onDrag(i,s)}onTouchesEnded(t,e){const i=Ht.getInstance();i.onDrag(0,0);{const s=this._deviceToScreen.transformX(this._touchManager.getX()),a=this._deviceToScreen.transformY(this._touchManager.getY());i.onTap(s,a)}}transformViewX(t){const e=this._deviceToScreen.transformX(t);return this._viewMatrix.invertTransformX(e)}transformViewY(t){const e=this._deviceToScreen.transformY(t);return this._viewMatrix.invertTransformY(e)}transformScreenX(t){return this._deviceToScreen.transformX(t)}transformScreenY(t){return this._deviceToScreen.transformY(t)}}let Q=null,Xt=null,E=null,bi=null;class q{constructor(){n(this,"_cubismOption");n(this,"_view");n(this,"_captured");n(this,"_mouseX");n(this,"_mouseY");n(this,"_isEnd");n(this,"_textureManager");n(this,"_isInited");this._captured=!1,this._mouseX=0,this._mouseY=0,this._isEnd=!1,this._isInited=!0,this._cubismOption=new an,this._view=new gl,this._textureManager=new ul}static getInstance(){return Xt==null&&(Xt=new q),Xt}static releaseInstance(){Xt!=null&&Xt.release(),Xt=null}initialize(){return Q=document.getElementById("live2d"),je==="full"&&this._resizeCanvas(),E=Q.getContext("webgl")||Q.getContext("experimental-webgl"),E?(bi||(bi=E.getParameter(E.FRAMEBUFFER_BINDING)),E.enable(E.BLEND),E.blendFunc(E.SRC_ALPHA,E.ONE_MINUS_SRC_ALPHA),"ontouchend"in Q?(Q.ontouchstart=ml,Q.ontouchmove=pl,Q.ontouchend=yl,Q.ontouchcancel=Sl):(Q.onmousedown=dl,window.onmousemove=_l,Q.onmouseup=fl),this._view.initialize(),this.initializeCubism(),this._isInited=!0,!0):(E=null,H.printMessage("This browser does not support the <code>&lt;canvas&gt;</code> element."),!1)}onResize(){this._resizeCanvas(),this._view.initialize();const t=[0,0,Q.width,Q.height];E.viewport(t[0],t[1],t[2],t[3])}release(){this._textureManager.release(),this._textureManager=null,this._view.release(),this._view=null,Ht.releaseInstance(),j.dispose()}run(){const t=()=>{Xt!=null&&(H.updateTime(),E.clearColor(0,0,0,1),E.enable(E.DEPTH_TEST),E.depthFunc(E.LEQUAL),E.clearDepth(1),E.enable(E.BLEND),E.blendFunc(E.SRC_ALPHA,E.ONE_MINUS_SRC_ALPHA),this._view.render(),requestAnimationFrame(t))};t()}createShader(){const t=E.createShader(E.VERTEX_SHADER);if(t==null)return H.printMessage("failed to create vertexShader"),null;const e="precision mediump float;attribute vec3 position;attribute vec2 uv;varying vec2 vuv;void main(void){   gl_Position = vec4(position, 1.0);   vuv = uv;}";E.shaderSource(t,e),E.compileShader(t);const i=E.createShader(E.FRAGMENT_SHADER);if(i==null)return H.printMessage("failed to create fragmentShader"),null;const s="precision mediump float;varying vec2 vuv;uniform sampler2D texture;void main(void){   gl_FragColor = texture2D(texture, vuv);}";E.shaderSource(i,s),E.compileShader(i);const a=E.createProgram();return E.attachShader(a,t),E.attachShader(a,i),E.deleteShader(t),E.deleteShader(i),E.linkProgram(a),E.useProgram(a),a}getView(){return this._view}getTextureManager(){return this._textureManager}initializeCubism(){this._cubismOption.logFunction=H.printMessage,this._cubismOption.loggingLevel=Sn,j.startUp(this._cubismOption),j.initialize(),Ht.getInstance(),H.updateTime()}_resizeCanvas(){Q.width=window.innerWidth,Q.height=window.innerHeight}isInited(){return this._isInited}}function dl(r){if(!q.getInstance()._view){H.printMessage("view notfound");return}q.getInstance()._captured=!0;const t=r.pageX,e=r.pageY;q.getInstance()._view.onTouchesBegan(t,e)}function _l(r){if(!q.getInstance()._view){H.printMessage("view notfound");return}r.target.getBoundingClientRect();let t=r.clientX,e=r.clientY-window.innerHeight+Q.height;t=t>Q.width?Q.width:t,e=e<0?0:e,q.getInstance()._view.onTouchesMoved(t,e)}function fl(r){if(q.getInstance()._captured=!1,!q.getInstance()._view){H.printMessage("view notfound");return}const t=r.target.getBoundingClientRect(),e=r.clientX-t.left,i=r.clientY-t.top;q.getInstance()._view.onTouchesEnded(e,i)}function ml(r){if(!q.getInstance()._view){H.printMessage("view notfound");return}q.getInstance()._captured=!0;const t=r.changedTouches[0].pageX,e=r.changedTouches[0].pageY;q.getInstance()._view.onTouchesBegan(t,e)}function pl(r){if(!q.getInstance()._captured)return;if(!q.getInstance()._view){H.printMessage("view notfound");return}const t=r.target.getBoundingClientRect(),e=r.changedTouches[0].clientX-t.left,i=r.changedTouches[0].clientY-t.top;q.getInstance()._view.onTouchesMoved(e,i)}function yl(r){if(q.getInstance()._captured=!1,!q.getInstance()._view){H.printMessage("view notfound");return}const t=r.target.getBoundingClientRect(),e=r.changedTouches[0].clientX-t.left,i=r.changedTouches[0].clientY-t.top;q.getInstance()._view.onTouchesEnded(e,i)}function Sl(r){if(q.getInstance()._captured=!1,!q.getInstance()._view){H.printMessage("view notfound");return}const t=r.target.getBoundingClientRect(),e=r.changedTouches[0].clientX-t.left,i=r.changedTouches[0].clientY-t.top;q.getInstance()._view.onTouchesEnded(e,i)}function xl(r){nn(r),vl(r),Cl(r.corejs).then(()=>{Ml()}).catch(t=>{console.log(t)})}function Cl(r){return new Promise((t,e)=>{if(typeof document>"u")return;const i=document.body||document.getElementsByTagName("body")[0],s=document.createElement("script");s.onload=()=>t("success"),s.src=r,i.appendChild(s)})}function vl(r){const t=document.createElement("div");t.id="waifu";const e=document.createElement("canvas");e.id="live2d",t.appendChild(e);let i;if(r.size!=="full"){const{width:o,height:l}=r.size,c=r.renderRatio;i=xs(o,l),e.width=o*c,e.height=l*c}else i=xs(window.innerWidth,window.innerHeight),e.width=window.innerWidth,e.height=window.innerHeight;if(!i||typeof document>"u")return;const s=document.head||document.getElementsByTagName("head")[0],a=document.createElement("style");s.appendChild(a),a.appendChild(document.createTextNode(i)),document.body.appendChild(t)}function Ml(){q.getInstance().initialize()!=!1&&(q.getInstance().run(),window.addEventListener("resize",()=>{je==="full"&&q.getInstance().isInited()&&q.getInstance().onResize()}),window.addEventListener("beforeunload",()=>{q.releaseInstance()}))}function xs(r,t){return`
#waifu {
	bottom: 0px;
  background:rgba(0, 0, 0, 0);
	left: 0;
	line-height: 0;
	margin-bottom: -10px;
	position: fixed;
	transform: translateY(3px);
	transition: transform .3s ease-in-out, bottom 3s ease-in-out;
	z-index: 1;
}

#waifu:hover {
	transform: translateY(0);
}

#live2d {
  width: ${r}px;
  height: ${t}px;
	position: relative;
}`}function Bl(r){const t={corejs:"https://fastly.jsdelivr.net/gh/nidhoggfgg/live2d-model@latest/live2dcubismcore.min.js",size:{width:300,height:400},renderRatio:1,useCache:!0,debug:!1};Object.assign(t,r),xl(t)}Bl({waifuPath:"https://fastly.jsdelivr.net/gh/nidhoggfgg/live2d-model@latest/",models:["Cao"],size:{width:300,height:400},renderRatio:1,useCache:!0,debug:!0});
